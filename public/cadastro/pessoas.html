<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cadastro de Pessoas | Projeto Coruja</title>
    <link rel="stylesheet" href="/css/main.css" />
  </head>
  <body class="theme-dark">
    <div class="app">
      <div class="user-menu" id="user-menu" aria-expanded="false">
        <button class="user-menu__button" type="button" id="user-menu-button" aria-haspopup="true" aria-expanded="false">
          <span class="user-menu__avatar" id="user-avatar" aria-hidden="true">U</span>
          <span id="user-button-name">Usu√°rio</span>
        </button>
        <div class="user-menu__dropdown" id="user-menu-dropdown" role="menu" aria-label="Menu do usu√°rio">
          <div class="user-menu__item"><span class="user-menu__label">Nome Completo:</span><span class="user-menu__value" id="um-nome">‚Äî</span></div>
          <div class="user-menu__item"><span class="user-menu__label">Email:</span><span class="user-menu__value" id="um-email">‚Äî</span></div>
          <div class="user-menu__item"><span class="user-menu__label">Perfil:</span><span class="user-menu__value" id="um-perfil">‚Äî</span></div>
          <div class="user-menu__separator"></div>
          <div class="user-menu__item"><span class="user-menu__label">Senha:</span><span class="user-menu__link" id="um-alterar-senha">Alterar senha</span></div>
          <div class="user-menu__separator"></div>
          <div class="user-menu__item"><span class="user-menu__link" id="um-sair">Sair</span></div>
        </div>
      </div>
      <aside class="sidebar">
        <div class="sidebar__header">
          <div class="sidebar__brand">Projeto Coruja</div>
          <!-- Bot√£o dedicado para alternar entre tema claro e escuro -->
          <button
            class="theme-toggle"
            type="button"
            data-theme-toggle
            aria-pressed="false"
            aria-label="Alternar tema visual"
          >
            <span class="theme-toggle__icon" aria-hidden="true" data-theme-icon>üåô</span>
            <span class="theme-toggle__label" data-theme-label>Modo escuro</span>
          </button>
        </div>
        <nav class="sidebar__nav" aria-label="Menu principal">
          <a class="sidebar__link" href="/home">Home</a>
          <a class="sidebar__link" href="/usuarios">Usu√°rios</a>
          <details class="sidebar__section sidebar__section--active" open>
            <summary class="sidebar__link sidebar__link--parent" aria-label="Abrir menu Cadastro">Cadastro</summary>
            <div class="sidebar__subnav">
              <a class="sidebar__link sidebar__link--child sidebar__link--active" href="/cadastro/pessoas">Pessoas</a>
              <a class="sidebar__link sidebar__link--child" href="/cadastro/empresas">Empresas</a>
            </div>
          </details>
          <!-- In√≠cio do menu de n√≠vel superior: Consulta -->
          <details class="sidebar__section">
            <summary class="sidebar__link sidebar__link--parent" aria-label="Abrir menu Consulta">Consulta</summary>
            <div class="sidebar__subnav">
              <a class="sidebar__link sidebar__link--child" href="/consulta/pessoas">Pessoas</a>
              <a class="sidebar__link sidebar__link--child" href="/consulta/empresas">Empresas</a>
            </div>
          </details>
        </nav>
        
      </aside>

      <main class="content" data-page="cadastro-pessoas">
        <header class="content__header">
          <p class="content__eyebrow">Cadastro</p>          
        </header>

        <section class="panel" aria-label="Formul√°rio de dados de pessoas">
          <div class="panel__header panel__header--stacked">
          </div>

          <div id="pessoa-form-message" class="message" role="status" aria-live="polite"></div>

          <!-- A√ß√£o direta garante envio mesmo sem o manipulador JS -->
          <form class="form" id="pessoa-form" action="/api/pessoas" method="post" enctype="multipart/form-data">
            <!-- Se√ß√£o 1: Identifica√ß√£o -->
            <div class="form__section">
              <div class="form__section-header">
                <h3 class="form__section-title" style="text-align: center; width: 100%;">Identifica√ß√£o</h3>
              </div>
              <div class="form__subsection" style="margin-bottom: 1rem;">
                <div class="form__field">
                  <span class="form__label">Fotos do cadastro</span>
                  <input
                    class="form__input"
                    type="file"
                    id="pessoa-fotos"
                    name="fotos"
                    accept="image/*"
                    multiple
                  />
                  <small>Adicione uma ou mais imagens para a ficha da pessoa.</small>
                </div>
                <div id="lista-fotos" style="display: grid; gap: 0.75rem; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));"></div>
              </div>
              <div class="form__grid form__grid--1">
                <label class="form__field">
                  <span class="form__label">Nome Completo</span>
                  <input class="form__input" type="text" name="nomeCompleto" required />
                </label>
                <label class="form__field">
                  <span class="form__label">Apelido/Vulgo</span>
                  <input class="form__input" type="text" name="apelido" />
                </label>
                <label class="form__field">
                  <span class="form__label">CPF</span>
                  <input class="form__input" type="text" name="cpf" inputmode="numeric" />
                  <span id="erro-cpf" class="form__error" style="display: none;">CPF inv√°lido!</span>
                </label>
                <label class="form__field">
                  <span class="form__label">RG</span>
                  <input class="form__input" type="text" name="rg" inputmode="numeric" />
                </label>
                <label class="form__field">
                  <span class="form__label">CNH</span>
                  <input class="form__input" type="text" name="cnh" inputmode="numeric" />
                </label>
                <label class="form__field">
                  <div class="form__grid form__grid--2" style="grid-template-columns: 1fr 10rem; gap: 0.5rem;">
                    <label class="form__field" style="margin:0;">
                      <span class="form__label">Data de Nascimento</span>
                      <input class="form__input" type="date" name="dataNascimento" />
                    </label>
                    <label class="form__field" style="margin:0;">
                      <span class="form__label">Idade</span>
                      <input class="form__input" id="idade" type="number" min="0" step="1" placeholder="‚Äî" readonly />
                    </label>
                  </div>
                </label>
                <label class="form__field">
                  <span class="form__label">Nome da M√£e</span>
                  <input class="form__input" type="text" name="nomeMae" />
                </label>
                <label class="form__field">
                  <span class="form__label">Nome do Pai</span>
                  <input class="form__input" type="text" name="nomePai" />
                </label>
              </div>
            </div>

            <!-- Se√ß√£o 2: Contatos -->
            <div class="form__section">
              <div class="form__section-header">
                <h3 class="form__section-title" style="text-align: center; width: 100%;">Contatos</h3>
              </div>

              <!-- Sub-se√ß√£o: Telefone -->
              <div class="form__subsection">
                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 0.5rem;">
                  <h4 class="form__section-title" style="font-size: 1rem; margin: 0; text-align: left; width: 100%;">Telefone</h4>
                  <button class="button button--secondary" id="adicionar-telefone" type="button" aria-label="Adicionar telefone" title="Adicionar">+</button>
                </div>
                <div id="lista-telefones" style="display: flex; flex-direction: column; gap: 0.5rem;"></div>
              </div>

              <!-- Sub-se√ß√£o: Emails -->
              <div class="form__subsection">
                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%; margin: 0.75rem 0;">
                  <h4 class="form__section-title" style="font-size: 1rem; margin: 0; text-align: left; width: 100%;">Email</h4>
                  <button class="button button--secondary" id="adicionar-email" type="button" aria-label="Adicionar email" title="Adicionar">+</button>
                </div>
                <div id="lista-emails" style="display: flex; flex-direction: column; gap: 0.5rem;"></div>
              </div>

              <!-- Sub-se√ß√£o: Redes Sociais (linha abaixo) -->
              <div class="form__subsection">
                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%; margin: 0.75rem 0;">
                  <h4 class="form__section-title" style="font-size: 1rem; margin: 0; text-align: left; width: 100%;">Redes Sociais</h4>
                  <button class="button button--secondary" id="adicionar-rede" type="button" aria-label="Adicionar rede social" title="Adicionar">+</button>
                </div>
                <div id="lista-redes" style="display: flex; flex-direction: column; gap: 0.5rem;"></div>
              </div>
            </div>

            <!-- Se√ß√£o 3: Endere√ßos -->
            <div class="form__section">
              <div class="form__section-header">
                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                  <h3 class="form__section-title" style="text-align: center; width: 100%;">Endere√ßos</h3>
                  <button class="button button--secondary" id="adicionar-endereco" type="button" aria-label="Adicionar endere√ßo" title="Adicionar">+</button>
                </div>
              </div>
              <div id="lista-enderecos" class="enderecos-lista"></div>
            </div>

            

            <!-- Se√ß√£o 5: V√≠nculos -->
            <div class="form__section">
              <div class="form__section-header">
                <h3 class="form__section-title" style="text-align: center; width: 100%;">V√≠nculos</h3>
              </div>

              <!-- Sub-se√ß√£o: Pessoas -->
              <div class="form__subsection">
                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%; margin: 0.75rem 0;">
                  <h4 class="form__section-title" style="font-size: 1rem; margin: 0;">Pessoas</h4>
                </div>
                <div class="form__grid form__grid--3" style="align-items:end;">
                  <label class="form__field" style="margin:0;">
                    <span class="form__label">Nome ou CPF</span>
                    <input class="form__input" type="text" id="vinculo-pessoa-busca" placeholder="Digite nome completo ou CPF" />
                  </label>
                  <div class="form__actions" style="margin:0;">
                    <button class="button button--secondary" id="buscar-vinculo-pessoa" type="button" aria-label="Buscar pessoa para v√≠nculo" title="Procurar" style="min-width:8rem;">Procurar</button>
                  </div>
                  <small style="color: var(--muted); visibility: hidden;">&nbsp;</small>

                </div>
                <!-- Bloco de resultados da busca para v√≠nculos de pessoas -->
                <div id="pessoas-busca-resultado" class="panel" style="margin-top: 0.75rem; padding: 0.75rem; display: none;"></div>
                <div id="lista-vinculos-pessoas" style="display: flex; flex-direction: column; gap: 0.5rem;"></div>
              </div>

              <!-- Sub-se√ß√£o: Empresa vinculada (sele√ß√£o √∫nica de empresas j√° cadastradas) -->
                <div class="form__subsection" aria-label="Empresas vinculadas">
                  <div style="display:flex; justify-content:space-between; align-items:center; width:100%; margin:0.75rem 0;">
                    <h4 class="form__section-title" style="font-size:1rem; margin:0;">Empresa</h4>
                  </div>
                  <div class="form__grid form__grid--3" style="align-items:end;">
                    <label class="form__field">
                      <span class="form__label">CNPJ da empresa</span>
                      <input class="form__input" type="text" id="empresa-cnpj-input" placeholder="Digite o CNPJ" />
                    </label>
                    <div class="form__actions" style="margin:0;">
                      <button class="button button--secondary" type="button" id="empresa-buscar-cnpj" title="Procurar" aria-label="Buscar empresa por CNPJ" style="min-width:8rem;">Procurar</button>
                    </div>
                    <small id="empresa-vinculada-status" style="color: var(--muted);"></small>
                  </div>
                  <div id="empresa-busca-resultado" style="margin-top:0.75rem;"></div>
                  <div id="empresas-vinculadas-lista" style="margin-top:0.75rem;"></div>
                </div>

              <!-- Sub-se√ß√£o Empresa removida desta tela -->
              <!--
              <div class="form__subsection" hidden>
                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%; margin: 0.75rem 0;">
                  <h4 class="form__section-title" style="font-size: 1rem; margin: 0;">Empresa</h4>
                  <button class="button button--secondary" id="adicionar-vinculo-empresa" type="button" aria-label="Adicionar v√≠nculo de empresa" title="Adicionar">+</button>
                </div>
                <div id="lista-vinculos-empresas" style="display: flex; flex-direction: column; gap: 0.5rem;"></div>
              </div>
              -->
              <div class="form__subsection">
                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%; margin: 0.75rem 0;">
                  
                </div>
                
              </div>
              <div class="form__subsection">
                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%; margin: 0.75rem 0;">
                  <h4 class="form__section-title" style="font-size: 1rem; margin: 0;">Entidades</h4>
                  <button class="button button--secondary" id="adicionar-vinculo-entidade" type="button" aria-label="Adicionar v√≠nculo de entidade" title="Adicionar">+</button>
                </div>
                <div id="lista-vinculos-entidades" style="display: flex; flex-direction: column; gap: 0.5rem;"></div>
              </div>
              <div class="form__subsection">
                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%; margin: 0.75rem 0;">
                  <h4 class="form__section-title" style="font-size: 1rem; margin: 0;">Empregat√≠cio</h4>
                  <button class="button button--secondary" id="adicionar-vinculo-empregaticio" type="button" aria-label="Adicionar v√≠nculo empregat√≠cio" title="Adicionar">+</button>
                </div>
                <div id="lista-vinculos-empregaticio" style="display: flex; flex-direction: column; gap: 0.5rem;"></div>
              </div>
            </div>

            <!-- Se√ß√£o 6: Ocorr√™ncias -->
            <div class="form__section">
              <div class="form__section-header">
                <h3 class="form__section-title" style="text-align: center; width: 100%;">Ocorr√™ncias</h3>
              </div>

              <!-- Sub-se√ß√£o: Ocorr√™ncias Policiais -->
              <div class="form__subsection">
                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%; margin: 0.75rem 0;">
                  <h4 class="form__section-title" style="font-size: 1rem; margin: 0;">Ocorr√™ncias Policiais</h4>
                  <button class="button button--secondary" id="adicionar-ocorrencia-policial" type="button" aria-label="Adicionar ocorr√™ncia policial" title="Adicionar">+</button>
                </div>
                <div id="lista-ocorrencias-policiais" style="display:flex; flex-direction:column; gap:0.5rem;"></div>
              </div>

              <!-- Sub-se√ß√£o: Processos -->
              <div class="form__subsection">
                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%; margin: 0.75rem 0;">
                  <h4 class="form__section-title" style="font-size: 1rem; margin: 0;">Processos</h4>
                  <button class="button button--secondary" id="adicionar-processo" type="button" aria-label="Adicionar processo" title="Adicionar">+</button>
                </div>
                <div id="lista-processos" style="display:flex; flex-direction:column; gap:0.5rem;"></div>
              </div>

              <!-- Sub-se√ß√£o: Abordagens -->
              <div class="form__subsection">
                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%; margin: 0.75rem 0;">
                  <h4 class="form__section-title" style="font-size: 1rem; margin: 0;">Abordagens</h4>
                  <button class="button button--secondary" id="adicionar-abordagem" type="button" aria-label="Adicionar abordagem" title="Adicionar">+</button>
                </div>
                <div id="lista-abordagens" style="display:flex; flex-direction:column; gap:0.5rem;"></div>
              </div>

              <!-- Sub-se√ß√£o: Pris√µes -->
              <div class="form__subsection">
                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%; margin: 0.75rem 0;">
                  <h4 class="form__section-title" style="font-size: 1rem; margin: 0;">Pris√µes</h4>
                  <button class="button button--secondary" id="adicionar-prisao" type="button" aria-label="Adicionar pris√£o" title="Adicionar">+</button>
                </div>
                <div id="lista-prisoes" style="display:flex; flex-direction:column; gap:0.5rem;"></div>
              </div>
            </div>

            <div class="form__actions">
              <button class="button button--secondary" type="reset">Limpar</button>
              <button class="button button--ghost" id="listar-pessoas" type="button">Listar</button>
              <button class="button button--primary" id="submit-pessoa" type="submit">Incluir</button>
            </div>
          </form>
        </section>

        <section class="panel" aria-label="Lista de pessoas cadastradas" id="pessoas-panel" hidden>
          <div class="panel__header panel__header--stacked">
            <div>
              <h2 class="panel__title">Lista de pessoas cadastradas</h2>
            </div>
          </div>

          <div id="pessoas-message" class="message" role="status" aria-live="polite"></div>

          <ul id="pessoas-lista" class="list" aria-live="polite"></ul>
        </section>
      </main>
    </div>

    <script src="/js/main.js"></script>
    <div id="alterar-senha-modal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="alterar-senha-title">
      <div class="modal__overlay" data-modal-close></div>
      <div class="modal__panel modal__panel--sm" role="document">
        <button class="modal__close" id="alterar-senha-close" aria-label="Fechar">√ó</button>
        <h3 id="alterar-senha-title">Alterar senha</h3>
        <form id="alterar-senha-form" class="form" novalidate>
          <label class="form__field">
            <span class="form__label">Senha atual</span>
            <input class="form__input" type="password" id="senha-atual" required />
          </label>
          <label class="form__field">
            <span class="form__label">Nova senha</span>
            <input class="form__input" type="password" id="senha-nova" required />
          </label>
          <div class="form__actions">
            <button type="button" class="button button--ghost" id="alterar-senha-cancelar">Cancelar</button>
            <button type="submit" class="button button--primary" id="alterar-senha-submit">Alterar</button>
          </div>
        </form>
      </div>
    </div>
    <script>
      const API_PESSOAS_URL = '/api/pessoas';
      const pessoaForm = document.getElementById('pessoa-form');
      const submitButton = document.getElementById('submit-pessoa');
      const listarButton = document.getElementById('listar-pessoas');
      const listaPessoasEl = document.getElementById('pessoas-lista');
      const messageEl = document.getElementById('pessoas-message');
      const formMessageEl = document.getElementById('pessoa-form-message');
      const cpfInput = pessoaForm?.elements['cpf'];
      const fotosInput = document.getElementById('pessoa-fotos');
      const vinculoPessoaBuscaInput = document.getElementById('vinculo-pessoa-busca');
      const buscarVinculoPessoaBtn = document.getElementById('buscar-vinculo-pessoa');
      let pessoaEmEdicao = null;
      let ultimaAcaoFoiEdicao = false;
      let fotosSelecionadas = [];
      let fotosParaRemover = []; // Armazena refer√™ncias de fotos existentes removidas
      let preservarFotosNoReset = false; // Evita limpar a galeria quando fotos vierem do backend

      const getCookie = (name) => {
        return document.cookie
          .split(';')
          .map((c) => c.trim())
          .find((c) => c.startsWith(`${name}=`))
          ?.split('=')[1];
      };

      const obterToken = () => localStorage.getItem('authToken') || getCookie('authToken');

      const fetchAutenticado = (url, options = {}) => {
        const token = obterToken();
        const isFormData = options?.body instanceof FormData;
        const headers = new Headers(options.headers || {});

        // Garante Authorization e deixa o navegador definir Content-Type para FormData
        if (token) headers.set('Authorization', `Bearer ${token}`);
        if (!isFormData && !headers.has('Content-Type')) {
          headers.set('Content-Type', 'application/json');
        }

        // Inclui cookies (credentials) por padr√£o para enviar o token armazenado
        return fetch(url, {
          ...options,
          credentials: options.credentials ?? 'include',
          headers,
        });
      };

      const exibirMensagem = (texto, tipo = 'info') => {
        if (!messageEl) return;
        messageEl.textContent = texto || '';
        messageEl.className = 'message';
        if (texto) messageEl.classList.add(`message--${tipo}`);
      };

      const exibirMensagemForm = (texto, tipo = 'info') => {
        if (!formMessageEl) return;
        formMessageEl.textContent = texto || '';
        formMessageEl.className = 'message';
        if (texto) formMessageEl.classList.add(`message--${tipo}`);
      };

      // Recupera o ID da pessoa a partir da URL (?pessoaId= ou ?id=)
      const obterPessoaIdDaUrl = () => {
        const params = new URLSearchParams(window.location.search);
        return params.get('pessoaId') || params.get('id');
      };

      const obterDadosFormulario = () => {
        const formData = new FormData(pessoaForm);
        const dados = Object.fromEntries(formData.entries());
        // Preenche idade calculada (frontend) se dispon√≠vel
        const idadeEl = document.getElementById('idade');
        if (idadeEl && idadeEl.value) {
          dados.idade = parseInt(idadeEl.value, 10);
        }
        
        // Adiciona os endere√ßos m√∫ltiplos ao payload
        dados.enderecos = enderecos;
        dados.endereco_atual_index = indicadorEnderecoAtual;
        
        // Adiciona os telefones m√∫ltiplos ao payload
        dados.telefones = telefones.filter(tel => tel.trim() !== '');
        // Adiciona emails e redes sociais m√∫ltiplos ao payload
        dados.emails = emails.filter(e => e.trim() !== '');
        dados.redesSociais = redes.filter(r => r.trim() !== '');

        // Empresa removida desta tela; nenhuma coleta necess√°ria aqui

        // Montar v√≠nculos
        const pessoasVinc = (vinculosPessoas || []).map(v => ({
          nome: String(v.nome||'').trim(),
          cpf: String(v.cpf||'').trim(),
          tipo: String(v.tipo||'').trim(),
        })).filter(v => v.nome || v.cpf || v.tipo);
        const empresasVinc = (empresasVinculadas || [])
          .map((entrada) => {
            const { id, nome, observacoes } = normalizarVinculoEmpresa(entrada);
            const idLimpo = id !== undefined && id !== null && String(id).trim() !== '' ? id : undefined;
            const nomeLimpo = String(nome || '').trim();
            const obsLimpa = String(observacoes || '').trim();
            return (idLimpo !== undefined || nomeLimpo || obsLimpa)
              ? { id: idLimpo, nome: nomeLimpo, observacoes: obsLimpa }
              : null;
          })
          .filter(Boolean);
        const entidadesVinc = (vinculosEntidades || [])
          .map(e => {
            const nome = String(e?.nome || '').trim();
            const observacoes = String(e?.observacoes || '').trim();
            return (nome || observacoes) ? { nome, observacoes } : null;
          })
          .filter(Boolean);
        const empregList = (vinculosEmpregaticio || [])
          .map(e => {
            const info = String(e?.info || '').trim();
            return info ? { info } : null;
          })
          .filter(Boolean);

        // Coment√°rio: enviamos sempre as listas (inclusive vazias) para indicar remo√ß√£o expl√≠cita ao backend
        dados.vinculos = {
          pessoas: pessoasVinc,
          empresas: empresasVinc,
          entidades: entidadesVinc,
          empregaticio: empregList,
        };

        // Montar ocorr√™ncias
        const ocorrenciasObj = {};
        const occPol = (ocorrenciasPoliciais || []).map(o => {
          const data = String(o?.data || '').trim();
          const info = String(o?.info || '').trim();
          return (data || info) ? { data, info } : null;
        }).filter(Boolean);
        const procList = (processos || []).map(p => {
          const data = String(p?.data || '').trim();
          const info = String(p?.info || '').trim();
          return (data || info) ? { data, info } : null;
        }).filter(Boolean);
        const abordList = (abordagens || []).map(a => {
          const data = String(a?.data || '').trim();
          const info = String(a?.info || '').trim();
          return (data || info) ? { data, info } : null;
        }).filter(Boolean);
        const prisList = (prisoes || []).map(p => {
          const data = String(p?.data || '').trim();
          const info = String(p?.info || '').trim();
          return (data || info) ? { data, info } : null;
        }).filter(Boolean);
        if (occPol.length) ocorrenciasObj.policiais = occPol;
        if (procList.length) ocorrenciasObj.processos = procList;
        if (abordList.length) ocorrenciasObj.abordagens = abordList;
        if (prisList.length) ocorrenciasObj.prisoes = prisList;
        dados.ocorrencias = Object.keys(ocorrenciasObj).length ? ocorrenciasObj : undefined;

        dados.fotosExistentes = fotosSelecionadas
          .filter((foto) => foto.existing)
          .map((foto) => ({ referencia: foto.referencia, nome: foto.nome }));

        // Envia ao backend quais fotos existentes devem ser removidas
        dados.fotosParaRemover = Array.from(new Set(fotosParaRemover));

        return dados;
      };

      // Monta um FormData com os arquivos e demais campos serializados
      const montarFormDataEnvio = (dados) => {
        const formDataEnvio = new FormData();

        // Serializa todos os campos para o FormData (listas v√£o em JSON)
        Object.entries(dados || {}).forEach(([chave, valor]) => {
          if (valor === undefined || valor === null || chave === 'fotosExistentes') return;
          const precisaJson = typeof valor === 'object';
          formDataEnvio.append(chave, precisaJson ? JSON.stringify(valor) : valor);
        });

        fotosSelecionadas.forEach((foto, index) => {
          if (foto.file) {
            // Inclui arquivos novos na chave esperada pelo backend
            formDataEnvio.append('fotos', foto.file, foto.nome || foto.file.name || `foto-${index + 1}.jpg`);
          } else if (foto.existing && foto.referencia) {
            // Mant√©m refer√™ncia de imagem j√° existente
            formDataEnvio.append('fotosExistentes[]', foto.referencia);
          }
        });

        // Inclui refer√™ncia das fotos existentes tamb√©m como JSON para consist√™ncia
        if (Array.isArray(dados?.fotosExistentes)) {
          formDataEnvio.append('fotosExistentes', JSON.stringify(dados.fotosExistentes));
        }

        return formDataEnvio;
      };
      // Empresa vinculada (sele√ß√£o √∫nica)
      const API_EMPRESAS_URL = '/api/empresas';
      let empresasOpcoes = [];
      let empresasVinculadas = []; // array de objetos { id, nome?, observacoes? }

      const normalizarVinculoEmpresa = (entrada) => {
        // Normaliza diferentes formatos para um objeto consistente
        if (entrada && typeof entrada === 'object') {
          const idLimpo = entrada.id ?? entrada.empresaId ?? null;
          return {
            id: idLimpo !== undefined && idLimpo !== null && String(idLimpo).trim() !== '' ? idLimpo : undefined,
            nome: entrada.nome || entrada.razaoSocial || entrada.nomeFantasia || '',
            observacoes: entrada.observacoes || '',
          };
        }
        return { id: entrada, nome: '', observacoes: '' };
      };

      const validarCnpjBasico = (valor) => {
        // Valida√ß√£o simples: garante exatamente 14 d√≠gitos num√©ricos
        const numeros = String(valor || '').replace(/\D/g, '');
        return numeros.length === 14;
      };

      const buscarEmpresaPorCnpj = (cnpj) => {
        // Busca local na lista j√° carregada de empresas usando CNPJ sem m√°scara
        const numero = String(cnpj || '').replace(/\D/g, '');
        if (!numero) return null;
        return empresasOpcoes.find((emp) => String(emp?.cnpj || '').replace(/\D/g, '') === numero) || null;
      };

      const renderizarResultadoBuscaEmpresa = (empresa) => {
        const cont = document.getElementById('empresa-busca-resultado');
        if (!cont) return;

        cont.innerHTML = '';
        if (!empresa) {
          // Feedback com convite para cadastro quando nenhum registro √© localizado
          const bloco = document.createElement('div');
          bloco.className = 'list__item';
          bloco.style.display = 'flex';
          bloco.style.justifyContent = 'space-between';
          bloco.style.alignItems = 'center';

          const texto = document.createElement('div');
          texto.innerHTML = '<strong>Empresa n√£o encontrada.</strong><br />Deseja cadastrar a empresa?';

          // Bot√£o direcionando para a tela de cadastro de empresas
          const acaoCadastrar = document.createElement('a');
          acaoCadastrar.className = 'button button--primary';
          acaoCadastrar.href = '/cadastro/empresas';
          acaoCadastrar.textContent = 'Cadastrar empresa';

          bloco.appendChild(texto);
          bloco.appendChild(acaoCadastrar);
          cont.appendChild(bloco);
          return;
        }

        const table = document.createElement('table');
        table.style.width = '100%';
        table.style.borderCollapse = 'collapse';
        table.style.marginTop = '0.5rem';
        table.innerHTML = `
          <thead>
            <tr style="background: var(--surface-muted);">
              <th style="text-align:left; padding:0.5rem;">CNPJ</th>
              <th style="text-align:left; padding:0.5rem;">Raz√£o Social</th>
              <th style="text-align:left; padding:0.5rem;">Nome Fantasia</th>
              <th style="text-align:left; padding:0.5rem;">Situa√ß√£o Cadastral</th>
              <th style="text-align:center; padding:0.5rem;">Vincular</th>
            </tr>
          </thead>
          <tbody></tbody>
        `;

        const tbody = table.querySelector('tbody');
        const tr = document.createElement('tr');
        tr.style.borderBottom = '1px solid var(--border)';

        const tdCnpj = document.createElement('td'); tdCnpj.style.padding = '0.5rem'; tdCnpj.textContent = aplicarMascaraCnpj(empresa.cnpj);
        const tdRazao = document.createElement('td'); tdRazao.style.padding = '0.5rem'; tdRazao.textContent = empresa.razaoSocial || '‚Äî';
        const tdFantasia = document.createElement('td'); tdFantasia.style.padding = '0.5rem'; tdFantasia.textContent = empresa.nomeFantasia || '‚Äî';
        const tdSituacao = document.createElement('td'); tdSituacao.style.padding = '0.5rem'; tdSituacao.textContent = empresa.situacaoCadastral || '‚Äî';

        const tdConfirm = document.createElement('td');
        tdConfirm.style.padding = '0.5rem';
        tdConfirm.style.textAlign = 'center';
        const msg = document.createElement('div');
        msg.textContent = 'Deseja vincular a empresa?';
        msg.style.marginBottom = '0.5rem';
        const grupo = document.createElement('div');
        grupo.style.display = 'inline-flex';
        grupo.style.gap = '0.5rem';
        const btnSim = document.createElement('button');
        btnSim.type = 'button';
        btnSim.className = 'button button--primary';
        btnSim.textContent = 'Sim';
        const btnNao = document.createElement('button');
        btnNao.type = 'button';
        btnNao.className = 'button button--ghost';
        btnNao.textContent = 'N√£o';
        btnSim.addEventListener('click', () => {
          const jaVinculada = empresasVinculadas.some((item) => {
            const normalizado = normalizarVinculoEmpresa(item);
            return normalizado.id !== undefined && String(normalizado.id) === String(empresa.id);
          });
          if (!jaVinculada) {
            empresasVinculadas.push({
              id: empresa.id,
              nome: empresa.razaoSocial || empresa.nomeFantasia || '',
              observacoes: empresa.observacoes || '',
            });
            renderizarEmpresasVinculadasLista();
          }
          // Limpa confirma√ß√£o ap√≥s a√ß√£o
          cont.innerHTML = '';
        });
        btnNao.addEventListener('click', () => {
          cont.innerHTML = '';
        });
        grupo.appendChild(btnSim);
        grupo.appendChild(btnNao);
        tdConfirm.appendChild(msg);
        tdConfirm.appendChild(grupo);

        tr.appendChild(tdCnpj);
        tr.appendChild(tdRazao);
        tr.appendChild(tdFantasia);
        tr.appendChild(tdSituacao);
        tr.appendChild(tdConfirm);
        tbody.appendChild(tr);
        cont.appendChild(table);
      };

      const carregarEmpresasOpcoes = async () => {
        // Preenche o cache local de empresas para buscas e v√≠nculos
        const statusEl = document.getElementById('empresa-vinculada-status');
        try {
          if (statusEl) statusEl.textContent = 'Carregando empresas...';
          const resp = await fetchAutenticado(API_EMPRESAS_URL);
          if (!resp.ok) throw new Error('Falha ao buscar empresas cadastradas.');
          const lista = await resp.json();
          empresasOpcoes = Array.isArray(lista) ? lista : [];
          renderizarEmpresasVinculadasLista();
          if (statusEl) statusEl.textContent = empresasOpcoes.length ? '' : 'Nenhuma empresa cadastrada.';
        } catch (error) {
          console.error('Erro ao carregar empresas:', error);
          if (statusEl) statusEl.textContent = 'N√£o foi poss√≠vel carregar as empresas.';
        }
      };

      const renderizarEmpresasVinculadasLista = () => {
        const cont = document.getElementById('empresas-vinculadas-lista');
        if (!cont) return;
        cont.innerHTML = '';
        if (!empresasVinculadas.length) {
          cont.innerHTML = '';
          return;
        }
        const table = document.createElement('table');
        table.style.width = '100%';
        table.style.borderCollapse = 'collapse';
        table.style.marginTop = '0.5rem';
        table.innerHTML = `
          <thead>
            <tr style="background: var(--surface-muted);">
              <th style="text-align:left; padding:0.5rem;">CNPJ</th>
              <th style="text-align:left; padding:0.5rem;">Raz√£o Social</th>
              <th style="text-align:left; padding:0.5rem;">Nome Fantasia</th>
              <th style="text-align:left; padding:0.5rem;">Situa√ß√£o Cadastral</th>
              <th style="text-align:center; padding:0.5rem;">A√ß√µes</th>
            </tr>
          </thead>
          <tbody></tbody>
        `;
        const tbody = table.querySelector('tbody');
        empresasVinculadas.forEach((item, index) => {
          const normalizado = normalizarVinculoEmpresa(item);
          const emp = normalizado.id ? empresasOpcoes.find((e) => String(e.id) === String(normalizado.id)) : null;
          if (!emp && !normalizado.nome && !normalizado.observacoes) return;
          const tr = document.createElement('tr');
          tr.style.borderBottom = '1px solid var(--border)';
          const tdCnpj = document.createElement('td'); tdCnpj.style.padding = '0.5rem'; tdCnpj.textContent = emp ? aplicarMascaraCnpj(emp.cnpj) : '‚Äî';
          const tdRazao = document.createElement('td'); tdRazao.style.padding = '0.5rem'; tdRazao.textContent = emp?.razaoSocial || normalizado.nome || '';
          const tdFantasia = document.createElement('td'); tdFantasia.style.padding = '0.5rem'; tdFantasia.textContent = emp?.nomeFantasia || '';
          const tdSituacao = document.createElement('td'); tdSituacao.style.padding = '0.5rem'; tdSituacao.textContent = emp?.situacaoCadastral || normalizado.observacoes || '';
          const tdAcoes = document.createElement('td'); tdAcoes.style.padding = '0.5rem'; tdAcoes.style.textAlign = 'center';
          const btnRemover = document.createElement('button');
          btnRemover.type = 'button';
          btnRemover.className = 'button button--danger';
          btnRemover.textContent = 'Remover';
          btnRemover.addEventListener('click', () => {
            empresasVinculadas = empresasVinculadas.filter((_, idx) => idx !== index);
            renderizarEmpresasVinculadasLista();
          });
          tdAcoes.appendChild(btnRemover);
          tr.appendChild(tdCnpj);
          tr.appendChild(tdRazao);
          tr.appendChild(tdFantasia);
          tr.appendChild(tdSituacao);
          tr.appendChild(tdAcoes);
          tbody.appendChild(tr);
        });
        cont.appendChild(table);
      };

      const aplicarMascaraCpf = (event) => {
        // Garante que apenas n√∫meros sejam digitados e aplica a m√°scara padr√£o de CPF
        const somenteNumeros = event.target.value.replace(/\D/g, '').slice(0, 11);

        let valorMascarado = somenteNumeros;
        if (somenteNumeros.length > 3) {
          valorMascarado = `${somenteNumeros.slice(0, 3)}.${somenteNumeros.slice(3, 6)}`;
        }
        if (somenteNumeros.length > 6) {
          valorMascarado = `${valorMascarado}.${somenteNumeros.slice(6, 9)}`;
        }
        if (somenteNumeros.length > 9) {
          valorMascarado = `${valorMascarado}-${somenteNumeros.slice(9, 11)}`;
        }

        event.target.value = valorMascarado;

        // Valida CPF em tempo real quando completo (11 d√≠gitos)
        const erroEl = document.getElementById('erro-cpf');
        if (somenteNumeros.length === 11) {
          const validacao = validarCpf(valorMascarado);
          if (!validacao.valido) {
            erroEl.style.display = 'block';
            erroEl.textContent = 'CPF inv√°lido!';
          } else {
            erroEl.style.display = 'none';
          }
        } else if (somenteNumeros.length > 0) {
          // Mostra erro se n√£o est√° completo e o usu√°rio parou de digitar
          erroEl.style.display = 'none';
        }
      };

      const normalizarCpfSomenteDigitos = (valor) => String(valor || '').replace(/\D/g, '');

      const validarCpf = (cpf) => {
        // Remove caracteres n√£o num√©ricos
        const somenteNumeros = cpf.replace(/\D/g, '');

        // Valida comprimento
        if (somenteNumeros.length !== 11) {
          return { valido: false, mensagem: 'CPF deve ter 11 d√≠gitos.' };
        }

        // Valida se todos os d√≠gitos s√£o iguais
        if (/^(\d)\1{10}$/.test(somenteNumeros)) {
          return { valido: false, mensagem: 'CPF inv√°lido: todos os d√≠gitos s√£o iguais.' };
        }

        // Calcula primeiro d√≠gito verificador
        let soma = 0;
        for (let i = 0; i < 9; i++) {
          soma += parseInt(somenteNumeros[i]) * (10 - i);
        }
        let primeiroDigito = 11 - (soma % 11);
        primeiroDigito = primeiroDigito > 9 ? 0 : primeiroDigito;

        // Valida primeiro d√≠gito verificador
        if (parseInt(somenteNumeros[9]) !== primeiroDigito) {
          return { valido: false, mensagem: 'CPF inv√°lido: primeiro d√≠gito verificador incorreto.' };
        }

        // Calcula segundo d√≠gito verificador
        soma = 0;
        for (let i = 0; i < 10; i++) {
          soma += parseInt(somenteNumeros[i]) * (11 - i);
        }
        let segundoDigito = 11 - (soma % 11);
        segundoDigito = segundoDigito > 9 ? 0 : segundoDigito;

        // Valida segundo d√≠gito verificador
        if (parseInt(somenteNumeros[10]) !== segundoDigito) {
          return { valido: false, mensagem: 'CPF inv√°lido: segundo d√≠gito verificador incorreto.' };
        }

        return { valido: true, mensagem: 'CPF v√°lido.' };
      };

      let enderecos = [];
      let indicadorEnderecoAtual = null;
      let telefones = [];
      let emails = [];
      let redes = [];
      // Coment√°rio: armazenamos os resultados da busca de pessoas para renderizar m√∫ltiplas op√ß√µes
      let resultadosBuscaPessoas = [];
      let vinculosPessoas = [];
      let vinculosEmpresas = [];
      let vinculosEntidades = [];

      // Renderiza as pr√©-visualiza√ß√µes das fotos selecionadas
      const renderizarFotos = () => {
        const container = document.getElementById('lista-fotos');
        if (!container) return;

        container.innerHTML = '';

        if (!fotosSelecionadas.length) {
          container.innerHTML = '<div class="list__item">Nenhuma foto selecionada.</div>';
          return;
        }

        fotosSelecionadas.forEach((foto, index) => {
          const wrapper = document.createElement('div');
          wrapper.style.border = '1px solid var(--border)';
          wrapper.style.padding = '0.5rem';
          wrapper.style.borderRadius = '0.5rem';
          wrapper.style.background = 'var(--surface)';
          wrapper.style.display = 'flex';
          wrapper.style.flexDirection = 'column';
          wrapper.style.gap = '0.5rem';

          const img = document.createElement('img');
          img.src = foto.previewUrl;
          img.alt = foto.nome || 'Foto selecionada';
          img.style.width = '100%';
          img.style.height = '140px';
          img.style.objectFit = 'cover';
          img.style.borderRadius = '0.35rem';

          const legend = document.createElement('div');
          legend.textContent = foto.nome || 'Foto';
          legend.style.fontSize = '0.9rem';
          legend.style.fontWeight = '600';

          const removerBtn = document.createElement('button');
          removerBtn.type = 'button';
          removerBtn.className = 'button button--ghost';
          removerBtn.textContent = 'Remover';
          removerBtn.addEventListener('click', () => removerFoto(index));

          wrapper.appendChild(img);
          wrapper.appendChild(legend);
          wrapper.appendChild(removerBtn);
          container.appendChild(wrapper);
        });
      };

      // Remove uma foto da lista e libera o URL de pr√©-visualiza√ß√£o
      const removerFoto = (index) => {
        const [removida] = fotosSelecionadas.splice(index, 1);
        if (removida?.existing && removida.referencia) {
          fotosParaRemover.push(removida.referencia); // Mant√©m controle das imagens persistidas que foram exclu√≠das
        }
        if (removida?.previewUrl && removida.file) {
          URL.revokeObjectURL(removida.previewUrl);
        }
        renderizarFotos(); // Atualiza pr√©-visualiza√ß√µes ap√≥s remover
      };

      // Adiciona novas fotos a partir do FileList do input
      const adicionarFotos = (arquivos = []) => {
        const arquivosValidos = Array.from(arquivos).filter((arquivo) => arquivo.type?.startsWith('image/'));

        arquivosValidos.forEach((arquivo) => {
          fotosSelecionadas.push({
            file: arquivo,
            nome: arquivo.name,
            previewUrl: URL.createObjectURL(arquivo),
          });
        });

        renderizarFotos(); // Re-renderiza o container #lista-fotos com as imagens persistidas
      };

      // Carrega fotos existentes retornadas pela API para edi√ß√£o
      const carregarFotosExistentes = (fotos = []) => {
        if (!Array.isArray(fotos)) {
          fotosSelecionadas = [];
          fotosParaRemover = [];
          renderizarFotos();
          return;
        }

        fotosParaRemover = [];
        fotosSelecionadas = fotos.map((foto, index) => {
          const referencia = foto?.id || foto?.url || foto;
          const nome = foto?.nomeArquivo || foto?.nome || `Foto ${index + 1}`;
          return {
            existing: true,
            referencia,
            nome,
            previewUrl: foto?.url || foto?.previewUrl || referencia,
          };
        });

        renderizarFotos(); // Preenche o container #lista-fotos abaixo do t√≠tulo com as fotos persistidas
      };


      let vinculosEmpregaticio = [];
      let ocorrenciasPoliciais = [];
      let processos = [];
      let abordagens = [];
      let prisoes = [];

      const renderizarTelefones = () => {
        const listaTelefonesEl = document.getElementById('lista-telefones');
        listaTelefonesEl.innerHTML = '';

        if (telefones.length === 0) {
          listaTelefonesEl.innerHTML = '<p style="color: var(--muted); font-size: 0.85rem; margin: 0;">Nenhum telefone adicionado. Clique para adicionar.</p>';
          return;
        }

        telefones.forEach((telefone, indice) => {
          const divTelefone = document.createElement('div');
          divTelefone.style.display = 'flex';
          divTelefone.style.gap = '0.5rem';
          divTelefone.style.alignItems = 'center';

          const inputTelefone = document.createElement('input');
          inputTelefone.type = 'tel';
          inputTelefone.className = 'form__input';
          inputTelefone.inputMode = 'tel';
          inputTelefone.value = telefone;
          inputTelefone.placeholder = '(XX) XXXXX-XXXX';
          inputTelefone.addEventListener('input', (e) => {
            telefones[indice] = e.target.value;
          });
          divTelefone.appendChild(inputTelefone);

          const btnRemover = document.createElement('button');
          btnRemover.type = 'button';
          btnRemover.className = 'button button--danger';
          btnRemover.textContent = '‚àí';
          btnRemover.setAttribute('aria-label', 'Remover telefone');
          btnRemover.title = 'Excluir';
          btnRemover.style.padding = '0.25rem 0.5rem';
          btnRemover.style.fontSize = '0.75rem';
          btnRemover.style.minWidth = 'fit-content';
          btnRemover.addEventListener('click', () => {
            telefones.splice(indice, 1);
            renderizarTelefones();
          });
          divTelefone.appendChild(btnRemover);

          listaTelefonesEl.appendChild(divTelefone);
        });
      };

      const adicionarTelefone = () => {
        telefones.push('');
        renderizarTelefones();
      };

      const renderizarEmails = () => {
        const listaEmailsEl = document.getElementById('lista-emails');
        if (!listaEmailsEl) return;
        listaEmailsEl.innerHTML = '';

        if (emails.length === 0) {
          listaEmailsEl.innerHTML = '<p style="color: var(--muted); font-size: 0.85rem; margin: 0;">Nenhum email adicionado. Clique para adicionar.</p>';
          return;
        }

        emails.forEach((email, indice) => {
          const linha = document.createElement('div');
          linha.style.display = 'flex';
          linha.style.gap = '0.5rem';
          linha.style.alignItems = 'center';

          const input = document.createElement('input');
          input.type = 'email';
          input.className = 'form__input';
          input.value = email;
          input.placeholder = 'seuemail@exemplo.com';
          input.addEventListener('input', (e) => {
            emails[indice] = e.target.value;
          });
          linha.appendChild(input);

          const btnRemover = document.createElement('button');
          btnRemover.type = 'button';
          btnRemover.className = 'button button--danger';
          btnRemover.textContent = '‚àí';
          btnRemover.setAttribute('aria-label', 'Remover email');
          btnRemover.title = 'Excluir';
          btnRemover.style.padding = '0.25rem 0.5rem';
          btnRemover.style.fontSize = '0.75rem';
          btnRemover.style.minWidth = 'fit-content';
          btnRemover.addEventListener('click', () => {
            emails.splice(indice, 1);
            renderizarEmails();
          });
          linha.appendChild(btnRemover);

          listaEmailsEl.appendChild(linha);
        });
      };

      const adicionarEmail = () => {
        emails.push('');
        renderizarEmails();
      };

      const renderizarRedes = () => {
        const listaRedesEl = document.getElementById('lista-redes');
        if (!listaRedesEl) return;
        listaRedesEl.innerHTML = '';

        if (redes.length === 0) {
          listaRedesEl.innerHTML = '<p style="color: var(--muted); font-size: 0.85rem; margin: 0;">Nenhuma rede adicionada. Clique para adicionar.</p>';
          return;
        }

        redes.forEach((rede, indice) => {
          const linha = document.createElement('div');
          linha.style.display = 'flex';
          linha.style.gap = '0.5rem';
          linha.style.alignItems = 'center';

          const partes = String(rede).split('|');
          const valorTipo = (partes[0] || '').trim();
          const valorPerfil = (partes[1] || '').trim();

          const select = document.createElement('select');
          select.className = 'form__input';
          select.style.maxWidth = '12rem';
          select.innerHTML = `
            <option value="">Selecione</option>
            <option value="instagram">Instagram</option>
            <option value="facebook">Facebook</option>
            <option value="linkedin">LinkedIn</option>
            <option value="twitter">Twitter / X</option>
            <option value="youtube">YouTube</option>
            <option value="tiktok">TikTok</option>
            <option value="github">GitHub</option>
            <option value="website">Website</option>
            <option value="outro">Outro</option>
          `;
          select.value = valorTipo;
          linha.appendChild(select);

          const input = document.createElement('input');
          input.type = 'text';
          input.className = 'form__input';
          input.placeholder = 'URL ou @usuario';
          input.value = valorPerfil;
          input.style.flex = '1';
          linha.appendChild(input);

          const atualizarValor = () => {
            const tipo = select.value || '';
            const perfil = input.value || '';
            redes[indice] = `${tipo}|${perfil}`;
          };

          select.addEventListener('change', atualizarValor);
          input.addEventListener('input', atualizarValor);

          const btnRemover = document.createElement('button');
          btnRemover.type = 'button';
          btnRemover.className = 'button button--danger';
          btnRemover.textContent = '‚àí';
          btnRemover.setAttribute('aria-label', 'Remover rede social');
          btnRemover.title = 'Excluir';
          btnRemover.style.padding = '0.25rem 0.5rem';
          btnRemover.style.fontSize = '0.75rem';
          btnRemover.style.minWidth = 'fit-content';
          btnRemover.addEventListener('click', () => {
            redes.splice(indice, 1);
            renderizarRedes();
          });
          linha.appendChild(btnRemover);

          listaRedesEl.appendChild(linha);
        });
      };

      const adicionarRede = () => {
        redes.push('|');
        renderizarRedes();
      };

      const aplicarMascaraCnpj = (valor) => {
        const dig = String(valor || '').replace(/\D/g, '').slice(0, 14);
        let v = dig;
        if (dig.length > 2) v = dig.slice(0,2) + '.' + dig.slice(2);
        if (dig.length > 5) v = v.slice(0,6) + '.' + dig.slice(5);
        if (dig.length > 8) v = v.slice(0,10) + '/' + dig.slice(8);
        if (dig.length > 12) v = v.slice(0,15) + '-' + dig.slice(12);
        return v;
      };

      const aplicarMascaraCpfInline = (valor) => {
        const dig = String(valor || '').replace(/\D/g, '').slice(0, 11);
        let v = dig;
        if (dig.length > 3) v = dig.slice(0,3) + '.' + dig.slice(3);
        if (dig.length > 6) v = v.slice(0,7) + '.' + dig.slice(6);
        if (dig.length > 9) v = v.slice(0,11) + '-' + dig.slice(9);
        return v;
      };

      const aplicarMascaraTelefone = (valor) => {
        const dig = String(valor || '').replace(/\D/g, '').slice(0, 11);
        if (dig.length <= 10) {
          return dig.replace(/(\d{0,2})(\d{0,4})(\d{0,4}).*/, function(_, a,b,c){
            let r = '';
            if (a) r += `(${a}` + (a.length===2?') ':'');
            if (b) r += b + (b.length===4?'-':'');
            if (c) r += c;
            return r;
          });
        } else {
          return dig.replace(/(\d{0,2})(\d{0,5})(\d{0,4}).*/, function(_, a,b,c){
            let r = '';
            if (a) r += `(${a}` + (a.length===2?') ':'');
            if (b) r += b + (b.length===5?'-':'');
            if (c) r += c;
            return r;
          });
        }
      };

      const aplicarMascaraCep = (valor) => {
        const dig = String(valor || '').replace(/\D/g, '').slice(0,8);
        if (dig.length <= 5) return dig;
        return dig.slice(0,5) + '-' + dig.slice(5);
      };

      

      const renderizarVinculosPessoas = () => {
        const lista = document.getElementById('lista-vinculos-pessoas');
        if (!lista) return;
        lista.innerHTML = '';
        if (vinculosPessoas.length === 0) {
          lista.innerHTML = '';
          return;
        }
        vinculosPessoas.forEach((v, i) => {
          const linha = document.createElement('div');
          linha.style.cssText = 'display:grid; grid-template-columns: 1fr 16rem 16rem auto; gap:0.5rem; align-items:end;';
          linha.innerHTML = `
            <label class="form__field">
              <span class="form__label">Nome</span>
              <input class="form__input vpc-nome" type="text" data-index="${i}" />
            </label>
            <label class="form__field">
              <span class="form__label">CPF</span>
              <input class="form__input vpc-cpf" type="text" data-index="${i}" placeholder="000.000.000-00" />
            </label>
            <label class="form__field">
              <span class="form__label">Tipo</span>
              <select class="form__input vpc-tipo" data-index="${i}">
                <option value="">Selecione</option>
                <option>Esposa(o)</option>
                <option>Filho(a)</option>
                <option>Irm√£o(a)</option>
                <option>S√≥cio(a)</option>
                <option>Namorado(a)</option>
                <option>Primo(a)</option>
                <option>Tio(a)</option>
                <option>Av√¥(√≥)</option>
                <option>Amigo(a)</option>
                <option>Comparsa</option>
                <option>Advogado(a)</option>
                <option>Contador</option>
                <option>Outro</option>
              </select>
            </label>
            <button class="button button--danger" type="button" title="Excluir" aria-label="Remover v√≠nculo">‚àí</button>
          `;
          const nomeEl = linha.querySelector('.vpc-nome');
          const cpfEl = linha.querySelector('.vpc-cpf');
          const tipoEl = linha.querySelector('.vpc-tipo');
          const btn = linha.querySelector('button');
          nomeEl.value = v.nome || '';
          cpfEl.value = aplicarMascaraCpfInline(v.cpf || '');
          tipoEl.value = v.tipo || '';
          nomeEl.addEventListener('input', (e) => { vinculosPessoas[i].nome = e.target.value; });
          cpfEl.addEventListener('input', (e) => { vinculosPessoas[i].cpf = aplicarMascaraCpfInline(e.target.value); e.target.value = vinculosPessoas[i].cpf; });
          tipoEl.addEventListener('change', (e) => { vinculosPessoas[i].tipo = e.target.value; });
          btn.addEventListener('click', () => { vinculosPessoas.splice(i,1); renderizarVinculosPessoas(); });
          lista.appendChild(linha);
        });
      };

      // Coment√°rio: controla a renderiza√ß√£o dos resultados retornados pela API de busca de pessoas
      const renderizarResultadosPessoasBusca = () => {
        const container = document.getElementById('pessoas-busca-resultado');
        if (!container) return;

        container.innerHTML = '';

        if (!resultadosBuscaPessoas.length) {
          container.innerHTML = '<p style="color: var(--muted); margin: 0;">Nenhum resultado para mostrar. Refine a busca.</p>';
          container.style.display = 'block';
          return;
        }

        container.style.display = 'grid';
        container.style.gridTemplateColumns = 'repeat(auto-fill, minmax(260px, 1fr))';
        container.style.gap = '0.75rem';

        resultadosBuscaPessoas.forEach((pessoa, indice) => {
          const nomeEncontrado = pessoa.nomeCompleto || pessoa.apelido || 'Pessoa encontrada';
          const cpfEncontrado = aplicarMascaraCpfInline(pessoa.cpf || '');

          const card = document.createElement('div');
          card.className = 'panel';
          card.style.padding = '0.75rem';
          card.style.display = 'flex';
          card.style.flexDirection = 'column';
          card.style.gap = '0.35rem';

          card.innerHTML = `
            <div style="display:flex; justify-content:space-between; gap:0.5rem; align-items:flex-start;">
              <div>
                <p style="margin:0; font-weight:700;">${nomeEncontrado}</p>
                <p style="margin:0; color:var(--muted);">${cpfEncontrado ? `CPF: ${cpfEncontrado}` : 'CPF n√£o informado'}</p>
                <p style="margin:0; color:var(--muted);">${pessoa.apelido ? `Vulgo: ${pessoa.apelido}` : ''}</p>
              </div>
              <button class="button button--primary" type="button" data-indice="${indice}">Vincular</button>
            </div>
          `;

          const botao = card.querySelector('button');
          botao.addEventListener('click', () => confirmarVinculoPessoa(indice));

          container.appendChild(card);
        });
      };

      // Coment√°rio: limpa o estado e a √°rea visual de resultados de busca
      const limparResultadosPessoasBusca = (mostrarMensagem = false) => {
        resultadosBuscaPessoas = [];
        const container = document.getElementById('pessoas-busca-resultado');
        if (!container) return;

        container.innerHTML = mostrarMensagem
          ? '<p style="color: var(--muted); margin: 0;">Nenhuma pessoa encontrada.</p>'
          : '';
        container.style.display = mostrarMensagem ? 'block' : 'none';
      };

      const adicionarVinculoPessoa = (dados = { nome: '', cpf: '', tipo: '' }) => {
        // Coment√°rio: mantemos o formato original para garantir compatibilidade com o backend
        // e com fluxos de salvamento j√° existentes no formul√°rio de pessoa.
        const novoVinculo = {
          nome: String(dados?.nome || '').trim(),
          cpf: aplicarMascaraCpfInline(dados?.cpf || ''),
          tipo: String(dados?.tipo || ''),
        };

        vinculosPessoas.push(novoVinculo);
        renderizarVinculosPessoas();
      };

      const montarFiltrosBuscaVinculo = (valorBusca) => {
        // Coment√°rio: valida a entrada e decide qual par√¢metro enviar para a API (/buscar j√° aceita filtros via querystring)
        const termo = String(valorBusca || '').trim();
        if (!termo) {
          throw new Error('Informe um nome ou CPF para procurar a pessoa.');
        }

        const cpfLimpo = normalizarCpfSomenteDigitos(termo);
        if (cpfLimpo.length > 0 && cpfLimpo.length < 11) {
          throw new Error('CPF incompleto: informe os 11 d√≠gitos para a busca.');
        }

        if (cpfLimpo.length === 11) {
          return { query: { documento: cpfLimpo }, descricao: 'CPF informado' };
        }

        if (termo.length < 3) {
          throw new Error('Digite ao menos 3 caracteres do nome para continuar.');
        }

        return { query: { nome: termo }, descricao: 'nome informado' };
      };

      // Coment√°rio: confirma e aplica o v√≠nculo selecionado em cada resultado
      const confirmarVinculoPessoa = (indice) => {
        const pessoaEncontrada = resultadosBuscaPessoas[indice];

        if (!pessoaEncontrada) {
          exibirMensagemForm('N√£o foi poss√≠vel identificar a pessoa selecionada.', 'error');
          return;
        }

        const nomeEncontrado = pessoaEncontrada.nomeCompleto || pessoaEncontrada.apelido || 'Pessoa encontrada';
        const cpfEncontrado = aplicarMascaraCpfInline(pessoaEncontrada.cpf || '');
        const resumoPessoa = cpfEncontrado ? `${nomeEncontrado} (CPF: ${cpfEncontrado})` : nomeEncontrado;

        const confirmarVinculo = confirm(`Deseja vincular ${resumoPessoa} ao cadastro atual?`);
        if (!confirmarVinculo) {
          exibirMensagemForm('V√≠nculo cancelado pelo usu√°rio.', 'info');
          return;
        }

        const cpfLimpoEncontrado = normalizarCpfSomenteDigitos(pessoaEncontrada.cpf || '');
        const nomeNormalizado = String(nomeEncontrado || '').trim().toLowerCase();
        const jaVinculado = vinculosPessoas.some((v) => {
          const cpfVinculo = normalizarCpfSomenteDigitos(v.cpf || '');
          const nomeVinculo = String(v.nome || '').trim().toLowerCase();
          return (cpfLimpoEncontrado && cpfVinculo && cpfVinculo === cpfLimpoEncontrado) || (nomeNormalizado && nomeVinculo === nomeNormalizado);
        });

        if (jaVinculado) {
          exibirMensagemForm('Essa pessoa j√° est√° vinculada.', 'info');
          return;
        }

        adicionarVinculoPessoa({
          nome: nomeEncontrado,
          cpf: cpfEncontrado,
          tipo: '',
        });

        renderizarVinculosPessoas();
        limparResultadosPessoasBusca();
        exibirMensagemForm('Pessoa vinculada com sucesso ao cadastro.', 'success');
      };

      const buscarPessoaParaVinculo = async () => {
        const termoBusca = vinculoPessoaBuscaInput?.value || '';
        try {
          const { query, descricao } = montarFiltrosBuscaVinculo(termoBusca);
          exibirMensagemForm(`Buscando pessoa pelo ${descricao}...`, 'info');

          const params = new URLSearchParams(query);
          const response = await fetchAutenticado(`${API_PESSOAS_URL}/buscar?${params.toString()}`);
          const data = await response.json().catch(() => []);

          if (!response.ok) {
            const erro = data?.mensagem || data?.message || 'Erro ao buscar pessoas.';
            throw new Error(erro);
          }

          limparResultadosPessoasBusca();

          const pessoasEncontradas = Array.isArray(data) ? data : data?.data || [];

          if (!pessoasEncontradas.length) {
            const criarNova = confirm('Nenhuma pessoa encontrada. Deseja cadastrar uma nova?');
            if (criarNova) {
              // Coment√°rio: reutilizamos a rota padr√£o de cria√ß√£o para manter a navega√ß√£o original
              // e permitir que o usu√°rio complete o cadastro antes de voltar para vincular.
              window.location.href = '/cadastro/pessoas';
            }
            exibirMensagemForm('Nenhuma pessoa encontrada com o filtro informado.', 'info');
            limparResultadosPessoasBusca(true);
            return;
          }

          resultadosBuscaPessoas = pessoasEncontradas;
          renderizarResultadosPessoasBusca();
          exibirMensagemForm('Selecione uma das pessoas encontradas para vincular.', 'success');
        } catch (error) {
          exibirMensagemForm(error?.message || 'Erro ao procurar pessoa para v√≠nculo.', 'error');
        }
      };

      // Se√ß√£o de v√≠nculos de Empresa removida: fun√ß√µes exclu√≠das

      const renderizarVinculosEmpregaticio = () => {
        const lista = document.getElementById('lista-vinculos-empregaticio');
        if (!lista) return;
        lista.innerHTML = '';
        if (vinculosEmpregaticio.length === 0) {
          lista.innerHTML = '<p style="color: var(--muted); font-size: 0.85rem; margin: 0;">Nenhum v√≠nculo empregat√≠cio adicionado. Clique para adicionar.</p>';
          return;
        }
        vinculosEmpregaticio.forEach((item, i) => {
          const linha = document.createElement('div');
          linha.style.cssText = 'display:grid; grid-template-columns: 1fr auto; gap:0.5rem; align-items:end;';
          linha.innerHTML = `
            <label class="form__field">
              <span class="form__label">Informa√ß√£o</span>
              <input class="form__input vempr-info" type="text" data-index="${i}" placeholder="Detalhes do v√≠nculo empregat√≠cio" />
            </label>
            <button class="button button--danger" type="button" title="Excluir" aria-label="Remover v√≠nculo">‚àí</button>
          `;
          const infoEl = linha.querySelector('.vempr-info');
          const btn = linha.querySelector('button');
          infoEl.value = String(item?.info || '');
          infoEl.addEventListener('input', (e) => { vinculosEmpregaticio[i].info = e.target.value; });
          btn.addEventListener('click', () => { vinculosEmpregaticio.splice(i,1); renderizarVinculosEmpregaticio(); });
          lista.appendChild(linha);
        });
      };

      const adicionarVinculoEmpregaticio = () => {
        vinculosEmpregaticio.push({ info: '' });
        renderizarVinculosEmpregaticio();
      };

      // Gera o link de mapa usando o valor de latitude/longitude informado
      const gerarLinkMapaLatLong = (valorLatLong) => {
        const texto = String(valorLatLong || '').trim();
        const coordenadas = texto.match(/(-?\d+(?:\.\d+)?)\s*,\s*(-?\d+(?:\.\d+)?)/);

        if (!coordenadas) return '';

        return `https://www.google.com/maps?q=${coordenadas[1]},${coordenadas[2]}`;
      };

      // Gera link de mapa a partir do endere√ßo textual
      const gerarLinkMapaEndereco = (endereco) => {
        if (!endereco) return '';
        const partes = [
          endereco.logradouro,
          endereco.bairro,
          endereco.complemento,
          endereco.uf,
          endereco.cep
        ].filter(Boolean).map(String);
        if (partes.length === 0) return '';
        const query = encodeURIComponent(partes.join(', '));
        return `https://www.google.com/maps?q=${query}`;
      };

      const renderizarVinculosEntidades = () => {
        const lista = document.getElementById('lista-vinculos-entidades');
        if (!lista) return;
        lista.innerHTML = '';
        if (vinculosEntidades.length === 0) {
          lista.innerHTML = '<p style="color: var(--muted); font-size: 0.85rem; margin: 0;">Nenhuma entidade adicionada. Clique para adicionar.</p>';
          return;
        }
        vinculosEntidades.forEach((ent, i) => {
          const linha = document.createElement('div');
          linha.style.cssText = 'display:grid; grid-template-columns: 1fr 1fr auto; gap:0.5rem; align-items:end;';
          linha.innerHTML = `
            <label class="form__field">
              <span class="form__label">Nome</span>
              <input class="form__input ven-nome" type="text" data-index="${i}" placeholder="Digite o nome" />
            </label>
            <label class="form__field">
              <span class="form__label">Observa√ß√µes</span>
              <textarea class="form__input ven-obs" data-index="${i}" placeholder="Observa√ß√µes" rows="1" style="resize: vertical; min-height: 2.6rem;"></textarea>
            </label>
            <button class="button button--danger" type="button" title="Excluir" aria-label="Remover entidade">‚àí</button>
          `;
          const nomeEl = linha.querySelector('.ven-nome');
          const obsEl = linha.querySelector('.ven-obs');
          const btn = linha.querySelector('button');
          nomeEl.value = String(ent?.nome || '');
          obsEl.value = String(ent?.observacoes || '');
          nomeEl.addEventListener('input', (e) => { if (!vinculosEntidades[i]) vinculosEntidades[i] = { nome: '', observacoes: '' }; vinculosEntidades[i].nome = e.target.value; });
          obsEl.addEventListener('input', (e) => { if (!vinculosEntidades[i]) vinculosEntidades[i] = { nome: '', observacoes: '' }; vinculosEntidades[i].observacoes = e.target.value; });
          btn.addEventListener('click', () => { vinculosEntidades.splice(i,1); renderizarVinculosEntidades(); });
          lista.appendChild(linha);
        });
      };

      const adicionarVinculoEntidade = () => {
        vinculosEntidades.push({ nome: '', observacoes: '' });
        renderizarVinculosEntidades();
      };

      

      

      const renderizarLinhaDataInfo = (arrRef, listaElId, labelData = 'Data', placeholderInfo = 'Informa√ß√£o') => {
        const lista = document.getElementById(listaElId);
        if (!lista) return;
        lista.innerHTML = '';
        if (arrRef.length === 0) {
          lista.innerHTML = '<p style="color: var(--muted); font-size: 0.85rem; margin: 0;">Nenhum item adicionado. Clique para adicionar.</p>';
          return;
        }
        arrRef.forEach((item, i) => {
          const linha = document.createElement('div');
          linha.style.cssText = 'display:grid; grid-template-columns: 12rem 1fr auto; gap:0.5rem; align-items:end;';
          linha.innerHTML = `
            <label class="form__field">
              <span class="form__label">${labelData}</span>
              <input class="form__input occ-data" type="date" data-index="${i}" />
            </label>
            <label class="form__field">
              <span class="form__label">${placeholderInfo}</span>
              <input class="form__input occ-info" type="text" data-index="${i}" placeholder="${placeholderInfo}" />
            </label>
            <button class="button button--danger" type="button" title="Excluir" aria-label="Remover">‚àí</button>
          `;
          const dataEl = linha.querySelector('.occ-data');
          const infoEl = linha.querySelector('.occ-info');
          const btn = linha.querySelector('button');
          dataEl.value = String(item?.data || '');
          infoEl.value = String(item?.info || '');
          dataEl.addEventListener('input', (e) => { arrRef[i].data = e.target.value; });
          infoEl.addEventListener('input', (e) => { arrRef[i].info = e.target.value; });
          btn.addEventListener('click', () => { arrRef.splice(i,1); renderizarLinhaDataInfo(arrRef, listaElId, labelData, placeholderInfo); });
          lista.appendChild(linha);
        });
      };

      const renderizarOcorrenciasPoliciais = () => renderizarLinhaDataInfo(ocorrenciasPoliciais, 'lista-ocorrencias-policiais', 'Data', 'Informa√ß√£o');
      const renderizarProcessos = () => renderizarLinhaDataInfo(processos, 'lista-processos', 'Data', 'Informa√ß√£o');
      const renderizarAbordagens = () => renderizarLinhaDataInfo(abordagens, 'lista-abordagens', 'Data', 'Informa√ß√£o');
      const renderizarPrisoes = () => renderizarLinhaDataInfo(prisoes, 'lista-prisoes', 'Data', 'Informa√ß√£o');

      const adicionarOcorrenciaPolicial = () => { ocorrenciasPoliciais.push({ data: '', info: '' }); renderizarOcorrenciasPoliciais(); };
      const adicionarProcesso = () => { processos.push({ data: '', info: '' }); renderizarProcessos(); };
      const adicionarAbordagem = () => { abordagens.push({ data: '', info: '' }); renderizarAbordagens(); };
      const adicionarPrisao = () => { prisoes.push({ data: '', info: '' }); renderizarPrisoes(); };

      const createEstadosSelect = () => {
        return `<option value="">Selecione</option>
                    <option value="AC">Acre (AC)</option>
                    <option value="AL">Alagoas (AL)</option>
                    <option value="AP">Amap√° (AP)</option>
                    <option value="AM">Amazonas (AM)</option>
                    <option value="BA">Bahia (BA)</option>
                    <option value="CE">Cear√° (CE)</option>
                    <option value="DF">Distrito Federal (DF)</option>
                    <option value="ES">Esp√≠rito Santo (ES)</option>
                    <option value="GO">Goi√°s (GO)</option>
                    <option value="MA">Maranh√£o (MA)</option>
                    <option value="MT">Mato Grosso (MT)</option>
                    <option value="MS">Mato Grosso do Sul (MS)</option>
                    <option value="MG">Minas Gerais (MG)</option>
                    <option value="PA">Par√° (PA)</option>
                    <option value="PB">Para√≠ba (PB)</option>
                    <option value="PR">Paran√° (PR)</option>
                    <option value="PE">Pernambuco (PE)</option>
                    <option value="PI">Piau√≠ (PI)</option>
                    <option value="RJ">Rio de Janeiro (RJ)</option>
                    <option value="RN">Rio Grande do Norte (RN)</option>
                    <option value="RS">Rio Grande do Sul (RS)</option>
                    <option value="RO">Rond√¥nia (RO)</option>
                    <option value="RR">Roraima (RR)</option>
                    <option value="SC">Santa Catarina (SC)</option>
                    <option value="SP">S√£o Paulo (SP)</option>
                    <option value="SE">Sergipe (SE)</option>
                    <option value="TO">Tocantins (TO)</option>`;
      };

      const renderizarEnderecos = () => {
        const listaEl = document.getElementById('lista-enderecos');
        listaEl.innerHTML = '';

        if (enderecos.length === 0) {
          listaEl.innerHTML = '<p style="color: var(--muted); margin: 1rem 0;">Nenhum endere√ßo adicionado. Clique no bot√£o para adicionar um.</p>';
          return;
        }

        // Garante que o endere√ßo atual seja exibido primeiro na lista renderizada
        const ordemEnderecos = indicadorEnderecoAtual === null
          ? enderecos.map((_, indice) => indice)
          : [indicadorEnderecoAtual, ...enderecos.map((_, indice) => indice).filter((indice) => indice !== indicadorEnderecoAtual)];

        ordemEnderecos.forEach((indiceOrdenado, posicao) => {
          const endereco = enderecos[indiceOrdenado];
          const div = document.createElement('div');
          div.className = 'endereco-item';
          div.style.cssText = 'border: 1px solid var(--border); border-radius: 0.5rem; padding: 1.5rem; margin-bottom: 1rem; background: var(--surface-muted);';

          const headerDiv = document.createElement('div');
          headerDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;';

          const titleSpan = document.createElement('span');
          titleSpan.style.cssText = 'font-weight: 600; color: var(--text);';
          titleSpan.textContent = `Endere√ßo ${posicao + 1}${indicadorEnderecoAtual === indiceOrdenado ? ' (Atual)' : ''}`;

          const actionsDiv = document.createElement('div');
          actionsDiv.style.cssText = 'display: flex; gap: 0.5rem;';

          if (enderecos.length > 1 && indicadorEnderecoAtual !== indiceOrdenado) {
            const setarAtualBtn = document.createElement('button');
            setarAtualBtn.type = 'button';
            setarAtualBtn.className = 'button button--secondary';
            setarAtualBtn.textContent = 'Definir como Atual';
            setarAtualBtn.style.cssText = 'padding: 0.5rem 1rem; font-size: 0.875rem;';
            setarAtualBtn.addEventListener('click', () => {
              indicadorEnderecoAtual = indiceOrdenado;
              renderizarEnderecos();
            });
            actionsDiv.appendChild(setarAtualBtn);
          }

          const removerBtn = document.createElement('button');
          removerBtn.type = 'button';
          removerBtn.className = 'button button--danger';
          removerBtn.textContent = '‚àí';
          removerBtn.setAttribute('aria-label', 'Remover endere√ßo');
          removerBtn.title = 'Excluir';
          removerBtn.style.cssText = 'padding: 0.25rem 0.5rem; font-size: 0.75rem; min-width: fit-content;';
          removerBtn.addEventListener('click', () => {
            enderecos.splice(indiceOrdenado, 1);
            if (indicadorEnderecoAtual === indiceOrdenado) {
              indicadorEnderecoAtual = enderecos.length > 0 ? 0 : null;
            } else if (indicadorEnderecoAtual > indiceOrdenado) {
              indicadorEnderecoAtual--;
            }
            renderizarEnderecos();
          });
          actionsDiv.appendChild(removerBtn);

          headerDiv.appendChild(titleSpan);
          headerDiv.appendChild(actionsDiv);
          div.appendChild(headerDiv);

          // Criar campos do endere√ßo
          const gridDiv = document.createElement('div');
          gridDiv.className = 'form__grid form__grid--4';
          gridDiv.innerHTML = `
            <label class="form__field">
              <span class="form__label">UF</span>
              <select class="form__input endereco-uf" data-index="${indiceOrdenado}">
                ${createEstadosSelect()}
              </select>
            </label>
            <label class="form__field form__field--wide">
              <span class="form__label">Logradouro/Nome</span>
              <input class="form__input endereco-logradouro" type="text" data-index="${indiceOrdenado}" />
            </label>
            <label class="form__field">
              <span class="form__label">Bairro/Cidade</span>
              <input class="form__input endereco-bairro" type="text" data-index="${indiceOrdenado}" />
            </label>
            <label class="form__field">
              <span class="form__label">CEP</span>
              <input class="form__input endereco-cep" type="text" inputmode="numeric" data-index="${indiceOrdenado}" />
            </label>
            <label class="form__field">
              <span class="form__label">Complemento</span>
              <input class="form__input endereco-complemento" type="text" data-index="${indiceOrdenado}" />
            </label>
            <label class="form__field form__field--wide" style="position: relative;">
              <span class="form__label">Lat/Long</span>
              <!-- Entrada livre para latitude e longitude informadas pelo usu√°rio -->
              <input class="form__input endereco-latlong" type="text" data-index="${indiceOrdenado}" placeholder="-23.5, -46.6" />
            </label>
          `;

          // Preencher valores salvos para manter sincronia com o formul√°rio
          gridDiv.querySelector('.endereco-uf').value = endereco.uf || '';
          gridDiv.querySelector('.endereco-logradouro').value = endereco.logradouro || '';
          gridDiv.querySelector('.endereco-bairro').value = endereco.bairro || '';
          gridDiv.querySelector('.endereco-cep').value = endereco.cep || '';
          gridDiv.querySelector('.endereco-complemento').value = endereco.complemento || '';
          gridDiv.querySelector('.endereco-latlong').value = endereco.latLong || '';

          // Adicionar listeners
          gridDiv.querySelector('.endereco-uf').addEventListener('change', (e) => {
            enderecos[indiceOrdenado].uf = e.target.value;
          });
          gridDiv.querySelector('.endereco-logradouro').addEventListener('input', (e) => {
            enderecos[indiceOrdenado].logradouro = e.target.value;
          });
          gridDiv.querySelector('.endereco-bairro').addEventListener('input', (e) => {
            enderecos[indiceOrdenado].bairro = e.target.value;
          });
          gridDiv.querySelector('.endereco-complemento').addEventListener('input', (e) => {
            enderecos[indiceOrdenado].complemento = e.target.value;
          });

          // Link din√¢mico inline dentro do pr√≥prio campo
          // Para Logradouro/Nome ap√≥s salvar
          const logradouroCampo = gridDiv.querySelector('.endereco-logradouro');
          const logradouroField = logradouroCampo.closest('.form__field');
          const logradouroAnchor = document.createElement('a');
          logradouroAnchor.className = 'endereco-inline-link';
          logradouroAnchor.style.cssText = 'position:absolute; inset: calc(1.6rem + 2px) 2px 2px 2px; display:none; align-items:center; padding: 0.5rem 0.75rem; border-radius: 0.4rem; text-decoration: underline; color: var(--primary); background: transparent; z-index: 2; pointer-events: auto;';
          logradouroAnchor.target = '_blank';
          logradouroAnchor.rel = 'noopener noreferrer';
          logradouroField?.appendChild(logradouroAnchor);

          const atualizarLinkEnderecoTexto = () => {
            if (!enderecos[indiceOrdenado]?.mostrarLinkEndereco) {
              logradouroAnchor.style.display = 'none';
              // Restaura texto do input durante edi√ß√£o
              logradouroCampo.style.color = '';
              logradouroCampo.style.textShadow = '';
              logradouroCampo.style.caretColor = '';
              return;
            }
            const url = gerarLinkMapaEndereco(enderecos[indiceOrdenado]);
            const texto = String(enderecos[indiceOrdenado]?.logradouro || '').trim();
            if (url && texto) {
              logradouroAnchor.href = url;
              logradouroAnchor.textContent = texto;
              logradouroAnchor.title = 'Abrir endere√ßo no Google Maps';
              logradouroAnchor.style.display = 'flex';
              // Oculta visivelmente o texto do input para evitar duplicidade
              logradouroCampo.style.color = 'transparent';
              logradouroCampo.style.textShadow = '0 0 0 var(--text)';
              logradouroCampo.style.caretColor = 'var(--text)';
              logradouroCampo.style.pointerEvents = 'none';
            } else {
              logradouroAnchor.style.display = 'none';
              logradouroCampo.style.color = '';
              logradouroCampo.style.textShadow = '';
              logradouroCampo.style.caretColor = '';
              logradouroCampo.style.pointerEvents = '';
            }
          };

          atualizarLinkEnderecoTexto();

          logradouroCampo.addEventListener('input', () => {
            // Durante edi√ß√£o, desativa a convers√£o para link
            enderecos[indiceOrdenado].mostrarLinkEndereco = false;
            atualizarLinkEnderecoTexto();
          });

          const latLongCampo = gridDiv.querySelector('.endereco-latlong');
          const latLongField = latLongCampo.closest('.form__field');
          const latLongAnchor = document.createElement('a');
          latLongAnchor.className = 'latlong-inline-link';
          latLongAnchor.style.cssText = 'display:none; margin-top: 0.35rem; text-decoration: underline; color: var(--primary);';
          latLongAnchor.target = '_blank';
          latLongAnchor.rel = 'noopener noreferrer';
          const latLongEditBtn = document.createElement('button');
          latLongEditBtn.type = 'button';
          latLongEditBtn.className = 'button button--secondary';
          latLongEditBtn.textContent = 'Editar';
          latLongEditBtn.title = 'Editar Lat/Long';
          latLongEditBtn.style.cssText = 'display:none; margin-top: 0.35rem; padding: 0.25rem 0.5rem; font-size: 0.75rem;';
          const latLongActionsWrap = document.createElement('div');
          latLongActionsWrap.style.cssText = 'display:flex; gap:0.5rem; align-items:center;';
          latLongActionsWrap.appendChild(latLongAnchor);
          latLongActionsWrap.appendChild(latLongEditBtn);
          latLongField?.appendChild(latLongActionsWrap);

          const atualizarLinkLatLong = (valor) => {
            const texto = String(valor || '').trim();
            const url = gerarLinkMapaLatLong(texto);
            const podeMostrar = Boolean(enderecos[indiceOrdenado]?.mostrarLinkLatLong);
            if (url && texto && podeMostrar) {
              latLongAnchor.href = url;
              latLongAnchor.textContent = texto;
              latLongAnchor.title = 'Abrir no Google Maps';
              latLongAnchor.style.display = 'inline';
              latLongEditBtn.style.display = 'inline';
              latLongCampo.style.display = 'none';
            } else {
              latLongAnchor.style.display = 'none';
              latLongEditBtn.style.display = 'none';
              latLongCampo.style.display = '';
            }
          };

          atualizarLinkLatLong(latLongCampo.value);

          latLongCampo.addEventListener('input', (e) => {
            enderecos[indiceOrdenado].latLong = e.target.value;
            enderecos[indiceOrdenado].mostrarLinkLatLong = false;
            atualizarLinkLatLong(e.target.value);
          });
          latLongEditBtn.addEventListener('click', () => {
            enderecos[indiceOrdenado].mostrarLinkLatLong = false;
            atualizarLinkLatLong(latLongCampo.value);
            latLongCampo.focus();
          });
          const cepInput = gridDiv.querySelector('.endereco-cep');
          cepInput.addEventListener('blur', (e) => {
            if (e.target.value?.trim()) {
              mostrarCarregamentoCep(indiceOrdenado, true);
              buscarEnderecoPorCepMultiplo(e.target.value, indiceOrdenado);
            }
          });

          div.appendChild(gridDiv);

          // Adiciona elemento para exibir status de carregamento
          const statusDiv = document.createElement('div');
          statusDiv.className = `cep-status-${indiceOrdenado}`;
          statusDiv.style.cssText = 'margin-top: 0.75rem; font-size: 0.85rem; display: none;';
          div.appendChild(statusDiv);

          listaEl.appendChild(div);
        });
      };

      const adicionarEndereco = () => {
        enderecos.push({
          uf: '',
          logradouro: '',
          bairro: '',
          cep: '',
          complemento: '',
          // Inicializa campo de latitude/longitude vazio
          latLong: ''
        });

        if (indicadorEnderecoAtual === null && enderecos.length === 1) {
          indicadorEnderecoAtual = 0;
        }

        renderizarEnderecos();
      };

      const buscarEnderecoPorCepMultiplo = async (cep, index) => {
        const somenteNumeros = cep.replace(/\D/g, '');

        if (somenteNumeros.length !== 8) {
          mostrarCarregamentoCep(index, false);
          return;
        }

        try {
          const response = await fetch(`https://viacep.com.br/ws/${somenteNumeros}/json/`);
          const data = await response.json();

          if (data.erro) {
            exibirStatusCep(index, 'CEP n√£o encontrado', 'error');
          } else {
            enderecos[index].uf = data.uf || '';
            enderecos[index].logradouro = data.logradouro || '';
            enderecos[index].bairro = `${data.bairro || ''} ${data.localidade || ''}`.trim();
            enderecos[index].cep = somenteNumeros;
            renderizarEnderecos();
            exibirStatusCep(index, 'Endere√ßo carregado com sucesso', 'success');
          }
        } catch (error) {
          exibirStatusCep(index, 'Erro ao buscar CEP', 'error');
          console.error('Erro ao buscar CEP:', error);
        } finally {
          mostrarCarregamentoCep(index, false);
        }
      };

      const mostrarCarregamentoCep = (index, mostrando) => {
        const statusEl = document.querySelector(`.cep-status-${index}`);
        if (!statusEl) return;

        if (mostrando) {
          statusEl.innerHTML = `
            <div style="display: flex; align-items: center; gap: 0.5rem; color: var(--primary);">
              <div class="spinner" style="width: 16px; height: 16px; border: 2px solid var(--primary); border-top: 2px solid transparent; border-radius: 50%; animation: spin 0.6s linear infinite;"></div>
              <span>Carregando endere√ßo...</span>
            </div>
          `;
          statusEl.style.display = 'block';
        } else {
          statusEl.style.display = 'none';
        }
      };

      const exibirStatusCep = (index, mensagem, tipo) => {
        const statusEl = document.querySelector(`.cep-status-${index}`);
        if (!statusEl) return;

        const cores = {
          success: 'var(--success-text)',
          error: 'var(--error-text)'
        };

        statusEl.innerHTML = `
          <div style="display: flex; align-items: center; gap: 0.5rem; color: ${cores[tipo] || 'var(--text)'};">
            <span>${tipo === 'success' ? '‚úì' : '‚úï'}</span>
            <span>${mensagem}</span>
          </div>
        `;
        statusEl.style.display = 'block';

        // Auto-hide depois de 3 segundos
        setTimeout(() => {
          if (statusEl.style.display !== 'none') {
            statusEl.style.display = 'none';
          }
        }, 3000);
      };

      const preencherFormulario = (pessoa) => {
        Object.entries(pessoa).forEach(([chave, valor]) => {
          const el = pessoaForm.elements[chave];
          if (!el) return;
          // N√£o √© permitido setar programaticamente valor em inputs type="file"; pule-os
          if (el.type === 'file' || chave === 'fotos') return;
          el.value = valor || '';
        });

        // Carrega endere√ßos se existirem
        if (pessoa.enderecos && Array.isArray(pessoa.enderecos)) {
          enderecos = JSON.parse(JSON.stringify(pessoa.enderecos));
          indicadorEnderecoAtual = pessoa.endereco_atual_index !== undefined ? pessoa.endereco_atual_index : 0;
          renderizarEnderecos();
        } else {
          enderecos = [];
          indicadorEnderecoAtual = null;
          renderizarEnderecos();
        }

        // Carrega telefones se existirem
        if (pessoa.telefones && Array.isArray(pessoa.telefones)) {
          telefones = JSON.parse(JSON.stringify(pessoa.telefones));
        } else {
          telefones = [];
        }
        renderizarTelefones();

        // Carrega emails se existirem
        if (pessoa.emails && Array.isArray(pessoa.emails)) {
          emails = JSON.parse(JSON.stringify(pessoa.emails));
        } else {
          emails = [];
        }
        renderizarEmails();

        // Carrega redes sociais se existirem
        if (pessoa.redesSociais && Array.isArray(pessoa.redesSociais)) {
          redes = JSON.parse(JSON.stringify(pessoa.redesSociais));
        } else {
          redes = [];
        }
        renderizarRedes();


        // Empresa removida desta tela; nada a carregar aqui

        // V√≠nculos de empresa removidos: n√£o carregar
        vinculosEmpresas = [];

        // V√≠nculos: Pessoas vinculadas
        if (pessoa.vinculos && Array.isArray(pessoa.vinculos.pessoas)) {
          vinculosPessoas = pessoa.vinculos.pessoas.map(v => ({
            nome: String(v?.nome || ''),
            cpf: String(v?.cpf || ''),
            tipo: String(v?.tipo || ''),
          }));
        } else {
          vinculosPessoas = [];
        }
        renderizarVinculosPessoas();

        // Carrega v√≠nculos de entidades se existirem
        if (pessoa.vinculos && Array.isArray(pessoa.vinculos.entidades)) {
          vinculosEntidades = pessoa.vinculos.entidades.map(e => ({
            nome: String(e?.nome || ''),
            observacoes: String(e?.observacoes || ''),
          }));
        } else {
          vinculosEntidades = [];
        }
        renderizarVinculosEntidades();

        

        // Empresas vinculadas (IDs) se existirem
        if (pessoa.vinculos && Array.isArray(pessoa.vinculos.empresas)) {
          empresasVinculadas = pessoa.vinculos.empresas
            .map((entrada) => {
              const normalizado = normalizarVinculoEmpresa(entrada);
              const possuiDados = normalizado.id !== undefined || normalizado.nome || normalizado.observacoes;
              return possuiDados ? normalizado : null;
            })
            .filter(Boolean);
        } else {
          empresasVinculadas = [];
        }
        renderizarEmpresasVinculadasLista();

        // V√≠nculos empregat√≠cios
        if (pessoa.vinculos && Array.isArray(pessoa.vinculos.empregaticio)) {
          vinculosEmpregaticio = pessoa.vinculos.empregaticio.map(it => ({
            info: String(it?.info || ''),
          }));
        } else {
          vinculosEmpregaticio = [];
        }
        renderizarVinculosEmpregaticio();

        // Carrega ocorr√™ncias
        if (pessoa.ocorrencias) {
          ocorrenciasPoliciais = Array.isArray(pessoa.ocorrencias.policiais) ? JSON.parse(JSON.stringify(pessoa.ocorrencias.policiais)) : [];
          processos = Array.isArray(pessoa.ocorrencias.processos) ? JSON.parse(JSON.stringify(pessoa.ocorrencias.processos)) : [];
          abordagens = Array.isArray(pessoa.ocorrencias.abordagens) ? JSON.parse(JSON.stringify(pessoa.ocorrencias.abordagens)) : [];
          prisoes = Array.isArray(pessoa.ocorrencias.prisoes) ? JSON.parse(JSON.stringify(pessoa.ocorrencias.prisoes)) : [];
        } else {
          ocorrenciasPoliciais = [];
          processos = [];
          abordagens = [];
          prisoes = [];
        }
        renderizarOcorrenciasPoliciais();
        renderizarProcessos();
        renderizarAbordagens();
        renderizarPrisoes();

        // Carrega fotos existentes para manter a lista na edi√ß√£o
        carregarFotosExistentes(pessoa.fotos || pessoa.imagens || []);

        // Atualiza idade exibida ao carregar pessoa para edi√ß√£o
        atualizarIdade();
      };


      const atualizarRotuloSubmit = () => {
        submitButton.textContent = pessoaEmEdicao ? 'Salvar' : 'Incluir';
      };

      const renderizarLista = (pessoas = []) => {
        listaPessoasEl.innerHTML = '';

        if (!pessoas.length) {
          listaPessoasEl.innerHTML = '<div class="list__item">Nenhum registro encontrado.</div>';
          return;
        }

        // Cria tabela
        const table = document.createElement('table');
        table.style.width = '100%';
        table.style.borderCollapse = 'collapse';
        table.style.marginTop = '1rem';
        table.innerHTML = `
          <thead>
            <tr style="background: var(--surface-muted);">
              <th style="padding: 0.75rem; border: 1px solid var(--border); text-align: left;">Nome</th>
              <th style="padding: 0.75rem; border: 1px solid var(--border); text-align: left;">CPF</th>
              <th style="padding: 0.75rem; border: 1px solid var(--border); text-align: left;">M√£e</th>
              <th style="padding: 0.75rem; border: 1px solid var(--border); text-align: left;">√öltimo Endere√ßo</th>
              <th style="padding: 0.75rem; border: 1px solid var(--border); text-align: center;">A√ß√µes</th>
            </tr>
          </thead>
          <tbody></tbody>
        `;
        const tbody = table.querySelector('tbody');

        pessoas.forEach((pessoa) => {
          const tr = document.createElement('tr');
          tr.style.borderBottom = '1px solid var(--border)';

          // Nome
          const tdNome = document.createElement('td');
          tdNome.style.padding = '0.75rem';
          tdNome.textContent = pessoa.nomeCompleto || '';
          tr.appendChild(tdNome);

          // CPF
          const tdCpf = document.createElement('td');
          tdCpf.style.padding = '0.75rem';
          tdCpf.textContent = pessoa.cpf || '';
          tr.appendChild(tdCpf);

          // M√£e
          const tdMae = document.createElement('td');
          tdMae.style.padding = '0.75rem';
          tdMae.textContent = pessoa.nomeMae || '';
          tr.appendChild(tdMae);

          // √öltimo Endere√ßo
          const tdEndereco = document.createElement('td');
          tdEndereco.style.padding = '0.75rem';
          let ultimoEndereco = '';
          if (Array.isArray(pessoa.enderecos) && pessoa.enderecos.length > 0) {
            const idx = pessoa.endereco_atual_index !== undefined ? pessoa.endereco_atual_index : pessoa.enderecos.length - 1;
            const end = pessoa.enderecos[idx] || pessoa.enderecos[pessoa.enderecos.length - 1];
            if (end) {
              ultimoEndereco = `${end.logradouro || ''}, ${end.bairro || ''}, ${end.uf || ''}`;
            }
          }
          tdEndereco.textContent = ultimoEndereco;
          tr.appendChild(tdEndereco);

          // A√ß√µes
          const tdAcoes = document.createElement('td');
          tdAcoes.style.padding = '0.75rem';
          tdAcoes.style.display = 'flex';
          tdAcoes.style.gap = '0.5rem';
          tdAcoes.style.justifyContent = 'center';

          const editarBtn = document.createElement('button');
          editarBtn.type = 'button';
          editarBtn.className = 'button button--ghost';
          editarBtn.textContent = 'Editar';
          editarBtn.addEventListener('click', async () => {
            const id = pessoa.id || pessoa._id;
            if (!id) return;
            try {
              exibirMensagem('Carregando dados completos para edi√ß√£o...', 'info');
              const resp = await fetchAutenticado(`${API_PESSOAS_URL}/${id}`);
              const dados = await resp.json().catch(() => ({}));
              if (!resp.ok) {
                const msg = dados?.mensagem || dados?.message || 'N√£o foi poss√≠vel carregar os dados da pessoa.';
                throw new Error(msg);
              }
              const pessoaCompleta = dados?.data || dados;
              pessoaEmEdicao = pessoaCompleta.id || pessoaCompleta._id || id;
              preencherFormulario(pessoaCompleta);
              atualizarRotuloSubmit();
              exibirMensagem('Editando registro selecionado.', 'success');
            } catch (err) {
              exibirMensagem(err?.message || 'Erro ao carregar dados completos para edi√ß√£o.', 'error');
              // fallback: pelo menos preenche campos b√°sicos
              pessoaEmEdicao = id;
              preencherFormulario(pessoa);
              atualizarRotuloSubmit();
            }
          });

          const excluirBtn = document.createElement('button');
          excluirBtn.type = 'button';
          excluirBtn.className = 'button button--danger';
          excluirBtn.textContent = 'Excluir';
          excluirBtn.title = 'Excluir';
          excluirBtn.setAttribute('aria-label', 'Excluir');
          excluirBtn.addEventListener('click', async () => {
            if (!confirm('Deseja realmente excluir este registro?')) return;
            try {
              exibirMensagem('Removendo registro...', 'info');
              const response = await fetchAutenticado(`${API_PESSOAS_URL}/${pessoa.id || pessoa._id}`, {
                method: 'DELETE',
              });
              if (!response.ok) {
                const data = await response.json().catch(() => ({}));
                const erro = data?.mensagem || data?.message || 'Erro ao excluir o registro.';
                throw new Error(erro);
              }
              exibirMensagem('Pessoa exclu√≠da com sucesso!', 'success');
              alert('Pessoa exclu√≠da com sucesso!');
              carregarPessoas();
            } catch (error) {
              exibirMensagem(error?.message || 'N√£o foi poss√≠vel excluir o registro.', 'error');
            }
          });

          tdAcoes.appendChild(editarBtn);
          tdAcoes.appendChild(excluirBtn);
          tr.appendChild(tdAcoes);

          tbody.appendChild(tr);
        });

        listaPessoasEl.appendChild(table);
      };

      const carregarPessoas = async () => {
        try {
          exibirMensagem('Carregando pessoas cadastradas...', 'info');
          const response = await fetchAutenticado(API_PESSOAS_URL);
          const data = await response.json().catch(() => []);

          if (!response.ok) {
            const erro = data?.mensagem || data?.message || 'Erro ao buscar registros.';
            throw new Error(erro);
          }

          renderizarLista(Array.isArray(data) ? data : data?.data || []);
          if (ultimaAcaoFoiEdicao) {
            exibirMensagem('Altera√ß√£o realizada com sucesso!', 'success');
            ultimaAcaoFoiEdicao = false;
          } else {
            exibirMensagem('Lista atualizada.', 'success');
          }
        } catch (error) {
          exibirMensagem(error?.message || 'N√£o foi poss√≠vel carregar a lista.', 'error');
        }
      };

      // Carrega e exibe sempre os 10 registros mais recentes (por atualizadoEm/criadoEm)
      const carregarPessoasRecentes = async () => {
        try {
          exibirMensagem('Carregando √∫ltimos registros...', 'info');
          const response = await fetchAutenticado(API_PESSOAS_URL);
          const data = await response.json().catch(() => []);
          if (!response.ok) {
            const erro = data?.mensagem || data?.message || 'Erro ao buscar registros.';
            throw new Error(erro);
          }
          const lista = Array.isArray(data) ? data : data?.data || [];
          const ordenada = lista
            .slice()
            .sort((a, b) => new Date(b.atualizadoEm || b.criadoEm || 0) - new Date(a.atualizadoEm || a.criadoEm || 0))
            .slice(0, 10);
          renderizarLista(ordenada);
          exibirMensagem('Exibindo os 10 registros mais recentes.', 'success');
        } catch (error) {
          exibirMensagem(error?.message || 'N√£o foi poss√≠vel carregar a lista.', 'error');
        }
      };

      // Busca e preenche o formul√°rio com a pessoa da URL, incluindo fotos existentes
      const carregarPessoaInicial = async () => {
        const pessoaId = obterPessoaIdDaUrl();
        if (!pessoaId) return;

        try {
          // Feedback visual semelhante ao usado em carregarPessoasRecentes/exibirMensagemForm
          exibirMensagemForm('Carregando dados da pessoa...', 'info');

          const response = await fetchAutenticado(`${API_PESSOAS_URL}/${pessoaId}`);
          const data = await response.json().catch(() => ({}));
          if (!response.ok) {
            const erro = data?.mensagem || data?.message || 'N√£o foi poss√≠vel carregar os dados da pessoa.';
            throw new Error(erro);
          }

          const pessoa = data?.data || data;
          if (!pessoa || typeof pessoa !== 'object') {
            throw new Error('Registro n√£o encontrado para o identificador informado.');
          }

          preencherFormulario(pessoa); // Dispara renderiza√ß√£o e carregamento de fotos existentes
          pessoaEmEdicao = pessoa.id || pessoa._id || pessoaId;
          atualizarRotuloSubmit();
          exibirMensagemForm('Dados carregados para edi√ß√£o.', 'success');
        } catch (error) {
          exibirMensagemForm(error?.message || 'N√£o foi poss√≠vel carregar os dados da pessoa.', 'error');
        }
      };

      // Valida junto ao backend se as fotos foram gravadas e atualiza a galeria com o retorno oficial
      const validarFotosPersistidas = async (pessoaId, fotosEsperadas = []) => {
        if (!pessoaId) {
          // Coment√°rio: n√£o √© poss√≠vel validar sem um identificador v√°lido
          return [];
        }

        try {
          exibirMensagemForm('Validando fotos salvas...', 'info');

          const response = await fetchAutenticado(`${API_PESSOAS_URL}/${pessoaId}`);
          const data = await response.json().catch(() => ({}));

          if (!response.ok) {
            const erro = data?.mensagem || data?.message || 'Erro ao confirmar fotos salvas.';
            throw new Error(erro);
          }

          const fotosServidor = (data?.fotos || data?.imagens || []).filter(Boolean);
          const existemFotosServidor = Array.isArray(fotosServidor) && fotosServidor.length > 0;

          if (existemFotosServidor) {
            // Coment√°rio: loga um resumo para facilitar troubleshooting
            const resumoFotos = fotosServidor.map((foto, index) => ({
              id: foto?.id || foto?.url || foto,
              url: foto?.url || foto?.previewUrl || foto?.id || foto,
              ordem: index + 1,
            }));
            console.info('Resumo das fotos persistidas:', resumoFotos);

            carregarFotosExistentes(fotosServidor);
            exibirMensagemForm('Fotos confirmadas no servidor e galeria atualizada.', 'success');
          } else if (Array.isArray(fotosEsperadas) && fotosEsperadas.length > 0) {
            // Coment√°rio: informa claramente que as imagens n√£o foram encontradas ap√≥s o salvamento
            exibirMensagemForm(
              'Aten√ß√£o: as fotos n√£o foram localizadas ap√≥s salvar. Reenvie as imagens se necess√°rio.',
              'error'
            );
          } else {
            exibirMensagemForm('Nenhuma foto foi localizada para este cadastro.', 'warning');
          }

          return fotosServidor;
        } catch (error) {
          exibirMensagemForm(error?.message || 'Erro ao validar fotos salvas.', 'error');
          return [];
        }
      };

      const salvarPessoa = async (event) => {
        event.preventDefault();

        const payload = obterDadosFormulario();
        if (!payload.nomeCompleto?.trim()) {
          exibirMensagem('O campo Nome Completo √© obrigat√≥rio.', 'error');
          return;
        }

        // Valida CPF se preenchido
        if (payload.cpf?.trim()) {
          const validacao = validarCpf(payload.cpf);
          if (!validacao.valido) {
            exibirMensagem(validacao.mensagem, 'error');
            return;
          }
        }

        // Valida√ß√£o de S√≥cios removida (Empresa n√£o faz mais parte deste formul√°rio)

        // Valida CPFs dos v√≠nculos (pessoas)
        if (payload.vinculos && Array.isArray(payload.vinculos.pessoas)) {
          for (const v of payload.vinculos.pessoas) {
            const cpf = (v.cpf || '').trim();
            if (cpf) {
              const r = validarCpf(cpf);
              if (!r.valido) {
                exibirMensagemForm(`CPF de v√≠nculo inv√°lido: ${cpf}`, 'error');
                return;
              }
            }
          }
        }

        const metodo = pessoaEmEdicao ? 'PUT' : 'POST';
        const url = pessoaEmEdicao ? `${API_PESSOAS_URL}/${pessoaEmEdicao}` : API_PESSOAS_URL;

        try {
          exibirMensagemForm('Enviando dados...', 'info');
          submitButton.disabled = true;

          const hasFiles = Array.isArray(fotosSelecionadas) && fotosSelecionadas.some(f => !!f.file);
          const body = hasFiles ? montarFormDataEnvio(payload) : JSON.stringify(payload);

          const response = await fetchAutenticado(url, {
            method: metodo,
            body,
          });

          const data = await response.json().catch(() => ({}));
          if (!response.ok) {
            const erro = data?.mensagem || data?.message || 'Erro ao salvar os dados.';
            throw new Error(erro);
          }

          const foiEdicao = Boolean(pessoaEmEdicao);
          if (foiEdicao) {
            exibirMensagemForm('Atera√ß√µes realizadas com sucesso!', 'success');
            alert('Atera√ß√µes realizadas com sucesso!');
          } else {
            exibirMensagemForm('Pessoa cadastrada com sucesso!', 'success');
            alert('Pessoa cadastrada com sucesso!');
          }
          ultimaAcaoFoiEdicao = foiEdicao;

          // Mant√©m refer√™ncia das fotos devolvidas pelo backend para reaplicar ap√≥s o reset
          const fotosPersistidas = (data?.fotos || data?.imagens || []).filter(Boolean);
          const existeGaleriaPersistida = Array.isArray(fotosPersistidas) && fotosPersistidas.length > 0;

          // Identifica o ID da pessoa para validar posteriormente a galeria com um GET dedicado
          const pessoaIdResposta =
            data?.id || data?._id || data?.pessoa?.id || data?.pessoa?._id || pessoaEmEdicao || null;

          // Coment√°rio: exibe imediatamente no painel a pessoa retornada pela API, j√° com v√≠nculos e contatos preenchidos
          const pessoaRetornada = data?.pessoa || data?.data || data;
          if (pessoaRetornada && typeof pessoaRetornada === 'object') {
            const painel = document.getElementById('pessoas-panel');
            if (painel) painel.hidden = false;
            const listaRetorno = Array.isArray(pessoaRetornada)
              ? pessoaRetornada.filter(Boolean)
              : [pessoaRetornada];
            if (listaRetorno.length) {
              renderizarLista(listaRetorno);
            }
          }

          // O reset ocorre antes de reidratar a galeria para evitar que o listener limpe as fotos retornadas
          preservarFotosNoReset = existeGaleriaPersistida;
          pessoaForm.reset();

          // Atualiza visual das fotos com o que o servidor persistiu (se vier no response)
          if (existeGaleriaPersistida) {
            carregarFotosExistentes(fotosPersistidas);
          }

          // Ap√≥s salvar, confirma via GET que as fotos est√£o gravadas e reidrata a galeria com a vers√£o do banco
          if (pessoaIdResposta) {
            await validarFotosPersistidas(pessoaIdResposta, fotosPersistidas);
          } else if (existeGaleriaPersistida) {
            // Coment√°rio: mant√©m feedback claro caso o ID n√£o esteja dispon√≠vel para valida√ß√£o
            exibirMensagemForm('N√£o foi poss√≠vel validar as fotos porque o ID n√£o foi retornado.', 'warning');
          }

          // Define o ID retornado antes de atualizar o r√≥tulo, preservando o modo edi√ß√£o
          const novoId = data?.id || data?._id || data?.pessoa?.id || data?.pessoa?._id || pessoaEmEdicao;

          // Reseta estado de edi√ß√£o apenas quando n√£o houver ID conhecido
          pessoaEmEdicao = novoId || null;
          // Marca endere√ßos para exibir como link ap√≥s salvar
          try {
            if (Array.isArray(enderecos)) {
              enderecos = enderecos.map((e) => ({ ...e, mostrarLinkEndereco: true, mostrarLinkLatLong: true }));
              renderizarEnderecos();
            }
          } catch {}
          atualizarRotuloSubmit();
          // Atualiza lista se o painel estiver vis√≠vel
          if (!document.getElementById('pessoas-panel')?.hidden) {
            carregarPessoasRecentes();
          }
        } catch (error) {
          exibirMensagemForm(error?.message || 'N√£o foi poss√≠vel salvar o registro.', 'error');
        } finally {
          submitButton.disabled = false;
        }
      };

      const inicializarCadastro = () => {
        const token = obterToken();
        if (!token) {
          exibirMensagem('Sess√£o expirada. Fa√ßa login para continuar.', 'warning');
          setTimeout(() => {
            window.location.href = '/';
          }, 800);
          return;
        }

        atualizarRotuloSubmit();
        pessoaForm.addEventListener('submit', salvarPessoa);
        // Mant√©m o r√≥tulo do bot√£o sincronizado ao alterar qualquer campo
        pessoaForm.addEventListener('input', atualizarRotuloSubmit);
        listarButton.addEventListener('click', () => {
          const painel = document.getElementById('pessoas-panel');
          if (painel) painel.hidden = false;
          carregarPessoasRecentes();
        });
        pessoaForm.addEventListener('reset', () => {
          const devePreservarGaleria = preservarFotosNoReset && fotosSelecionadas.length > 0; // evita limpar fotos devolvidas pela API

          pessoaEmEdicao = null;
          atualizarRotuloSubmit();
          exibirMensagemForm('Formul√°rio limpo. Pronto para novo cadastro.', 'info');
          enderecos = [];
          indicadorEnderecoAtual = null;
          renderizarEnderecos();
          telefones = [];
          renderizarTelefones();
          emails = [];
          renderizarEmails();
          redes = [];
          renderizarRedes();
          fotosParaRemover = []; // Limpa registros de exclus√£o de imagens existentes
          if (!devePreservarGaleria) {
            fotosSelecionadas = [];
          }
          renderizarFotos(); // Mant√©m ou limpa a galeria conforme a flag de preserva√ß√£o
          preservarFotosNoReset = false; // Reseta a flag para os pr√≥ximos resets

          vinculosPessoas = [];
          renderizarVinculosPessoas();
          vinculosEmpresas = [];
          vinculosEntidades = [];
          renderizarVinculosEntidades();
          vinculosEmpregaticio = [];
          renderizarVinculosEmpregaticio();
          ocorrenciasPoliciais = [];
          renderizarOcorrenciasPoliciais();
          processos = [];
          renderizarProcessos();
          abordagens = [];
          renderizarAbordagens();
          prisoes = [];
          renderizarPrisoes();
        });
        cpfInput?.addEventListener('input', aplicarMascaraCpf);

        // Atualiza idade ao digitar/alterar data de nascimento
        const dobEl = pessoaForm?.elements['dataNascimento'];
        dobEl?.addEventListener('input', atualizarIdade);
        dobEl?.addEventListener('change', atualizarIdade);

        // Event listener para adicionar novo endere√ßo
        const adicionarEnderecoBtn = document.getElementById('adicionar-endereco');
        adicionarEnderecoBtn?.addEventListener('click', adicionarEndereco);

        // Event listener para adicionar novo telefone
        const adicionarTelefoneBtn = document.getElementById('adicionar-telefone');
        adicionarTelefoneBtn?.addEventListener('click', adicionarTelefone);

        // Event listeners para adicionar email e rede social
        const adicionarEmailBtn = document.getElementById('adicionar-email');
        adicionarEmailBtn?.addEventListener('click', adicionarEmail);
        const adicionarRedeBtn = document.getElementById('adicionar-rede');
        adicionarRedeBtn?.addEventListener('click', adicionarRede);

        // Event listener para upload de fotos
        fotosInput?.addEventListener('change', (event) => {
          adicionarFotos(event.target.files);
          event.target.value = '';
        });

        

        // Empresas vinculadas: busca por CNPJ e vincula√ß√£o m√∫ltipla
        const cnpjInput = document.getElementById('empresa-cnpj-input');
        cnpjInput?.addEventListener('input', (e) => {
          e.target.value = aplicarMascaraCnpj(e.target.value);
        });
        document.getElementById('empresa-buscar-cnpj')?.addEventListener('click', async () => {
          const statusEl = document.getElementById('empresa-vinculada-status');
          const cnpjVal = cnpjInput?.value || '';
          const valido = validarCnpjBasico(cnpjVal);
          if (!valido) {
            if (statusEl) statusEl.textContent = 'Informe um CNPJ completo (14 d√≠gitos).';
            renderizarResultadoBuscaEmpresa(null);
            return;
          }
          try {
            if (statusEl) statusEl.textContent = 'Buscando empresa...';
            if (!empresasOpcoes.length) {
              // Recarrega op√ß√µes apenas quando a lista ainda n√£o est√° dispon√≠vel
              await carregarEmpresasOpcoes();
            }
            const empresa = buscarEmpresaPorCnpj(cnpjVal);
            renderizarResultadoBuscaEmpresa(empresa);
            // Mensagem de status refor√ßando a possibilidade de cadastrar a empresa
            if (statusEl) statusEl.textContent = empresa ? 'Empresa encontrada.' : 'Empresa n√£o encontrada. Deseja cadastrar?';
          } catch (err) {
            if (statusEl) statusEl.textContent = 'Erro ao buscar empresa.';
          }
        });

        

        // Event listener para buscar e vincular pessoa existente usando nome ou CPF
        vinculoPessoaBuscaInput?.addEventListener('input', (event) => {
          // Coment√°rio: se o usu√°rio digitar apenas n√∫meros, aplicamos m√°scara b√°sica de CPF para facilitar a leitura
          const somenteDigitos = normalizarCpfSomenteDigitos(event.target.value);
          if (somenteDigitos) {
            event.target.value = aplicarMascaraCpfInline(somenteDigitos);
          }
        });

        buscarVinculoPessoaBtn?.addEventListener('click', buscarPessoaParaVinculo);
        vinculoPessoaBuscaInput?.addEventListener('keydown', (event) => {
          // Coment√°rio: permite acionar a busca ao pressionar Enter no campo de entrada
          if (event.key === 'Enter') {
            event.preventDefault();
            buscarPessoaParaVinculo();
          }
        });

        // Event listener para adicionar v√≠nculo empresa
        // Removido: bot√£o e a√ß√£o de v√≠nculo de empresa

        // Event listener para adicionar v√≠nculo entidade
        const addVincEntBtn = document.getElementById('adicionar-vinculo-entidade');
        addVincEntBtn?.addEventListener('click', adicionarVinculoEntidade);

        

        // Event listener para adicionar v√≠nculo empregat√≠cio
        const addVincEmpregBtn = document.getElementById('adicionar-vinculo-empregaticio');
        addVincEmpregBtn?.addEventListener('click', adicionarVinculoEmpregaticio);

        // Event listeners para Ocorr√™ncias
        const addOccPolBtn = document.getElementById('adicionar-ocorrencia-policial');
        addOccPolBtn?.addEventListener('click', adicionarOcorrenciaPolicial);
        const addProcBtn = document.getElementById('adicionar-processo');
        addProcBtn?.addEventListener('click', adicionarProcesso);
        const addAbordBtn = document.getElementById('adicionar-abordagem');
        addAbordBtn?.addEventListener('click', adicionarAbordagem);
        const addPrisaoBtn = document.getElementById('adicionar-prisao');
        addPrisaoBtn?.addEventListener('click', adicionarPrisao);

        

        renderizarTelefones();
        renderizarEmails();
        renderizarRedes();
        
        renderizarFotos();
        // Carrega op√ß√µes de empresas para v√≠nculo
        carregarEmpresasOpcoes();
        renderizarVinculosPessoas();
        // V√≠nculo de empresas removido: n√£o renderizar
        renderizarVinculosEntidades();
        
        renderizarVinculosEmpregaticio();
        renderizarOcorrenciasPoliciais();
        renderizarProcessos();
        renderizarAbordagens();
        renderizarPrisoes();
        // Lista fica oculta at√© o usu√°rio clicar em "Listar"

        // Preenche automaticamente se houver pessoaId na URL
        carregarPessoaInicial();
      };

      document.addEventListener('DOMContentLoaded', inicializarCadastro);

      // Calcula idade atual com base em yyyy-mm-dd
      function calcularIdadeDe(dataStr) {
        if (!dataStr) return null;
        const parts = String(dataStr).split('-');
        if (parts.length !== 3) return null;
        const ano = parseInt(parts[0], 10);
        const mes = parseInt(parts[1], 10) - 1; // 0-11
        const dia = parseInt(parts[2], 10);
        if ([ano, mes, dia].some((n) => Number.isNaN(n))) return null;
        const hoje = new Date();
        let idade = hoje.getFullYear() - ano;
        const aindaNaoFezAniversario = (hoje.getMonth() < mes) || (hoje.getMonth() === mes && hoje.getDate() < dia);
        if (aindaNaoFezAniversario) idade -= 1;
        return idade >= 0 ? idade : 0;
      }

      function atualizarIdade() {
        const dobEl = pessoaForm?.elements['dataNascimento'];
        const idadeEl = document.getElementById('idade');
        if (!dobEl || !idadeEl) return;
        const idade = calcularIdadeDe(dobEl.value);
        if (idade == null) {
          idadeEl.value = '';
        } else {
          idadeEl.value = String(idade);
        }
      }
    </script>
  </body>
</html>
