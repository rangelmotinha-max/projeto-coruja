<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cadastro de Pessoas | Projeto Coruja</title>
    <link rel="stylesheet" href="/css/main.css" />
  </head>
  <body class="theme-dark">
    <div class="app">
      <div class="user-menu" id="user-menu" aria-expanded="false">
        <button class="user-menu__button" type="button" id="user-menu-button" aria-haspopup="true" aria-expanded="false">
          <span class="user-menu__avatar" id="user-avatar" aria-hidden="true">U</span>
          <span id="user-button-name">Usu√°rio</span>
        </button>
        <div class="user-menu__dropdown" id="user-menu-dropdown" role="menu" aria-label="Menu do usu√°rio">
          <div class="user-menu__item"><span class="user-menu__label">Nome Completo:</span><span class="user-menu__value" id="um-nome">‚Äî</span></div>
          <div class="user-menu__item"><span class="user-menu__label">Email:</span><span class="user-menu__value" id="um-email">‚Äî</span></div>
          <div class="user-menu__item"><span class="user-menu__label">Perfil:</span><span class="user-menu__value" id="um-perfil">‚Äî</span></div>
          <div class="user-menu__separator"></div>
          <div class="user-menu__item"><span class="user-menu__label">Senha:</span><span class="user-menu__link" id="um-alterar-senha">Alterar senha</span></div>
          <div class="user-menu__separator"></div>
          <div class="user-menu__item"><span class="user-menu__link" id="um-sair">Sair</span></div>
        </div>
      </div>
      <aside class="sidebar">
        <div class="sidebar__header">
          <div class="sidebar__brand">Projeto Coruja</div>
          <!-- Bot√£o dedicado para alternar entre tema claro e escuro -->
          <button
            class="theme-toggle"
            type="button"
            data-theme-toggle
            aria-pressed="false"
            aria-label="Alternar tema visual"
          >
            <span class="theme-toggle__icon" aria-hidden="true" data-theme-icon>üåô</span>
            <span class="theme-toggle__label" data-theme-label>Modo escuro</span>
          </button>
        </div>
        <nav class="sidebar__nav" aria-label="Menu principal">
          <a class="sidebar__link" href="/home">Home</a>
          <a class="sidebar__link" href="/usuarios">Usu√°rios</a>
          <details class="sidebar__section sidebar__section--active" open>
            <summary class="sidebar__link sidebar__link--parent" aria-label="Abrir menu Cadastro">Cadastro</summary>
            <div class="sidebar__subnav">
              <a class="sidebar__link sidebar__link--child sidebar__link--active" href="/cadastro/pessoas">Pessoas</a>
              <a class="sidebar__link sidebar__link--child" href="/cadastro/empresas">Empresas</a>
            </div>
          </details>
        </nav>
        <div class="sidebar__footer">
          <button id="logout-button" class="sidebar__logout" type="button">Sair</button>
        </div>
      </aside>

      <main class="content" data-page="cadastro-pessoas">
        <header class="content__header">
          <p class="content__eyebrow">Cadastro</p>          
        </header>

        <section class="panel" aria-label="Formul√°rio de dados de pessoas">
          <div class="panel__header panel__header--stacked">
          </div>

          <form class="form" id="pessoa-form" action="#" method="post">
            <!-- Se√ß√£o 1: Identifica√ß√£o -->
            <div class="form__section">
              <div class="form__section-header">
                <h3 class="form__section-title" style="text-align: center; width: 100%;">Identifica√ß√£o</h3>
              </div>
              <div class="form__grid form__grid--1">
                <label class="form__field">
                  <span class="form__label">Nome Completo</span>
                  <input class="form__input" type="text" name="nomeCompleto" required />
                </label>
                <label class="form__field">
                  <span class="form__label">CPF</span>
                  <input class="form__input" type="text" name="cpf" inputmode="numeric" />
                  <span id="erro-cpf" class="form__error" style="display: none;">CPF inv√°lido!</span>
                </label>
                <label class="form__field">
                  <span class="form__label">RG</span>
                  <input class="form__input" type="text" name="rg" inputmode="numeric" />
                </label>
                <label class="form__field">
                  <span class="form__label">CNH</span>
                  <input class="form__input" type="text" name="cnh" inputmode="numeric" />
                </label>
                <label class="form__field">
                  <span class="form__label">Data de Nascimento</span>
                  <input class="form__input" type="date" name="dataNascimento" />
                </label>
                <label class="form__field">
                  <span class="form__label">Nome da M√£e</span>
                  <input class="form__input" type="text" name="nomeMae" />
                </label>
                <label class="form__field">
                  <span class="form__label">Nome do Pai</span>
                  <input class="form__input" type="text" name="nomePai" />
                </label>
              </div>
            </div>

            <!-- Se√ß√£o 2: Contatos -->
            <div class="form__section">
              <div class="form__section-header">
                <h3 class="form__section-title" style="text-align: center; width: 100%;">Contatos</h3>
              </div>

              <!-- Sub-se√ß√£o: Telefone -->
              <div class="form__subsection">
                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 0.5rem;">
                  <h4 class="form__section-title" style="font-size: 1rem; margin: 0; text-align: left; width: 100%;">Telefone</h4>
                  <button class="button button--secondary" id="adicionar-telefone" type="button" aria-label="Adicionar telefone" title="Adicionar">+</button>
                </div>
                <div id="lista-telefones" style="display: flex; flex-direction: column; gap: 0.5rem;"></div>
              </div>

              <!-- Sub-se√ß√£o: Emails -->
              <div class="form__subsection">
                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%; margin: 0.75rem 0;">
                  <h4 class="form__section-title" style="font-size: 1rem; margin: 0; text-align: left; width: 100%;">Email</h4>
                  <button class="button button--secondary" id="adicionar-email" type="button" aria-label="Adicionar email" title="Adicionar">+</button>
                </div>
                <div id="lista-emails" style="display: flex; flex-direction: column; gap: 0.5rem;"></div>
              </div>

              <!-- Sub-se√ß√£o: Redes Sociais (linha abaixo) -->
              <div class="form__subsection">
                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%; margin: 0.75rem 0;">
                  <h4 class="form__section-title" style="font-size: 1rem; margin: 0; text-align: left; width: 100%;">Redes Sociais</h4>
                  <button class="button button--secondary" id="adicionar-rede" type="button" aria-label="Adicionar rede social" title="Adicionar">+</button>
                </div>
                <div id="lista-redes" style="display: flex; flex-direction: column; gap: 0.5rem;"></div>
              </div>
            </div>

            <!-- Se√ß√£o 3: Endere√ßos -->
            <div class="form__section">
              <div class="form__section-header">
                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                  <h3 class="form__section-title" style="text-align: center; width: 100%;">Endere√ßos</h3>
                  <button class="button button--secondary" id="adicionar-endereco" type="button" aria-label="Adicionar endere√ßo" title="Adicionar">+</button>
                </div>
              </div>
              <div id="lista-enderecos" class="enderecos-lista"></div>
            </div>

            <div class="form__actions">
              <button class="button button--secondary" type="reset">Limpar</button>
              <button class="button button--ghost" id="listar-pessoas" type="button">Listar</button>
              <button class="button button--primary" id="submit-pessoa" type="submit">Incluir</button>
            </div>
          </form>
        </section>

        <section class="panel" aria-label="Lista de pessoas cadastradas" id="pessoas-panel" hidden>
          <div class="panel__header panel__header--stacked">
            <div>
              <h2 class="panel__title">Lista de pessoas cadastradas</h2>
            </div>
          </div>

          <div id="pessoas-message" class="message" role="status" aria-live="polite"></div>

          <ul id="pessoas-lista" class="list" aria-live="polite"></ul>
        </section>
      </main>
    </div>

    <script src="/js/main.js"></script>
    <div id="alterar-senha-modal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="alterar-senha-title">
      <div class="modal__overlay" data-modal-close></div>
      <div class="modal__panel modal__panel--sm" role="document">
        <button class="modal__close" id="alterar-senha-close" aria-label="Fechar">√ó</button>
        <h3 id="alterar-senha-title">Alterar senha</h3>
        <form id="alterar-senha-form" class="form" novalidate>
          <label class="form__field">
            <span class="form__label">Senha atual</span>
            <input class="form__input" type="password" id="senha-atual" required />
          </label>
          <label class="form__field">
            <span class="form__label">Nova senha</span>
            <input class="form__input" type="password" id="senha-nova" required />
          </label>
          <div class="form__actions">
            <button type="button" class="button button--ghost" id="alterar-senha-cancelar">Cancelar</button>
            <button type="submit" class="button button--primary" id="alterar-senha-submit">Alterar</button>
          </div>
        </form>
      </div>
    </div>
    <script>
      const API_PESSOAS_URL = '/api/pessoas';
      const pessoaForm = document.getElementById('pessoa-form');
      const submitButton = document.getElementById('submit-pessoa');
      const listarButton = document.getElementById('listar-pessoas');
      const listaPessoasEl = document.getElementById('pessoas-lista');
      const messageEl = document.getElementById('pessoas-message');
      const cpfInput = pessoaForm?.elements['cpf'];
      let pessoaEmEdicao = null;
      let ultimaAcaoFoiEdicao = false;

      const getCookie = (name) => {
        return document.cookie
          .split(';')
          .map((c) => c.trim())
          .find((c) => c.startsWith(`${name}=`))
          ?.split('=')[1];
      };

      const obterToken = () => localStorage.getItem('authToken') || getCookie('authToken');

      const fetchAutenticado = (url, options = {}) => {
        const token = obterToken();
        const headers = {
          'Content-Type': 'application/json',
          ...(options.headers || {}),
          ...(token ? { Authorization: `Bearer ${token}` } : {}),
        };

        return fetch(url, { ...options, headers });
      };

      const exibirMensagem = (texto, tipo = 'info') => {
        if (!messageEl) return;
        messageEl.textContent = texto || '';
        messageEl.className = 'message';
        if (texto) messageEl.classList.add(`message--${tipo}`);
      };

      const obterDadosFormulario = () => {
        const formData = new FormData(pessoaForm);
        const dados = Object.fromEntries(formData.entries());
        
        // Adiciona os endere√ßos m√∫ltiplos ao payload
        dados.enderecos = enderecos;
        dados.endereco_atual_index = indicadorEnderecoAtual;
        
        // Adiciona os telefones m√∫ltiplos ao payload
        dados.telefones = telefones.filter(tel => tel.trim() !== '');
        // Adiciona emails e redes sociais m√∫ltiplos ao payload
        dados.emails = emails.filter(e => e.trim() !== '');
        dados.redesSociais = redes.filter(r => r.trim() !== '');
        
        return dados;
      };

      const aplicarMascaraCpf = (event) => {
        // Garante que apenas n√∫meros sejam digitados e aplica a m√°scara padr√£o de CPF
        const somenteNumeros = event.target.value.replace(/\D/g, '').slice(0, 11);

        let valorMascarado = somenteNumeros;
        if (somenteNumeros.length > 3) {
          valorMascarado = `${somenteNumeros.slice(0, 3)}.${somenteNumeros.slice(3, 6)}`;
        }
        if (somenteNumeros.length > 6) {
          valorMascarado = `${valorMascarado}.${somenteNumeros.slice(6, 9)}`;
        }
        if (somenteNumeros.length > 9) {
          valorMascarado = `${valorMascarado}-${somenteNumeros.slice(9, 11)}`;
        }

        event.target.value = valorMascarado;

        // Valida CPF em tempo real quando completo (11 d√≠gitos)
        const erroEl = document.getElementById('erro-cpf');
        if (somenteNumeros.length === 11) {
          const validacao = validarCpf(valorMascarado);
          if (!validacao.valido) {
            erroEl.style.display = 'block';
            erroEl.textContent = 'CPF inv√°lido!';
          } else {
            erroEl.style.display = 'none';
          }
        } else if (somenteNumeros.length > 0) {
          // Mostra erro se n√£o est√° completo e o usu√°rio parou de digitar
          erroEl.style.display = 'none';
        }
      };

      const validarCpf = (cpf) => {
        // Remove caracteres n√£o num√©ricos
        const somenteNumeros = cpf.replace(/\D/g, '');

        // Valida comprimento
        if (somenteNumeros.length !== 11) {
          return { valido: false, mensagem: 'CPF deve ter 11 d√≠gitos.' };
        }

        // Valida se todos os d√≠gitos s√£o iguais
        if (/^(\d)\1{10}$/.test(somenteNumeros)) {
          return { valido: false, mensagem: 'CPF inv√°lido: todos os d√≠gitos s√£o iguais.' };
        }

        // Calcula primeiro d√≠gito verificador
        let soma = 0;
        for (let i = 0; i < 9; i++) {
          soma += parseInt(somenteNumeros[i]) * (10 - i);
        }
        let primeiroDigito = 11 - (soma % 11);
        primeiroDigito = primeiroDigito > 9 ? 0 : primeiroDigito;

        // Valida primeiro d√≠gito verificador
        if (parseInt(somenteNumeros[9]) !== primeiroDigito) {
          return { valido: false, mensagem: 'CPF inv√°lido: primeiro d√≠gito verificador incorreto.' };
        }

        // Calcula segundo d√≠gito verificador
        soma = 0;
        for (let i = 0; i < 10; i++) {
          soma += parseInt(somenteNumeros[i]) * (11 - i);
        }
        let segundoDigito = 11 - (soma % 11);
        segundoDigito = segundoDigito > 9 ? 0 : segundoDigito;

        // Valida segundo d√≠gito verificador
        if (parseInt(somenteNumeros[10]) !== segundoDigito) {
          return { valido: false, mensagem: 'CPF inv√°lido: segundo d√≠gito verificador incorreto.' };
        }

        return { valido: true, mensagem: 'CPF v√°lido.' };
      };

      let enderecos = [];
      let indicadorEnderecoAtual = null;
      let telefones = [];
      let emails = [];
      let redes = [];

      const renderizarTelefones = () => {
        const listaTelefonesEl = document.getElementById('lista-telefones');
        listaTelefonesEl.innerHTML = '';

        if (telefones.length === 0) {
          listaTelefonesEl.innerHTML = '<p style="color: var(--muted); font-size: 0.85rem; margin: 0;">Nenhum telefone adicionado. Clique para adicionar.</p>';
          return;
        }

        telefones.forEach((telefone, indice) => {
          const divTelefone = document.createElement('div');
          divTelefone.style.display = 'flex';
          divTelefone.style.gap = '0.5rem';
          divTelefone.style.alignItems = 'center';

          const inputTelefone = document.createElement('input');
          inputTelefone.type = 'tel';
          inputTelefone.className = 'form__input';
          inputTelefone.inputMode = 'tel';
          inputTelefone.value = telefone;
          inputTelefone.placeholder = '(XX) XXXXX-XXXX';
          inputTelefone.addEventListener('input', (e) => {
            telefones[indice] = e.target.value;
          });
          divTelefone.appendChild(inputTelefone);

          const btnRemover = document.createElement('button');
          btnRemover.type = 'button';
          btnRemover.className = 'button button--danger';
          btnRemover.textContent = '‚àí';
          btnRemover.setAttribute('aria-label', 'Remover telefone');
          btnRemover.title = 'Excluir';
          btnRemover.style.padding = '0.25rem 0.5rem';
          btnRemover.style.fontSize = '0.75rem';
          btnRemover.style.minWidth = 'fit-content';
          btnRemover.addEventListener('click', () => {
            telefones.splice(indice, 1);
            renderizarTelefones();
          });
          divTelefone.appendChild(btnRemover);

          listaTelefonesEl.appendChild(divTelefone);
        });
      };

      const adicionarTelefone = () => {
        telefones.push('');
        renderizarTelefones();
      };

      const renderizarEmails = () => {
        const listaEmailsEl = document.getElementById('lista-emails');
        if (!listaEmailsEl) return;
        listaEmailsEl.innerHTML = '';

        if (emails.length === 0) {
          listaEmailsEl.innerHTML = '<p style="color: var(--muted); font-size: 0.85rem; margin: 0;">Nenhum email adicionado. Clique para adicionar.</p>';
          return;
        }

        emails.forEach((email, indice) => {
          const linha = document.createElement('div');
          linha.style.display = 'flex';
          linha.style.gap = '0.5rem';
          linha.style.alignItems = 'center';

          const input = document.createElement('input');
          input.type = 'email';
          input.className = 'form__input';
          input.value = email;
          input.placeholder = 'seuemail@exemplo.com';
          input.addEventListener('input', (e) => {
            emails[indice] = e.target.value;
          });
          linha.appendChild(input);

          const btnRemover = document.createElement('button');
          btnRemover.type = 'button';
          btnRemover.className = 'button button--danger';
          btnRemover.textContent = '‚àí';
          btnRemover.setAttribute('aria-label', 'Remover email');
          btnRemover.title = 'Excluir';
          btnRemover.style.padding = '0.25rem 0.5rem';
          btnRemover.style.fontSize = '0.75rem';
          btnRemover.style.minWidth = 'fit-content';
          btnRemover.addEventListener('click', () => {
            emails.splice(indice, 1);
            renderizarEmails();
          });
          linha.appendChild(btnRemover);

          listaEmailsEl.appendChild(linha);
        });
      };

      const adicionarEmail = () => {
        emails.push('');
        renderizarEmails();
      };

      const renderizarRedes = () => {
        const listaRedesEl = document.getElementById('lista-redes');
        if (!listaRedesEl) return;
        listaRedesEl.innerHTML = '';

        if (redes.length === 0) {
          listaRedesEl.innerHTML = '<p style="color: var(--muted); font-size: 0.85rem; margin: 0;">Nenhuma rede adicionada. Clique para adicionar.</p>';
          return;
        }

        redes.forEach((rede, indice) => {
          const linha = document.createElement('div');
          linha.style.display = 'flex';
          linha.style.gap = '0.5rem';
          linha.style.alignItems = 'center';

          const partes = String(rede).split('|');
          const valorTipo = (partes[0] || '').trim();
          const valorPerfil = (partes[1] || '').trim();

          const select = document.createElement('select');
          select.className = 'form__input';
          select.style.maxWidth = '12rem';
          select.innerHTML = `
            <option value="">Selecione</option>
            <option value="instagram">Instagram</option>
            <option value="facebook">Facebook</option>
            <option value="linkedin">LinkedIn</option>
            <option value="twitter">Twitter / X</option>
            <option value="youtube">YouTube</option>
            <option value="tiktok">TikTok</option>
            <option value="github">GitHub</option>
            <option value="website">Website</option>
            <option value="outro">Outro</option>
          `;
          select.value = valorTipo;
          linha.appendChild(select);

          const input = document.createElement('input');
          input.type = 'text';
          input.className = 'form__input';
          input.placeholder = 'URL ou @usuario';
          input.value = valorPerfil;
          input.style.flex = '1';
          linha.appendChild(input);

          const atualizarValor = () => {
            const tipo = select.value || '';
            const perfil = input.value || '';
            redes[indice] = `${tipo}|${perfil}`;
          };

          select.addEventListener('change', atualizarValor);
          input.addEventListener('input', atualizarValor);

          const btnRemover = document.createElement('button');
          btnRemover.type = 'button';
          btnRemover.className = 'button button--danger';
          btnRemover.textContent = '‚àí';
          btnRemover.setAttribute('aria-label', 'Remover rede social');
          btnRemover.title = 'Excluir';
          btnRemover.style.padding = '0.25rem 0.5rem';
          btnRemover.style.fontSize = '0.75rem';
          btnRemover.style.minWidth = 'fit-content';
          btnRemover.addEventListener('click', () => {
            redes.splice(indice, 1);
            renderizarRedes();
          });
          linha.appendChild(btnRemover);

          listaRedesEl.appendChild(linha);
        });
      };

      const adicionarRede = () => {
        redes.push('|');
        renderizarRedes();
      };

      const createEstadosSelect = () => {
        return `<option value="">Selecione</option>
                    <option value="AC">Acre (AC)</option>
                    <option value="AL">Alagoas (AL)</option>
                    <option value="AP">Amap√° (AP)</option>
                    <option value="AM">Amazonas (AM)</option>
                    <option value="BA">Bahia (BA)</option>
                    <option value="CE">Cear√° (CE)</option>
                    <option value="DF">Distrito Federal (DF)</option>
                    <option value="ES">Esp√≠rito Santo (ES)</option>
                    <option value="GO">Goi√°s (GO)</option>
                    <option value="MA">Maranh√£o (MA)</option>
                    <option value="MT">Mato Grosso (MT)</option>
                    <option value="MS">Mato Grosso do Sul (MS)</option>
                    <option value="MG">Minas Gerais (MG)</option>
                    <option value="PA">Par√° (PA)</option>
                    <option value="PB">Para√≠ba (PB)</option>
                    <option value="PR">Paran√° (PR)</option>
                    <option value="PE">Pernambuco (PE)</option>
                    <option value="PI">Piau√≠ (PI)</option>
                    <option value="RJ">Rio de Janeiro (RJ)</option>
                    <option value="RN">Rio Grande do Norte (RN)</option>
                    <option value="RS">Rio Grande do Sul (RS)</option>
                    <option value="RO">Rond√¥nia (RO)</option>
                    <option value="RR">Roraima (RR)</option>
                    <option value="SC">Santa Catarina (SC)</option>
                    <option value="SP">S√£o Paulo (SP)</option>
                    <option value="SE">Sergipe (SE)</option>
                    <option value="TO">Tocantins (TO)</option>`;
      };

      const renderizarEnderecos = () => {
        const listaEl = document.getElementById('lista-enderecos');
        listaEl.innerHTML = '';

        if (enderecos.length === 0) {
          listaEl.innerHTML = '<p style="color: var(--muted); margin: 1rem 0;">Nenhum endere√ßo adicionado. Clique no bot√£o para adicionar um.</p>';
          return;
        }

        // Garante que o endere√ßo atual seja exibido primeiro na lista renderizada
        const ordemEnderecos = indicadorEnderecoAtual === null
          ? enderecos.map((_, indice) => indice)
          : [indicadorEnderecoAtual, ...enderecos.map((_, indice) => indice).filter((indice) => indice !== indicadorEnderecoAtual)];

        ordemEnderecos.forEach((indiceOrdenado, posicao) => {
          const endereco = enderecos[indiceOrdenado];
          const div = document.createElement('div');
          div.className = 'endereco-item';
          div.style.cssText = 'border: 1px solid var(--border); border-radius: 0.5rem; padding: 1.5rem; margin-bottom: 1rem; background: var(--surface-muted);';

          const headerDiv = document.createElement('div');
          headerDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;';

          const titleSpan = document.createElement('span');
          titleSpan.style.cssText = 'font-weight: 600; color: var(--text);';
          titleSpan.textContent = `Endere√ßo ${posicao + 1}${indicadorEnderecoAtual === indiceOrdenado ? ' (Atual)' : ''}`;

          const actionsDiv = document.createElement('div');
          actionsDiv.style.cssText = 'display: flex; gap: 0.5rem;';

          if (enderecos.length > 1 && indicadorEnderecoAtual !== indiceOrdenado) {
            const setarAtualBtn = document.createElement('button');
            setarAtualBtn.type = 'button';
            setarAtualBtn.className = 'button button--secondary';
            setarAtualBtn.textContent = 'Definir como Atual';
            setarAtualBtn.style.cssText = 'padding: 0.5rem 1rem; font-size: 0.875rem;';
            setarAtualBtn.addEventListener('click', () => {
              indicadorEnderecoAtual = indiceOrdenado;
              renderizarEnderecos();
            });
            actionsDiv.appendChild(setarAtualBtn);
          }

          const removerBtn = document.createElement('button');
          removerBtn.type = 'button';
          removerBtn.className = 'button button--danger';
          removerBtn.textContent = '‚àí';
          removerBtn.setAttribute('aria-label', 'Remover endere√ßo');
          removerBtn.title = 'Excluir';
          removerBtn.style.cssText = 'padding: 0.25rem 0.5rem; font-size: 0.75rem; min-width: fit-content;';
          removerBtn.addEventListener('click', () => {
            enderecos.splice(indiceOrdenado, 1);
            if (indicadorEnderecoAtual === indiceOrdenado) {
              indicadorEnderecoAtual = enderecos.length > 0 ? 0 : null;
            } else if (indicadorEnderecoAtual > indiceOrdenado) {
              indicadorEnderecoAtual--;
            }
            renderizarEnderecos();
          });
          actionsDiv.appendChild(removerBtn);

          headerDiv.appendChild(titleSpan);
          headerDiv.appendChild(actionsDiv);
          div.appendChild(headerDiv);

          // Criar campos do endere√ßo
          const gridDiv = document.createElement('div');
          gridDiv.className = 'form__grid form__grid--4';
          gridDiv.innerHTML = `
            <label class="form__field">
              <span class="form__label">UF</span>
              <select class="form__input endereco-uf" data-index="${indiceOrdenado}">
                ${createEstadosSelect()}
              </select>
            </label>
            <label class="form__field form__field--wide">
              <span class="form__label">Logradouro/Nome</span>
              <input class="form__input endereco-logradouro" type="text" data-index="${indiceOrdenado}" />
            </label>
            <label class="form__field">
              <span class="form__label">Bairro/Cidade</span>
              <input class="form__input endereco-bairro" type="text" data-index="${indiceOrdenado}" />
            </label>
            <label class="form__field">
              <span class="form__label">CEP</span>
              <input class="form__input endereco-cep" type="text" inputmode="numeric" data-index="${indiceOrdenado}" />
            </label>
            <label class="form__field">
              <span class="form__label">Complemento</span>
              <input class="form__input endereco-complemento" type="text" data-index="${indiceOrdenado}" />
            </label>
          `;

          // Preencher valores salvos para manter sincronia com o formul√°rio
          gridDiv.querySelector('.endereco-uf').value = endereco.uf || '';
          gridDiv.querySelector('.endereco-logradouro').value = endereco.logradouro || '';
          gridDiv.querySelector('.endereco-bairro').value = endereco.bairro || '';
          gridDiv.querySelector('.endereco-cep').value = endereco.cep || '';
          gridDiv.querySelector('.endereco-complemento').value = endereco.complemento || '';

          // Adicionar listeners
          gridDiv.querySelector('.endereco-uf').addEventListener('change', (e) => {
            enderecos[indiceOrdenado].uf = e.target.value;
          });
          gridDiv.querySelector('.endereco-logradouro').addEventListener('input', (e) => {
            enderecos[indiceOrdenado].logradouro = e.target.value;
          });
          gridDiv.querySelector('.endereco-bairro').addEventListener('input', (e) => {
            enderecos[indiceOrdenado].bairro = e.target.value;
          });
          gridDiv.querySelector('.endereco-complemento').addEventListener('input', (e) => {
            enderecos[indiceOrdenado].complemento = e.target.value;
          });
          const cepInput = gridDiv.querySelector('.endereco-cep');
          cepInput.addEventListener('blur', (e) => {
            if (e.target.value?.trim()) {
              mostrarCarregamentoCep(indiceOrdenado, true);
              buscarEnderecoPorCepMultiplo(e.target.value, indiceOrdenado);
            }
          });

          div.appendChild(gridDiv);

          // Adiciona elemento para exibir status de carregamento
          const statusDiv = document.createElement('div');
          statusDiv.className = `cep-status-${indiceOrdenado}`;
          statusDiv.style.cssText = 'margin-top: 0.75rem; font-size: 0.85rem; display: none;';
          div.appendChild(statusDiv);

          listaEl.appendChild(div);
        });
      };

      const adicionarEndereco = () => {
        enderecos.push({
          uf: '',
          logradouro: '',
          bairro: '',
          cep: '',
          complemento: ''
        });

        if (indicadorEnderecoAtual === null && enderecos.length === 1) {
          indicadorEnderecoAtual = 0;
        }

        renderizarEnderecos();
      };

      const buscarEnderecoPorCepMultiplo = async (cep, index) => {
        const somenteNumeros = cep.replace(/\D/g, '');

        if (somenteNumeros.length !== 8) {
          mostrarCarregamentoCep(index, false);
          return;
        }

        try {
          const response = await fetch(`https://viacep.com.br/ws/${somenteNumeros}/json/`);
          const data = await response.json();

          if (data.erro) {
            exibirStatusCep(index, 'CEP n√£o encontrado', 'error');
          } else {
            enderecos[index].uf = data.uf || '';
            enderecos[index].logradouro = data.logradouro || '';
            enderecos[index].bairro = `${data.bairro || ''} ${data.localidade || ''}`.trim();
            enderecos[index].cep = somenteNumeros;
            renderizarEnderecos();
            exibirStatusCep(index, 'Endere√ßo carregado com sucesso', 'success');
          }
        } catch (error) {
          exibirStatusCep(index, 'Erro ao buscar CEP', 'error');
          console.error('Erro ao buscar CEP:', error);
        } finally {
          mostrarCarregamentoCep(index, false);
        }
      };

      const mostrarCarregamentoCep = (index, mostrando) => {
        const statusEl = document.querySelector(`.cep-status-${index}`);
        if (!statusEl) return;

        if (mostrando) {
          statusEl.innerHTML = `
            <div style="display: flex; align-items: center; gap: 0.5rem; color: var(--primary);">
              <div class="spinner" style="width: 16px; height: 16px; border: 2px solid var(--primary); border-top: 2px solid transparent; border-radius: 50%; animation: spin 0.6s linear infinite;"></div>
              <span>Carregando endere√ßo...</span>
            </div>
          `;
          statusEl.style.display = 'block';
        } else {
          statusEl.style.display = 'none';
        }
      };

      const exibirStatusCep = (index, mensagem, tipo) => {
        const statusEl = document.querySelector(`.cep-status-${index}`);
        if (!statusEl) return;

        const cores = {
          success: 'var(--success-text)',
          error: 'var(--error-text)'
        };

        statusEl.innerHTML = `
          <div style="display: flex; align-items: center; gap: 0.5rem; color: ${cores[tipo] || 'var(--text)'};">
            <span>${tipo === 'success' ? '‚úì' : '‚úï'}</span>
            <span>${mensagem}</span>
          </div>
        `;
        statusEl.style.display = 'block';

        // Auto-hide depois de 3 segundos
        setTimeout(() => {
          if (statusEl.style.display !== 'none') {
            statusEl.style.display = 'none';
          }
        }, 3000);
      };

      const preencherFormulario = (pessoa) => {
        Object.entries(pessoa).forEach(([chave, valor]) => {
          if (pessoaForm.elements[chave]) {
            pessoaForm.elements[chave].value = valor || '';
          }
        });

        // Carrega endere√ßos se existirem
        if (pessoa.enderecos && Array.isArray(pessoa.enderecos)) {
          enderecos = JSON.parse(JSON.stringify(pessoa.enderecos));
          indicadorEnderecoAtual = pessoa.endereco_atual_index !== undefined ? pessoa.endereco_atual_index : 0;
          renderizarEnderecos();
        } else {
          enderecos = [];
          indicadorEnderecoAtual = null;
          renderizarEnderecos();
        }

        // Carrega telefones se existirem
        if (pessoa.telefones && Array.isArray(pessoa.telefones)) {
          telefones = JSON.parse(JSON.stringify(pessoa.telefones));
        } else {
          telefones = [];
        }
        renderizarTelefones();

        // Carrega emails se existirem
        if (pessoa.emails && Array.isArray(pessoa.emails)) {
          emails = JSON.parse(JSON.stringify(pessoa.emails));
        } else {
          emails = [];
        }
        renderizarEmails();

        // Carrega redes sociais se existirem
        if (pessoa.redesSociais && Array.isArray(pessoa.redesSociais)) {
          redes = JSON.parse(JSON.stringify(pessoa.redesSociais));
        } else {
          redes = [];
        }
        renderizarRedes();
      };


      const atualizarRotuloSubmit = () => {
        submitButton.textContent = pessoaEmEdicao ? 'Salvar' : 'Incluir';
      };

      const renderizarLista = (pessoas = []) => {
        listaPessoasEl.innerHTML = '';

        if (!pessoas.length) {
          listaPessoasEl.innerHTML = '<div class="list__item">Nenhum registro encontrado.</div>';
          return;
        }

        // Cria tabela
        const table = document.createElement('table');
        table.style.width = '100%';
        table.style.borderCollapse = 'collapse';
        table.style.marginTop = '1rem';
        table.innerHTML = `
          <thead>
            <tr style="background: var(--surface-muted);">
              <th style="padding: 0.75rem; border: 1px solid var(--border); text-align: left;">Nome</th>
              <th style="padding: 0.75rem; border: 1px solid var(--border); text-align: left;">CPF</th>
              <th style="padding: 0.75rem; border: 1px solid var(--border); text-align: left;">M√£e</th>
              <th style="padding: 0.75rem; border: 1px solid var(--border); text-align: left;">√öltimo Endere√ßo</th>
              <th style="padding: 0.75rem; border: 1px solid var(--border); text-align: center;">A√ß√µes</th>
            </tr>
          </thead>
          <tbody></tbody>
        `;
        const tbody = table.querySelector('tbody');

        pessoas.forEach((pessoa) => {
          const tr = document.createElement('tr');
          tr.style.borderBottom = '1px solid var(--border)';

          // Nome
          const tdNome = document.createElement('td');
          tdNome.style.padding = '0.75rem';
          tdNome.textContent = pessoa.nomeCompleto || '';
          tr.appendChild(tdNome);

          // CPF
          const tdCpf = document.createElement('td');
          tdCpf.style.padding = '0.75rem';
          tdCpf.textContent = pessoa.cpf || '';
          tr.appendChild(tdCpf);

          // M√£e
          const tdMae = document.createElement('td');
          tdMae.style.padding = '0.75rem';
          tdMae.textContent = pessoa.nomeMae || '';
          tr.appendChild(tdMae);

          // √öltimo Endere√ßo
          const tdEndereco = document.createElement('td');
          tdEndereco.style.padding = '0.75rem';
          let ultimoEndereco = '';
          if (Array.isArray(pessoa.enderecos) && pessoa.enderecos.length > 0) {
            const idx = pessoa.endereco_atual_index !== undefined ? pessoa.endereco_atual_index : pessoa.enderecos.length - 1;
            const end = pessoa.enderecos[idx] || pessoa.enderecos[pessoa.enderecos.length - 1];
            if (end) {
              ultimoEndereco = `${end.logradouro || ''}, ${end.bairro || ''}, ${end.uf || ''}`;
            }
          }
          tdEndereco.textContent = ultimoEndereco;
          tr.appendChild(tdEndereco);

          // A√ß√µes
          const tdAcoes = document.createElement('td');
          tdAcoes.style.padding = '0.75rem';
          tdAcoes.style.display = 'flex';
          tdAcoes.style.gap = '0.5rem';
          tdAcoes.style.justifyContent = 'center';

          const editarBtn = document.createElement('button');
          editarBtn.type = 'button';
          editarBtn.className = 'button button--ghost';
          editarBtn.textContent = 'Editar';
          editarBtn.addEventListener('click', () => {
            pessoaEmEdicao = pessoa.id || pessoa._id;
            preencherFormulario(pessoa);
            atualizarRotuloSubmit();
            exibirMensagem('Editando registro selecionado.', 'info');
          });

          const excluirBtn = document.createElement('button');
          excluirBtn.type = 'button';
          excluirBtn.className = 'button button--danger';
          excluirBtn.textContent = 'Excluir';
          excluirBtn.title = 'Excluir';
          excluirBtn.setAttribute('aria-label', 'Excluir');
          excluirBtn.addEventListener('click', async () => {
            if (!confirm('Deseja realmente excluir este registro?')) return;
            try {
              exibirMensagem('Removendo registro...', 'info');
              const response = await fetchAutenticado(`${API_PESSOAS_URL}/${pessoa.id || pessoa._id}`, {
                method: 'DELETE',
              });
              if (!response.ok) {
                const data = await response.json().catch(() => ({}));
                const erro = data?.mensagem || data?.message || 'Erro ao excluir o registro.';
                throw new Error(erro);
              }
              exibirMensagem('Registro exclu√≠do com sucesso.', 'success');
              carregarPessoas();
            } catch (error) {
              exibirMensagem(error?.message || 'N√£o foi poss√≠vel excluir o registro.', 'error');
            }
          });

          tdAcoes.appendChild(editarBtn);
          tdAcoes.appendChild(excluirBtn);
          tr.appendChild(tdAcoes);

          tbody.appendChild(tr);
        });

        listaPessoasEl.appendChild(table);
      };

      const carregarPessoas = async () => {
        try {
          exibirMensagem('Carregando pessoas cadastradas...', 'info');
          const response = await fetchAutenticado(API_PESSOAS_URL);
          const data = await response.json().catch(() => []);

          if (!response.ok) {
            const erro = data?.mensagem || data?.message || 'Erro ao buscar registros.';
            throw new Error(erro);
          }

          renderizarLista(Array.isArray(data) ? data : data?.data || []);
          if (ultimaAcaoFoiEdicao) {
            exibirMensagem('Altera√ß√£o realizada com sucesso!', 'success');
            ultimaAcaoFoiEdicao = false;
          } else {
            exibirMensagem('Lista atualizada.', 'success');
          }
        } catch (error) {
          exibirMensagem(error?.message || 'N√£o foi poss√≠vel carregar a lista.', 'error');
        }
      };

      // Carrega e exibe sempre os 10 registros mais recentes (por atualizadoEm/criadoEm)
      const carregarPessoasRecentes = async () => {
        try {
          exibirMensagem('Carregando √∫ltimos registros...', 'info');
          const response = await fetchAutenticado(API_PESSOAS_URL);
          const data = await response.json().catch(() => []);
          if (!response.ok) {
            const erro = data?.mensagem || data?.message || 'Erro ao buscar registros.';
            throw new Error(erro);
          }
          const lista = Array.isArray(data) ? data : data?.data || [];
          const ordenada = lista
            .slice()
            .sort((a, b) => new Date(b.atualizadoEm || b.criadoEm || 0) - new Date(a.atualizadoEm || a.criadoEm || 0))
            .slice(0, 10);
          renderizarLista(ordenada);
          exibirMensagem('Exibindo os 10 registros mais recentes.', 'success');
        } catch (error) {
          exibirMensagem(error?.message || 'N√£o foi poss√≠vel carregar a lista.', 'error');
        }
      };

      const salvarPessoa = async (event) => {
        event.preventDefault();

        const payload = obterDadosFormulario();
        if (!payload.nomeCompleto?.trim()) {
          exibirMensagem('O campo Nome Completo √© obrigat√≥rio.', 'error');
          return;
        }

        // Valida CPF se preenchido
        if (payload.cpf?.trim()) {
          const validacao = validarCpf(payload.cpf);
          if (!validacao.valido) {
            exibirMensagem(validacao.mensagem, 'error');
            return;
          }
        }

        const metodo = pessoaEmEdicao ? 'PUT' : 'POST';
        const url = pessoaEmEdicao ? `${API_PESSOAS_URL}/${pessoaEmEdicao}` : API_PESSOAS_URL;

        try {
          exibirMensagem('Enviando dados...', 'info');
          submitButton.disabled = true;

          const response = await fetchAutenticado(url, {
            method: metodo,
            body: JSON.stringify(payload),
          });

          const data = await response.json().catch(() => ({}));
          if (!response.ok) {
            const erro = data?.mensagem || data?.message || 'Erro ao salvar os dados.';
            throw new Error(erro);
          }

          const foiEdicao = Boolean(pessoaEmEdicao);
          exibirMensagem(foiEdicao ? 'Altera√ß√£o realizada com sucesso!' : 'Registro inclu√≠do com sucesso!', 'success');
          ultimaAcaoFoiEdicao = foiEdicao;
          pessoaForm.reset();
          pessoaEmEdicao = null;
          atualizarRotuloSubmit();
          carregarPessoas();
        } catch (error) {
          exibirMensagem(error?.message || 'N√£o foi poss√≠vel salvar o registro.', 'error');
        } finally {
          submitButton.disabled = false;
        }
      };

      const inicializarCadastro = () => {
        const token = obterToken();
        if (!token) {
          exibirMensagem('Sess√£o expirada. Fa√ßa login para continuar.', 'warning');
          setTimeout(() => {
            window.location.href = '/';
          }, 800);
          return;
        }

        atualizarRotuloSubmit();
        pessoaForm.addEventListener('submit', salvarPessoa);
        listarButton.addEventListener('click', () => {
          const painel = document.getElementById('pessoas-panel');
          if (painel) painel.hidden = false;
          carregarPessoasRecentes();
        });
        pessoaForm.addEventListener('reset', () => {
          pessoaEmEdicao = null;
          atualizarRotuloSubmit();
          exibirMensagem('Formul√°rio limpo. Pronto para novo cadastro.', 'info');
          enderecos = [];
          indicadorEnderecoAtual = null;
          renderizarEnderecos();
          telefones = [];
          renderizarTelefones();
          emails = [];
          renderizarEmails();
          redes = [];
          renderizarRedes();
        });
        cpfInput?.addEventListener('input', aplicarMascaraCpf);

        // Event listener para adicionar novo endere√ßo
        const adicionarEnderecoBtn = document.getElementById('adicionar-endereco');
        adicionarEnderecoBtn?.addEventListener('click', adicionarEndereco);

        // Event listener para adicionar novo telefone
        const adicionarTelefoneBtn = document.getElementById('adicionar-telefone');
        adicionarTelefoneBtn?.addEventListener('click', adicionarTelefone);

        // Event listeners para adicionar email e rede social
        const adicionarEmailBtn = document.getElementById('adicionar-email');
        adicionarEmailBtn?.addEventListener('click', adicionarEmail);
        const adicionarRedeBtn = document.getElementById('adicionar-rede');
        adicionarRedeBtn?.addEventListener('click', adicionarRede);

        renderizarTelefones();
        renderizarEmails();
        renderizarRedes();
        // Lista fica oculta at√© o usu√°rio clicar em "Listar"
      };

      document.addEventListener('DOMContentLoaded', inicializarCadastro);
    </script>
  </body>
</html>
