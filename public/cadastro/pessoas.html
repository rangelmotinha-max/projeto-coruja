<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cadastro de Pessoas | Projeto Coruja</title>
    <link rel="stylesheet" href="/css/main.css" />
  </head>
  <body class="theme-dark">
    <div class="app">
      <aside class="sidebar">
        <div class="sidebar__header">
          <div class="sidebar__brand">Projeto Coruja</div>
          <!-- Bot√£o dedicado para alternar entre tema claro e escuro -->
          <button
            class="theme-toggle"
            type="button"
            data-theme-toggle
            aria-pressed="false"
            aria-label="Alternar tema visual"
          >
            <span class="theme-toggle__icon" aria-hidden="true" data-theme-icon>üåô</span>
            <span class="theme-toggle__label" data-theme-label>Modo escuro</span>
          </button>
        </div>
        <nav class="sidebar__nav" aria-label="Menu principal">
          <a class="sidebar__link" href="/home">Home</a>
          <a class="sidebar__link" href="/perfil">Perfil de Usu√°rio</a>
          <a class="sidebar__link" href="/usuarios">Usu√°rios</a>
          <details class="sidebar__section sidebar__section--active" open>
            <summary class="sidebar__link sidebar__link--parent" aria-label="Abrir menu Cadastro">Cadastro</summary>
            <div class="sidebar__subnav">
              <a class="sidebar__link sidebar__link--child sidebar__link--active" href="/cadastro/pessoas">Pessoas</a>
              <a class="sidebar__link sidebar__link--child" href="/cadastro/empresas">Empresas</a>
            </div>
          </details>
        </nav>
        <div class="sidebar__footer">
          <button id="logout-button" class="sidebar__logout" type="button">Sair</button>
        </div>
      </aside>

      <main class="content" data-page="cadastro-pessoas">
        <header class="content__header">
          <p class="content__eyebrow">Cadastro</p>          
        </header>

        <section class="panel" aria-label="Formul√°rio de dados de pessoas">
          <div class="panel__header panel__header--stacked">
          </div>

          <form class="form" id="pessoa-form" action="#" method="post">
            <div class="form__section">
              <div class="form__section-header">
                <h3 class="form__section-title">Identifica√ß√£o</h3>
              </div>
              <div class="form__grid form__grid--2">
                <label class="form__field">
                  <span class="form__label">Nome Completo</span>
                  <input class="form__input" type="text" name="nomeCompleto" required />
                </label>
                <label class="form__field">
                  <span class="form__label">Data de Nascimento</span>
                  <input class="form__input" type="date" name="dataNascimento" />
                </label>
              </div>
              <div class="form__grid form__grid--3">
                <label class="form__field">
                  <span class="form__label">CPF</span>
                  <input class="form__input" type="text" name="cpf" inputmode="numeric" />
                  <span id="erro-cpf" class="form__error" style="display: none;">CPF inv√°lido!</span>
                </label>
                <label class="form__field">
                  <span class="form__label">RG</span>
                  <input class="form__input" type="text" name="rg" inputmode="numeric" />
                </label>
                <label class="form__field">
                  <span class="form__label">CNH</span>
                  <input class="form__input" type="text" name="cnh" inputmode="numeric" />
                </label>
              </div>
            </div>

            <div class="form__section">
              <div class="form__section-header">
                <h3 class="form__section-title">Contato e filia√ß√£o</h3>
              </div>
              <div class="form__grid form__grid--3">
                <label class="form__field">
                  <span class="form__label">Nome da M√£e</span>
                  <input class="form__input" type="text" name="nomeMae" />
                </label>
                <label class="form__field">
                  <span class="form__label">Nome do Pai</span>
                  <input class="form__input" type="text" name="nomePai" />
                </label>
                <label class="form__field">
                  <span class="form__label">Telefone</span>
                  <input class="form__input" type="tel" name="telefone" inputmode="tel" />
                </label>
              </div>
            </div>

            <div class="form__section">
              <div class="form__section-header">
                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                  <h3 class="form__section-title">Endere√ßos</h3>
                  <button class="button button--secondary" id="adicionar-endereco" type="button">+ Adicionar endere√ßo</button>
                </div>
              </div>
              <div id="lista-enderecos" class="enderecos-lista"></div>
            </div>

            <div class="form__actions">
              <button class="button button--secondary" type="reset">Limpar</button>
              <button class="button button--ghost" id="listar-pessoas" type="button">Listar</button>
              <button class="button button--primary" id="submit-pessoa" type="submit">Salvar dados</button>
            </div>
          </form>
        </section>

        <section class="panel" aria-label="Lista de pessoas cadastradas">
          <div class="panel__header panel__header--stacked">
            <div>
              <h2 class="panel__title">Lista de pessoas cadastradas</h2>
              <p class="panel__meta">Gerencie as edi√ß√µes ou exclus√µes diretamente na listagem</p>
            </div>
          </div>

          <div id="pessoas-message" class="message" role="status" aria-live="polite"></div>

          <ul id="pessoas-lista" class="list" aria-live="polite"></ul>
        </section>
      </main>
    </div>

    <script src="/js/main.js"></script>
    <script>
      const API_PESSOAS_URL = '/api/pessoas';
      const pessoaForm = document.getElementById('pessoa-form');
      const submitButton = document.getElementById('submit-pessoa');
      const listarButton = document.getElementById('listar-pessoas');
      const listaPessoasEl = document.getElementById('pessoas-lista');
      const messageEl = document.getElementById('pessoas-message');
      const cpfInput = pessoaForm?.elements['cpf'];
      let pessoaEmEdicao = null;

      const obterToken = () => localStorage.getItem('authToken');

      const fetchAutenticado = (url, options = {}) => {
        const token = obterToken();
        const headers = {
          'Content-Type': 'application/json',
          ...(options.headers || {}),
          ...(token ? { Authorization: `Bearer ${token}` } : {}),
        };

        return fetch(url, { ...options, headers });
      };

      const exibirMensagem = (texto, tipo = 'info') => {
        if (!messageEl) return;
        messageEl.textContent = texto || '';
        messageEl.className = 'message';
        if (texto) messageEl.classList.add(`message--${tipo}`);
      };

      const obterDadosFormulario = () => {
        const formData = new FormData(pessoaForm);
        const dados = Object.fromEntries(formData.entries());
        
        // Adiciona os endere√ßos m√∫ltiplos ao payload
        dados.enderecos = enderecos;
        dados.endereco_atual_index = indicadorEnderecoAtual;
        
        return dados;
      };

      const aplicarMascaraCpf = (event) => {
        // Garante que apenas n√∫meros sejam digitados e aplica a m√°scara padr√£o de CPF
        const somenteNumeros = event.target.value.replace(/\D/g, '').slice(0, 11);

        let valorMascarado = somenteNumeros;
        if (somenteNumeros.length > 3) {
          valorMascarado = `${somenteNumeros.slice(0, 3)}.${somenteNumeros.slice(3, 6)}`;
        }
        if (somenteNumeros.length > 6) {
          valorMascarado = `${valorMascarado}.${somenteNumeros.slice(6, 9)}`;
        }
        if (somenteNumeros.length > 9) {
          valorMascarado = `${valorMascarado}-${somenteNumeros.slice(9, 11)}`;
        }

        event.target.value = valorMascarado;

        // Valida CPF em tempo real quando completo (11 d√≠gitos)
        const erroEl = document.getElementById('erro-cpf');
        if (somenteNumeros.length === 11) {
          const validacao = validarCpf(valorMascarado);
          if (!validacao.valido) {
            erroEl.style.display = 'block';
            erroEl.textContent = 'CPF inv√°lido!';
          } else {
            erroEl.style.display = 'none';
          }
        } else if (somenteNumeros.length > 0) {
          // Mostra erro se n√£o est√° completo e o usu√°rio parou de digitar
          erroEl.style.display = 'none';
        }
      };

      const validarCpf = (cpf) => {
        // Remove caracteres n√£o num√©ricos
        const somenteNumeros = cpf.replace(/\D/g, '');

        // Valida comprimento
        if (somenteNumeros.length !== 11) {
          return { valido: false, mensagem: 'CPF deve ter 11 d√≠gitos.' };
        }

        // Valida se todos os d√≠gitos s√£o iguais
        if (/^(\d)\1{10}$/.test(somenteNumeros)) {
          return { valido: false, mensagem: 'CPF inv√°lido: todos os d√≠gitos s√£o iguais.' };
        }

        // Calcula primeiro d√≠gito verificador
        let soma = 0;
        for (let i = 0; i < 9; i++) {
          soma += parseInt(somenteNumeros[i]) * (10 - i);
        }
        let primeiroDigito = 11 - (soma % 11);
        primeiroDigito = primeiroDigito > 9 ? 0 : primeiroDigito;

        // Valida primeiro d√≠gito verificador
        if (parseInt(somenteNumeros[9]) !== primeiroDigito) {
          return { valido: false, mensagem: 'CPF inv√°lido: primeiro d√≠gito verificador incorreto.' };
        }

        // Calcula segundo d√≠gito verificador
        soma = 0;
        for (let i = 0; i < 10; i++) {
          soma += parseInt(somenteNumeros[i]) * (11 - i);
        }
        let segundoDigito = 11 - (soma % 11);
        segundoDigito = segundoDigito > 9 ? 0 : segundoDigito;

        // Valida segundo d√≠gito verificador
        if (parseInt(somenteNumeros[10]) !== segundoDigito) {
          return { valido: false, mensagem: 'CPF inv√°lido: segundo d√≠gito verificador incorreto.' };
        }

        return { valido: true, mensagem: 'CPF v√°lido.' };
      };

      let enderecos = [];
      let indicadorEnderecoAtual = null;

      const createEstadosSelect = () => {
        return `<option value="">Selecione</option>
                    <option value="AC">Acre (AC)</option>
                    <option value="AL">Alagoas (AL)</option>
                    <option value="AP">Amap√° (AP)</option>
                    <option value="AM">Amazonas (AM)</option>
                    <option value="BA">Bahia (BA)</option>
                    <option value="CE">Cear√° (CE)</option>
                    <option value="DF">Distrito Federal (DF)</option>
                    <option value="ES">Esp√≠rito Santo (ES)</option>
                    <option value="GO">Goi√°s (GO)</option>
                    <option value="MA">Maranh√£o (MA)</option>
                    <option value="MT">Mato Grosso (MT)</option>
                    <option value="MS">Mato Grosso do Sul (MS)</option>
                    <option value="MG">Minas Gerais (MG)</option>
                    <option value="PA">Par√° (PA)</option>
                    <option value="PB">Para√≠ba (PB)</option>
                    <option value="PR">Paran√° (PR)</option>
                    <option value="PE">Pernambuco (PE)</option>
                    <option value="PI">Piau√≠ (PI)</option>
                    <option value="RJ">Rio de Janeiro (RJ)</option>
                    <option value="RN">Rio Grande do Norte (RN)</option>
                    <option value="RS">Rio Grande do Sul (RS)</option>
                    <option value="RO">Rond√¥nia (RO)</option>
                    <option value="RR">Roraima (RR)</option>
                    <option value="SC">Santa Catarina (SC)</option>
                    <option value="SP">S√£o Paulo (SP)</option>
                    <option value="SE">Sergipe (SE)</option>
                    <option value="TO">Tocantins (TO)</option>`;
      };

      const renderizarEnderecos = () => {
        const listaEl = document.getElementById('lista-enderecos');
        listaEl.innerHTML = '';

        if (enderecos.length === 0) {
          listaEl.innerHTML = '<p style="color: var(--muted); margin: 1rem 0;">Nenhum endere√ßo adicionado. Clique no bot√£o para adicionar um.</p>';
          return;
        }

        // Garante que o endere√ßo atual seja exibido primeiro na lista renderizada
        const ordemEnderecos = indicadorEnderecoAtual === null
          ? enderecos.map((_, indice) => indice)
          : [indicadorEnderecoAtual, ...enderecos.map((_, indice) => indice).filter((indice) => indice !== indicadorEnderecoAtual)];

        ordemEnderecos.forEach((indiceOrdenado, posicao) => {
          const endereco = enderecos[indiceOrdenado];
          const div = document.createElement('div');
          div.className = 'endereco-item';
          div.style.cssText = 'border: 1px solid var(--border); border-radius: 0.5rem; padding: 1.5rem; margin-bottom: 1rem; background: var(--surface-muted);';

          const headerDiv = document.createElement('div');
          headerDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;';

          const titleSpan = document.createElement('span');
          titleSpan.style.cssText = 'font-weight: 600; color: var(--text);';
          titleSpan.textContent = `Endere√ßo ${posicao + 1}${indicadorEnderecoAtual === indiceOrdenado ? ' (Atual)' : ''}`;

          const actionsDiv = document.createElement('div');
          actionsDiv.style.cssText = 'display: flex; gap: 0.5rem;';

          if (enderecos.length > 1 && indicadorEnderecoAtual !== indiceOrdenado) {
            const setarAtualBtn = document.createElement('button');
            setarAtualBtn.type = 'button';
            setarAtualBtn.className = 'button button--secondary';
            setarAtualBtn.textContent = 'Definir como Atual';
            setarAtualBtn.style.cssText = 'padding: 0.5rem 1rem; font-size: 0.875rem;';
            setarAtualBtn.addEventListener('click', () => {
              indicadorEnderecoAtual = indiceOrdenado;
              renderizarEnderecos();
            });
            actionsDiv.appendChild(setarAtualBtn);
          }

          const removerBtn = document.createElement('button');
          removerBtn.type = 'button';
          removerBtn.className = 'button button--danger';
          removerBtn.textContent = 'Remover';
          removerBtn.style.cssText = 'padding: 0.5rem 1rem; font-size: 0.875rem;';
          removerBtn.addEventListener('click', () => {
            enderecos.splice(indiceOrdenado, 1);
            if (indicadorEnderecoAtual === indiceOrdenado) {
              indicadorEnderecoAtual = enderecos.length > 0 ? 0 : null;
            } else if (indicadorEnderecoAtual > indiceOrdenado) {
              indicadorEnderecoAtual--;
            }
            renderizarEnderecos();
          });
          actionsDiv.appendChild(removerBtn);

          headerDiv.appendChild(titleSpan);
          headerDiv.appendChild(actionsDiv);
          div.appendChild(headerDiv);

          // Criar campos do endere√ßo
          const gridDiv = document.createElement('div');
          gridDiv.className = 'form__grid form__grid--4';
          gridDiv.innerHTML = `
            <label class="form__field">
              <span class="form__label">UF</span>
              <select class="form__input endereco-uf" data-index="${indiceOrdenado}">
                ${createEstadosSelect()}
              </select>
            </label>
            <label class="form__field form__field--wide">
              <span class="form__label">Logradouro/Nome</span>
              <input class="form__input endereco-logradouro" type="text" data-index="${indiceOrdenado}" />
            </label>
            <label class="form__field">
              <span class="form__label">Bairro/Cidade</span>
              <input class="form__input endereco-bairro" type="text" data-index="${indiceOrdenado}" />
            </label>
            <label class="form__field">
              <span class="form__label">CEP</span>
              <input class="form__input endereco-cep" type="text" inputmode="numeric" data-index="${indiceOrdenado}" />
            </label>
            <label class="form__field">
              <span class="form__label">Complemento</span>
              <input class="form__input endereco-complemento" type="text" data-index="${indiceOrdenado}" />
            </label>
          `;

          // Preencher valores salvos para manter sincronia com o formul√°rio
          gridDiv.querySelector('.endereco-uf').value = endereco.uf || '';
          gridDiv.querySelector('.endereco-logradouro').value = endereco.logradouro || '';
          gridDiv.querySelector('.endereco-bairro').value = endereco.bairro || '';
          gridDiv.querySelector('.endereco-cep').value = endereco.cep || '';
          gridDiv.querySelector('.endereco-complemento').value = endereco.complemento || '';

          // Adicionar listeners
          gridDiv.querySelector('.endereco-uf').addEventListener('change', (e) => {
            enderecos[indiceOrdenado].uf = e.target.value;
          });
          gridDiv.querySelector('.endereco-logradouro').addEventListener('input', (e) => {
            enderecos[indiceOrdenado].logradouro = e.target.value;
          });
          gridDiv.querySelector('.endereco-bairro').addEventListener('input', (e) => {
            enderecos[indiceOrdenado].bairro = e.target.value;
          });
          gridDiv.querySelector('.endereco-complemento').addEventListener('input', (e) => {
            enderecos[indiceOrdenado].complemento = e.target.value;
          });
          const cepInput = gridDiv.querySelector('.endereco-cep');
          cepInput.addEventListener('blur', (e) => {
            if (e.target.value?.trim()) {
              mostrarCarregamentoCep(indiceOrdenado, true);
              buscarEnderecoPorCepMultiplo(e.target.value, indiceOrdenado);
            }
          });

          div.appendChild(gridDiv);

          // Adiciona elemento para exibir status de carregamento
          const statusDiv = document.createElement('div');
          statusDiv.className = `cep-status-${indiceOrdenado}`;
          statusDiv.style.cssText = 'margin-top: 0.75rem; font-size: 0.85rem; display: none;';
          div.appendChild(statusDiv);

          listaEl.appendChild(div);
        });
      };

      const adicionarEndereco = () => {
        enderecos.push({
          uf: '',
          logradouro: '',
          bairro: '',
          cep: '',
          complemento: ''
        });

        if (indicadorEnderecoAtual === null && enderecos.length === 1) {
          indicadorEnderecoAtual = 0;
        }

        renderizarEnderecos();
      };

      const buscarEnderecoPorCepMultiplo = async (cep, index) => {
        const somenteNumeros = cep.replace(/\D/g, '');

        if (somenteNumeros.length !== 8) {
          mostrarCarregamentoCep(index, false);
          return;
        }

        try {
          const response = await fetch(`https://viacep.com.br/ws/${somenteNumeros}/json/`);
          const data = await response.json();

          if (data.erro) {
            exibirStatusCep(index, 'CEP n√£o encontrado', 'error');
          } else {
            enderecos[index].uf = data.uf || '';
            enderecos[index].logradouro = data.logradouro || '';
            enderecos[index].bairro = `${data.bairro || ''} ${data.localidade || ''}`.trim();
            enderecos[index].cep = somenteNumeros;
            renderizarEnderecos();
            exibirStatusCep(index, 'Endere√ßo carregado com sucesso', 'success');
          }
        } catch (error) {
          exibirStatusCep(index, 'Erro ao buscar CEP', 'error');
          console.error('Erro ao buscar CEP:', error);
        } finally {
          mostrarCarregamentoCep(index, false);
        }
      };

      const mostrarCarregamentoCep = (index, mostrando) => {
        const statusEl = document.querySelector(`.cep-status-${index}`);
        if (!statusEl) return;

        if (mostrando) {
          statusEl.innerHTML = `
            <div style="display: flex; align-items: center; gap: 0.5rem; color: var(--primary);">
              <div class="spinner" style="width: 16px; height: 16px; border: 2px solid var(--primary); border-top: 2px solid transparent; border-radius: 50%; animation: spin 0.6s linear infinite;"></div>
              <span>Carregando endere√ßo...</span>
            </div>
          `;
          statusEl.style.display = 'block';
        } else {
          statusEl.style.display = 'none';
        }
      };

      const exibirStatusCep = (index, mensagem, tipo) => {
        const statusEl = document.querySelector(`.cep-status-${index}`);
        if (!statusEl) return;

        const cores = {
          success: 'var(--success-text)',
          error: 'var(--error-text)'
        };

        statusEl.innerHTML = `
          <div style="display: flex; align-items: center; gap: 0.5rem; color: ${cores[tipo] || 'var(--text)'};">
            <span>${tipo === 'success' ? '‚úì' : '‚úï'}</span>
            <span>${mensagem}</span>
          </div>
        `;
        statusEl.style.display = 'block';

        // Auto-hide depois de 3 segundos
        setTimeout(() => {
          if (statusEl.style.display !== 'none') {
            statusEl.style.display = 'none';
          }
        }, 3000);
      };

      const preencherFormulario = (pessoa) => {
        Object.entries(pessoa).forEach(([chave, valor]) => {
          if (pessoaForm.elements[chave]) {
            pessoaForm.elements[chave].value = valor || '';
          }
        });

        // Carrega endere√ßos se existirem
        if (pessoa.enderecos && Array.isArray(pessoa.enderecos)) {
          enderecos = JSON.parse(JSON.stringify(pessoa.enderecos));
          indicadorEnderecoAtual = pessoa.endereco_atual_index !== undefined ? pessoa.endereco_atual_index : 0;
          renderizarEnderecos();
        } else {
          enderecos = [];
          indicadorEnderecoAtual = null;
          renderizarEnderecos();
        }
      };


      const atualizarRotuloSubmit = () => {
        submitButton.textContent = pessoaEmEdicao ? 'Atualizar dados' : 'Salvar dados';
      };

      const renderizarLista = (pessoas = []) => {
        listaPessoasEl.innerHTML = '';

        if (!pessoas.length) {
          listaPessoasEl.innerHTML = '<li class="list__item">Nenhum registro encontrado.</li>';
          return;
        }

        pessoas.forEach((pessoa) => {
          const item = document.createElement('li');
          item.className = 'list__item';

          const titulo = document.createElement('p');
          titulo.className = 'list__title';
          titulo.textContent = pessoa.nomeCompleto || 'Pessoa sem nome';
          item.appendChild(titulo);

          const actions = document.createElement('div');
          actions.className = 'list__actions';

          const editarBtn = document.createElement('button');
          editarBtn.type = 'button';
          editarBtn.className = 'button button--ghost';
          editarBtn.textContent = 'Editar';
          editarBtn.addEventListener('click', () => {
            pessoaEmEdicao = pessoa.id || pessoa._id;
            preencherFormulario(pessoa);
            atualizarRotuloSubmit();
            exibirMensagem('Editando registro selecionado.', 'info');
          });

          const excluirBtn = document.createElement('button');
          excluirBtn.type = 'button';
          excluirBtn.className = 'button button--danger';
          excluirBtn.textContent = 'Excluir';
          excluirBtn.addEventListener('click', async () => {
            if (!confirm('Deseja realmente excluir este registro?')) return;
            try {
              exibirMensagem('Removendo registro...', 'info');
              const response = await fetchAutenticado(`${API_PESSOAS_URL}/${pessoa.id || pessoa._id}`, {
                method: 'DELETE',
              });
              if (!response.ok) {
                const data = await response.json().catch(() => ({}));
                const erro = data?.mensagem || data?.message || 'Erro ao excluir o registro.';
                throw new Error(erro);
              }
              exibirMensagem('Registro exclu√≠do com sucesso.', 'success');
              carregarPessoas();
            } catch (error) {
              exibirMensagem(error?.message || 'N√£o foi poss√≠vel excluir o registro.', 'error');
            }
          });

          actions.appendChild(editarBtn);
          actions.appendChild(excluirBtn);
          item.appendChild(actions);

          listaPessoasEl.appendChild(item);
        });
      };

      const carregarPessoas = async () => {
        try {
          exibirMensagem('Carregando pessoas cadastradas...', 'info');
          const response = await fetchAutenticado(API_PESSOAS_URL);
          const data = await response.json().catch(() => []);

          if (!response.ok) {
            const erro = data?.mensagem || data?.message || 'Erro ao buscar registros.';
            throw new Error(erro);
          }

          renderizarLista(Array.isArray(data) ? data : data?.data || []);
          exibirMensagem('Lista atualizada.', 'success');
        } catch (error) {
          exibirMensagem(error?.message || 'N√£o foi poss√≠vel carregar a lista.', 'error');
        }
      };

      const salvarPessoa = async (event) => {
        event.preventDefault();

        const payload = obterDadosFormulario();
        if (!payload.nomeCompleto?.trim()) {
          exibirMensagem('O campo Nome Completo √© obrigat√≥rio.', 'error');
          return;
        }

        // Valida CPF se preenchido
        if (payload.cpf?.trim()) {
          const validacao = validarCpf(payload.cpf);
          if (!validacao.valido) {
            exibirMensagem(validacao.mensagem, 'error');
            return;
          }
        }

        const metodo = pessoaEmEdicao ? 'PUT' : 'POST';
        const url = pessoaEmEdicao ? `${API_PESSOAS_URL}/${pessoaEmEdicao}` : API_PESSOAS_URL;

        try {
          exibirMensagem('Enviando dados...', 'info');
          submitButton.disabled = true;

          const response = await fetchAutenticado(url, {
            method: metodo,
            body: JSON.stringify(payload),
          });

          const data = await response.json().catch(() => ({}));
          if (!response.ok) {
            const erro = data?.mensagem || data?.message || 'Erro ao salvar os dados.';
            throw new Error(erro);
          }

          exibirMensagem(
            pessoaEmEdicao ? 'Dados atualizados com sucesso.' : 'Registro criado com sucesso.',
            'success'
          );
          pessoaForm.reset();
          pessoaEmEdicao = null;
          atualizarRotuloSubmit();
          carregarPessoas();
        } catch (error) {
          exibirMensagem(error?.message || 'N√£o foi poss√≠vel salvar o registro.', 'error');
        } finally {
          submitButton.disabled = false;
        }
      };

      const inicializarCadastro = () => {
        atualizarRotuloSubmit();
        pessoaForm.addEventListener('submit', salvarPessoa);
        listarButton.addEventListener('click', carregarPessoas);
        pessoaForm.addEventListener('reset', () => {
          pessoaEmEdicao = null;
          atualizarRotuloSubmit();
          exibirMensagem('Formul√°rio limpo. Pronto para novo cadastro.', 'info');
          enderecos = [];
          indicadorEnderecoAtual = null;
          renderizarEnderecos();
        });
        cpfInput?.addEventListener('input', aplicarMascaraCpf);

        // Event listener para adicionar novo endere√ßo
        const adicionarEnderecoBtn = document.getElementById('adicionar-endereco');
        adicionarEnderecoBtn?.addEventListener('click', adicionarEndereco);

        carregarPessoas();
      };

      document.addEventListener('DOMContentLoaded', inicializarCadastro);
    </script>
  </body>
</html>
