<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cadastro de Pessoas | Projeto Coruja</title>
    <link rel="stylesheet" href="/css/main.css" />
  </head>
  <body class="theme-dark">
    <div class="app">
      <div class="user-menu" id="user-menu" aria-expanded="false">
        <button class="user-menu__button" type="button" id="user-menu-button" aria-haspopup="true" aria-expanded="false">
          <span class="user-menu__avatar" id="user-avatar" aria-hidden="true">U</span>
          <span id="user-button-name">Usu√°rio</span>
        </button>
        <div class="user-menu__dropdown" id="user-menu-dropdown" role="menu" aria-label="Menu do usu√°rio">
          <div class="user-menu__item"><span class="user-menu__label">Nome Completo:</span><span class="user-menu__value" id="um-nome">‚Äî</span></div>
          <div class="user-menu__item"><span class="user-menu__label">Email:</span><span class="user-menu__value" id="um-email">‚Äî</span></div>
          <div class="user-menu__item"><span class="user-menu__label">Perfil:</span><span class="user-menu__value" id="um-perfil">‚Äî</span></div>
          <div class="user-menu__separator"></div>
          <div class="user-menu__item"><span class="user-menu__label">Senha:</span><span class="user-menu__link" id="um-alterar-senha">Alterar senha</span></div>
          <div class="user-menu__separator"></div>
          <div class="user-menu__item"><span class="user-menu__link" id="um-sair">Sair</span></div>
        </div>
      </div>
      <aside class="sidebar">
        <div class="sidebar__header">
          <div class="sidebar__brand">Projeto Coruja</div>
          <!-- Bot√£o dedicado para alternar entre tema claro e escuro -->
          <button
            class="theme-toggle"
            type="button"
            data-theme-toggle
            aria-pressed="false"
            aria-label="Alternar tema visual"
          >
            <span class="theme-toggle__icon" aria-hidden="true" data-theme-icon>üåô</span>
            <span class="theme-toggle__label" data-theme-label>Modo escuro</span>
          </button>
        </div>
        <nav class="sidebar__nav" aria-label="Menu principal">
          <a class="sidebar__link" href="/home">Home</a>
          <a class="sidebar__link" href="/usuarios">Usu√°rios</a>
          <details class="sidebar__section sidebar__section--active" open>
            <summary class="sidebar__link sidebar__link--parent" aria-label="Abrir menu Cadastro">Cadastro</summary>
            <div class="sidebar__subnav">
              <a class="sidebar__link sidebar__link--child sidebar__link--active" href="/cadastro/pessoas">Pessoas</a>
              <a class="sidebar__link sidebar__link--child" href="/cadastro/empresas">Empresas</a>
            </div>
          </details>
        </nav>
        
      </aside>

      <main class="content" data-page="cadastro-pessoas">
        <header class="content__header">
          <p class="content__eyebrow">Cadastro</p>          
        </header>

        <section class="panel" aria-label="Formul√°rio de dados de pessoas">
          <div class="panel__header panel__header--stacked">
          </div>

          <div id="pessoa-form-message" class="message" role="status" aria-live="polite"></div>

          <form class="form" id="pessoa-form" action="#" method="post">
            <!-- Se√ß√£o 1: Identifica√ß√£o -->
            <div class="form__section">
              <div class="form__section-header">
                <h3 class="form__section-title" style="text-align: center; width: 100%;">Identifica√ß√£o</h3>
              </div>
              <div class="form__grid form__grid--1">
                <label class="form__field">
                  <span class="form__label">Nome Completo</span>
                  <input class="form__input" type="text" name="nomeCompleto" required />
                </label>
                <label class="form__field">
                  <span class="form__label">Apelido/Vulgo</span>
                  <input class="form__input" type="text" name="apelido" />
                </label>
                <label class="form__field">
                  <span class="form__label">CPF</span>
                  <input class="form__input" type="text" name="cpf" inputmode="numeric" />
                  <span id="erro-cpf" class="form__error" style="display: none;">CPF inv√°lido!</span>
                </label>
                <label class="form__field">
                  <span class="form__label">RG</span>
                  <input class="form__input" type="text" name="rg" inputmode="numeric" />
                </label>
                <label class="form__field">
                  <span class="form__label">CNH</span>
                  <input class="form__input" type="text" name="cnh" inputmode="numeric" />
                </label>
                <label class="form__field">
                  <span class="form__label">Data de Nascimento</span>
                  <input class="form__input" type="date" name="dataNascimento" />
                </label>
                <label class="form__field">
                  <span class="form__label">Nome da M√£e</span>
                  <input class="form__input" type="text" name="nomeMae" />
                </label>
                <label class="form__field">
                  <span class="form__label">Nome do Pai</span>
                  <input class="form__input" type="text" name="nomePai" />
                </label>
              </div>
            </div>

            <!-- Se√ß√£o 2: Contatos -->
            <div class="form__section">
              <div class="form__section-header">
                <h3 class="form__section-title" style="text-align: center; width: 100%;">Contatos</h3>
              </div>

              <!-- Sub-se√ß√£o: Telefone -->
              <div class="form__subsection">
                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 0.5rem;">
                  <h4 class="form__section-title" style="font-size: 1rem; margin: 0; text-align: left; width: 100%;">Telefone</h4>
                  <button class="button button--secondary" id="adicionar-telefone" type="button" aria-label="Adicionar telefone" title="Adicionar">+</button>
                </div>
                <div id="lista-telefones" style="display: flex; flex-direction: column; gap: 0.5rem;"></div>
              </div>

              <!-- Sub-se√ß√£o: Emails -->
              <div class="form__subsection">
                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%; margin: 0.75rem 0;">
                  <h4 class="form__section-title" style="font-size: 1rem; margin: 0; text-align: left; width: 100%;">Email</h4>
                  <button class="button button--secondary" id="adicionar-email" type="button" aria-label="Adicionar email" title="Adicionar">+</button>
                </div>
                <div id="lista-emails" style="display: flex; flex-direction: column; gap: 0.5rem;"></div>
              </div>

              <!-- Sub-se√ß√£o: Redes Sociais (linha abaixo) -->
              <div class="form__subsection">
                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%; margin: 0.75rem 0;">
                  <h4 class="form__section-title" style="font-size: 1rem; margin: 0; text-align: left; width: 100%;">Redes Sociais</h4>
                  <button class="button button--secondary" id="adicionar-rede" type="button" aria-label="Adicionar rede social" title="Adicionar">+</button>
                </div>
                <div id="lista-redes" style="display: flex; flex-direction: column; gap: 0.5rem;"></div>
              </div>
            </div>

            <!-- Se√ß√£o 2.1: Ve√≠culos -->
            <div class="form__section">
              <div class="form__section-header">
                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                  <h3 class="form__section-title" style="text-align: center; width: 100%;">Ve√≠culos</h3>
                  <button class="button button--secondary" id="adicionar-veiculo" type="button" aria-label="Adicionar ve√≠culo" title="Adicionar">+</button>
                </div>
              </div>
              <div id="lista-veiculos" class="veiculos-lista"></div>
            </div>

            <!-- Se√ß√£o 3: Endere√ßos -->
            <div class="form__section">
              <div class="form__section-header">
                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                  <h3 class="form__section-title" style="text-align: center; width: 100%;">Endere√ßos</h3>
                  <button class="button button--secondary" id="adicionar-endereco" type="button" aria-label="Adicionar endere√ßo" title="Adicionar">+</button>
                </div>
              </div>
              <div id="lista-enderecos" class="enderecos-lista"></div>
            </div>

            <!-- Se√ß√£o 4: Empresa -->
            <div class="form__section">
              <div class="form__section-header">
                <h3 class="form__section-title" style="text-align: center; width: 100%;">Empresa</h3>
              </div>

              <div class="form__grid form__grid--4">
                <label class="form__field form__field--wide">
                  <span class="form__label">CNPJ</span>
                  <input class="form__input" type="text" name="empresa_cnpj" id="empresa-cnpj" inputmode="numeric" placeholder="00.000.000/0000-00" />
                </label>
                <label class="form__field form__field--wide">
                  <span class="form__label">Raz√£o Social</span>
                  <input class="form__input" type="text" name="empresa_razaoSocial" />
                </label>
                <label class="form__field form__field--wide">
                  <span class="form__label">Nome Fantasia</span>
                  <input class="form__input" type="text" name="empresa_nomeFantasia" />
                </label>
                <label class="form__field form__field--wide">
                  <span class="form__label">Natureza Jur√≠dica</span>
                  <input class="form__input" type="text" name="empresa_naturezaJuridica" />
                </label>
                <label class="form__field">
                  <span class="form__label">Data In√≠cio Atividade</span>
                  <input class="form__input" type="date" name="empresa_dataInicioAtividade" />
                </label>
                <label class="form__field">
                  <span class="form__label">Situa√ß√£o Cadastral</span>
                  <select class="form__input" name="empresa_situacaoCadastral">
                    <option value="">Selecione</option>
                    <option value="Ativo">Ativo</option>
                    <option value="Inativo">Inativo</option>
                    <option value="Inapta">Inapta</option>
                  </select>
                </label>
                <label class="form__field form__field--wide">
                  <span class="form__label">Endere√ßo</span>
                  <input class="form__input" type="text" name="empresa_endereco" />
                </label>
                <label class="form__field">
                  <span class="form__label">CEP</span>
                  <input class="form__input" type="text" name="empresa_cep" id="empresa-cep" inputmode="numeric" placeholder="00000-000" />
                </label>
                <label class="form__field">
                  <span class="form__label">Telefone</span>
                  <input class="form__input" type="tel" name="empresa_telefone" id="empresa-telefone" placeholder="(00) 00000-0000" />
                </label>
              </div>

              <div class="form__subsection">
                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%; margin: 0.75rem 0;">
                  <h4 class="form__section-title" style="font-size: 1rem; margin: 0;">S√≥cios</h4>
                  <button class="button button--secondary" id="adicionar-socio" type="button" aria-label="Adicionar s√≥cio" title="Adicionar">+</button>
                </div>
                <div id="lista-socios" style="display: flex; flex-direction: column; gap: 0.5rem;"></div>
              </div>
            </div>

            <!-- Se√ß√£o 5: V√≠nculos -->
            <div class="form__section">
              <div class="form__section-header">
                <h3 class="form__section-title" style="text-align: center; width: 100%;">V√≠nculos</h3>
              </div>

              <!-- Sub-se√ß√£o: Pessoas -->
              <div class="form__subsection">
                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%; margin: 0.75rem 0;">
                  <h4 class="form__section-title" style="font-size: 1rem; margin: 0;">Pessoas</h4>
                  <button class="button button--secondary" id="adicionar-vinculo-pessoa" type="button" aria-label="Adicionar v√≠nculo de pessoa" title="Adicionar">+</button>
                </div>
                <div id="lista-vinculos-pessoas" style="display: flex; flex-direction: column; gap: 0.5rem;"></div>
              </div>

              <!-- Sub-se√ß√µes: Empresa (m√∫ltiplo), Ve√≠culos, Entidades -->
              <div class="form__subsection">
                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%; margin: 0.75rem 0;">
                  <h4 class="form__section-title" style="font-size: 1rem; margin: 0;">Empresa</h4>
                  <button class="button button--secondary" id="adicionar-vinculo-empresa" type="button" aria-label="Adicionar v√≠nculo de empresa" title="Adicionar">+</button>
                </div>
                <div id="lista-vinculos-empresas" style="display: flex; flex-direction: column; gap: 0.5rem;"></div>
              </div>
              <div class="form__subsection">
                <h4 class="form__section-title" style="font-size: 1rem; margin: 0;">Ve√≠culos</h4>
                <p style="color: var(--muted); font-size: 0.85rem; margin: 0.5rem 0;">Sem campos definidos ainda.</p>
              </div>
              <div class="form__subsection">
                <h4 class="form__section-title" style="font-size: 1rem; margin: 0;">Entidades</h4>
                <p style="color: var(--muted); font-size: 0.85rem; margin: 0.5rem 0;">Sem campos definidos ainda.</p>
              </div>
            </div>

            <div class="form__actions">
              <button class="button button--secondary" type="reset">Limpar</button>
              <button class="button button--ghost" id="listar-pessoas" type="button">Listar</button>
              <button class="button button--primary" id="submit-pessoa" type="submit">Incluir</button>
            </div>
          </form>
        </section>

        <section class="panel" aria-label="Lista de pessoas cadastradas" id="pessoas-panel" hidden>
          <div class="panel__header panel__header--stacked">
            <div>
              <h2 class="panel__title">Lista de pessoas cadastradas</h2>
            </div>
          </div>

          <div id="pessoas-message" class="message" role="status" aria-live="polite"></div>

          <ul id="pessoas-lista" class="list" aria-live="polite"></ul>
        </section>
      </main>
    </div>

    <script src="/js/main.js"></script>
    <div id="alterar-senha-modal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="alterar-senha-title">
      <div class="modal__overlay" data-modal-close></div>
      <div class="modal__panel modal__panel--sm" role="document">
        <button class="modal__close" id="alterar-senha-close" aria-label="Fechar">√ó</button>
        <h3 id="alterar-senha-title">Alterar senha</h3>
        <form id="alterar-senha-form" class="form" novalidate>
          <label class="form__field">
            <span class="form__label">Senha atual</span>
            <input class="form__input" type="password" id="senha-atual" required />
          </label>
          <label class="form__field">
            <span class="form__label">Nova senha</span>
            <input class="form__input" type="password" id="senha-nova" required />
          </label>
          <div class="form__actions">
            <button type="button" class="button button--ghost" id="alterar-senha-cancelar">Cancelar</button>
            <button type="submit" class="button button--primary" id="alterar-senha-submit">Alterar</button>
          </div>
        </form>
      </div>
    </div>
    <script>
      const API_PESSOAS_URL = '/api/pessoas';
      const pessoaForm = document.getElementById('pessoa-form');
      const submitButton = document.getElementById('submit-pessoa');
      const listarButton = document.getElementById('listar-pessoas');
      const listaPessoasEl = document.getElementById('pessoas-lista');
      const messageEl = document.getElementById('pessoas-message');
      const formMessageEl = document.getElementById('pessoa-form-message');
      const cpfInput = pessoaForm?.elements['cpf'];
      let pessoaEmEdicao = null;
      let ultimaAcaoFoiEdicao = false;

      const getCookie = (name) => {
        return document.cookie
          .split(';')
          .map((c) => c.trim())
          .find((c) => c.startsWith(`${name}=`))
          ?.split('=')[1];
      };

      const obterToken = () => localStorage.getItem('authToken') || getCookie('authToken');

      const fetchAutenticado = (url, options = {}) => {
        const token = obterToken();
        const headers = {
          'Content-Type': 'application/json',
          ...(options.headers || {}),
          ...(token ? { Authorization: `Bearer ${token}` } : {}),
        };

        return fetch(url, { ...options, headers });
      };

      const exibirMensagem = (texto, tipo = 'info') => {
        if (!messageEl) return;
        messageEl.textContent = texto || '';
        messageEl.className = 'message';
        if (texto) messageEl.classList.add(`message--${tipo}`);
      };

      const exibirMensagemForm = (texto, tipo = 'info') => {
        if (!formMessageEl) return;
        formMessageEl.textContent = texto || '';
        formMessageEl.className = 'message';
        if (texto) formMessageEl.classList.add(`message--${tipo}`);
      };

      const obterDadosFormulario = () => {
        const formData = new FormData(pessoaForm);
        const dados = Object.fromEntries(formData.entries());
        
        // Adiciona os endere√ßos m√∫ltiplos ao payload
        dados.enderecos = enderecos;
        dados.endereco_atual_index = indicadorEnderecoAtual;
        
        // Adiciona os telefones m√∫ltiplos ao payload
        dados.telefones = telefones.filter(tel => tel.trim() !== '');
        // Adiciona emails e redes sociais m√∫ltiplos ao payload
        dados.emails = emails.filter(e => e.trim() !== '');
        dados.redesSociais = redes.filter(r => r.trim() !== '');
        // Adiciona ve√≠culos (ignora itens totalmente vazios)
        dados.veiculos = veiculos.filter(v => {
          const mm = String(v.marcaModelo || '').trim();
          const p = String(v.placa || '').trim();
          const c = String(v.cor || '').trim();
          const am = String(v.anoModelo || '').trim();
          return mm || p || c || am;
        });

        // Montar objeto empresa
        const empresa = {
          cnpj: String(dados['empresa_cnpj'] || '').trim(),
          razaoSocial: String(dados['empresa_razaoSocial'] || '').trim(),
          nomeFantasia: String(dados['empresa_nomeFantasia'] || '').trim(),
          naturezaJuridica: String(dados['empresa_naturezaJuridica'] || '').trim(),
          dataInicioAtividade: String(dados['empresa_dataInicioAtividade'] || '').trim(),
          situacaoCadastral: String(dados['empresa_situacaoCadastral'] || '').trim(),
          endereco: String(dados['empresa_endereco'] || '').trim(),
          cep: String(dados['empresa_cep'] || '').trim(),
          telefone: String(dados['empresa_telefone'] || '').trim(),
          socios: (socios || []).map(s => ({ nome: String(s.nome||'').trim(), cpf: String(s.cpf||'').trim() }))
        };
        const algumaInfoEmpresa = Object.values({
          cnpj: empresa.cnpj, razaoSocial: empresa.razaoSocial, nomeFantasia: empresa.nomeFantasia,
          naturezaJuridica: empresa.naturezaJuridica, dataInicioAtividade: empresa.dataInicioAtividade,
          situacaoCadastral: empresa.situacaoCadastral, endereco: empresa.endereco, telefone: empresa.telefone
        }).some(v => v && v.length);
        dados.empresa = algumaInfoEmpresa || (empresa.socios && empresa.socios.length) ? empresa : undefined;
        
        // Montar v√≠nculos
        const pessoasVinc = (vinculosPessoas || []).map(v => ({
          nome: String(v.nome||'').trim(),
          cpf: String(v.cpf||'').trim(),
          tipo: String(v.tipo||'').trim(),
        })).filter(v => v.nome || v.cpf || v.tipo);
        const empresasVinc = (vinculosEmpresas || [])
          .map(e => {
            const nome = String(e?.nome || '').trim();
            const observacoes = String(e?.observacoes || '').trim();
            return (nome || observacoes) ? { nome, observacoes } : null;
          })
          .filter(Boolean);
        const vinculosObj = {};
        if (pessoasVinc.length) vinculosObj.pessoas = pessoasVinc;
        if (empresasVinc.length) vinculosObj.empresas = empresasVinc;
        dados.vinculos = Object.keys(vinculosObj).length ? vinculosObj : undefined;
        
        return dados;
      };

      const aplicarMascaraCpf = (event) => {
        // Garante que apenas n√∫meros sejam digitados e aplica a m√°scara padr√£o de CPF
        const somenteNumeros = event.target.value.replace(/\D/g, '').slice(0, 11);

        let valorMascarado = somenteNumeros;
        if (somenteNumeros.length > 3) {
          valorMascarado = `${somenteNumeros.slice(0, 3)}.${somenteNumeros.slice(3, 6)}`;
        }
        if (somenteNumeros.length > 6) {
          valorMascarado = `${valorMascarado}.${somenteNumeros.slice(6, 9)}`;
        }
        if (somenteNumeros.length > 9) {
          valorMascarado = `${valorMascarado}-${somenteNumeros.slice(9, 11)}`;
        }

        event.target.value = valorMascarado;

        // Valida CPF em tempo real quando completo (11 d√≠gitos)
        const erroEl = document.getElementById('erro-cpf');
        if (somenteNumeros.length === 11) {
          const validacao = validarCpf(valorMascarado);
          if (!validacao.valido) {
            erroEl.style.display = 'block';
            erroEl.textContent = 'CPF inv√°lido!';
          } else {
            erroEl.style.display = 'none';
          }
        } else if (somenteNumeros.length > 0) {
          // Mostra erro se n√£o est√° completo e o usu√°rio parou de digitar
          erroEl.style.display = 'none';
        }
      };

      const validarCpf = (cpf) => {
        // Remove caracteres n√£o num√©ricos
        const somenteNumeros = cpf.replace(/\D/g, '');

        // Valida comprimento
        if (somenteNumeros.length !== 11) {
          return { valido: false, mensagem: 'CPF deve ter 11 d√≠gitos.' };
        }

        // Valida se todos os d√≠gitos s√£o iguais
        if (/^(\d)\1{10}$/.test(somenteNumeros)) {
          return { valido: false, mensagem: 'CPF inv√°lido: todos os d√≠gitos s√£o iguais.' };
        }

        // Calcula primeiro d√≠gito verificador
        let soma = 0;
        for (let i = 0; i < 9; i++) {
          soma += parseInt(somenteNumeros[i]) * (10 - i);
        }
        let primeiroDigito = 11 - (soma % 11);
        primeiroDigito = primeiroDigito > 9 ? 0 : primeiroDigito;

        // Valida primeiro d√≠gito verificador
        if (parseInt(somenteNumeros[9]) !== primeiroDigito) {
          return { valido: false, mensagem: 'CPF inv√°lido: primeiro d√≠gito verificador incorreto.' };
        }

        // Calcula segundo d√≠gito verificador
        soma = 0;
        for (let i = 0; i < 10; i++) {
          soma += parseInt(somenteNumeros[i]) * (11 - i);
        }
        let segundoDigito = 11 - (soma % 11);
        segundoDigito = segundoDigito > 9 ? 0 : segundoDigito;

        // Valida segundo d√≠gito verificador
        if (parseInt(somenteNumeros[10]) !== segundoDigito) {
          return { valido: false, mensagem: 'CPF inv√°lido: segundo d√≠gito verificador incorreto.' };
        }

        return { valido: true, mensagem: 'CPF v√°lido.' };
      };

      let enderecos = [];
      let indicadorEnderecoAtual = null;
      let telefones = [];
      let emails = [];
      let redes = [];
      let veiculos = [];
      let socios = [];
      let vinculosPessoas = [];
      let vinculosEmpresas = [];

      const renderizarTelefones = () => {
        const listaTelefonesEl = document.getElementById('lista-telefones');
        listaTelefonesEl.innerHTML = '';

        if (telefones.length === 0) {
          listaTelefonesEl.innerHTML = '<p style="color: var(--muted); font-size: 0.85rem; margin: 0;">Nenhum telefone adicionado. Clique para adicionar.</p>';
          return;
        }

        telefones.forEach((telefone, indice) => {
          const divTelefone = document.createElement('div');
          divTelefone.style.display = 'flex';
          divTelefone.style.gap = '0.5rem';
          divTelefone.style.alignItems = 'center';

          const inputTelefone = document.createElement('input');
          inputTelefone.type = 'tel';
          inputTelefone.className = 'form__input';
          inputTelefone.inputMode = 'tel';
          inputTelefone.value = telefone;
          inputTelefone.placeholder = '(XX) XXXXX-XXXX';
          inputTelefone.addEventListener('input', (e) => {
            telefones[indice] = e.target.value;
          });
          divTelefone.appendChild(inputTelefone);

          const btnRemover = document.createElement('button');
          btnRemover.type = 'button';
          btnRemover.className = 'button button--danger';
          btnRemover.textContent = '‚àí';
          btnRemover.setAttribute('aria-label', 'Remover telefone');
          btnRemover.title = 'Excluir';
          btnRemover.style.padding = '0.25rem 0.5rem';
          btnRemover.style.fontSize = '0.75rem';
          btnRemover.style.minWidth = 'fit-content';
          btnRemover.addEventListener('click', () => {
            telefones.splice(indice, 1);
            renderizarTelefones();
          });
          divTelefone.appendChild(btnRemover);

          listaTelefonesEl.appendChild(divTelefone);
        });
      };

      const adicionarTelefone = () => {
        telefones.push('');
        renderizarTelefones();
      };

      const renderizarEmails = () => {
        const listaEmailsEl = document.getElementById('lista-emails');
        if (!listaEmailsEl) return;
        listaEmailsEl.innerHTML = '';

        if (emails.length === 0) {
          listaEmailsEl.innerHTML = '<p style="color: var(--muted); font-size: 0.85rem; margin: 0;">Nenhum email adicionado. Clique para adicionar.</p>';
          return;
        }

        emails.forEach((email, indice) => {
          const linha = document.createElement('div');
          linha.style.display = 'flex';
          linha.style.gap = '0.5rem';
          linha.style.alignItems = 'center';

          const input = document.createElement('input');
          input.type = 'email';
          input.className = 'form__input';
          input.value = email;
          input.placeholder = 'seuemail@exemplo.com';
          input.addEventListener('input', (e) => {
            emails[indice] = e.target.value;
          });
          linha.appendChild(input);

          const btnRemover = document.createElement('button');
          btnRemover.type = 'button';
          btnRemover.className = 'button button--danger';
          btnRemover.textContent = '‚àí';
          btnRemover.setAttribute('aria-label', 'Remover email');
          btnRemover.title = 'Excluir';
          btnRemover.style.padding = '0.25rem 0.5rem';
          btnRemover.style.fontSize = '0.75rem';
          btnRemover.style.minWidth = 'fit-content';
          btnRemover.addEventListener('click', () => {
            emails.splice(indice, 1);
            renderizarEmails();
          });
          linha.appendChild(btnRemover);

          listaEmailsEl.appendChild(linha);
        });
      };

      const adicionarEmail = () => {
        emails.push('');
        renderizarEmails();
      };

      const renderizarRedes = () => {
        const listaRedesEl = document.getElementById('lista-redes');
        if (!listaRedesEl) return;
        listaRedesEl.innerHTML = '';

        if (redes.length === 0) {
          listaRedesEl.innerHTML = '<p style="color: var(--muted); font-size: 0.85rem; margin: 0;">Nenhuma rede adicionada. Clique para adicionar.</p>';
          return;
        }

        redes.forEach((rede, indice) => {
          const linha = document.createElement('div');
          linha.style.display = 'flex';
          linha.style.gap = '0.5rem';
          linha.style.alignItems = 'center';

          const partes = String(rede).split('|');
          const valorTipo = (partes[0] || '').trim();
          const valorPerfil = (partes[1] || '').trim();

          const select = document.createElement('select');
          select.className = 'form__input';
          select.style.maxWidth = '12rem';
          select.innerHTML = `
            <option value="">Selecione</option>
            <option value="instagram">Instagram</option>
            <option value="facebook">Facebook</option>
            <option value="linkedin">LinkedIn</option>
            <option value="twitter">Twitter / X</option>
            <option value="youtube">YouTube</option>
            <option value="tiktok">TikTok</option>
            <option value="github">GitHub</option>
            <option value="website">Website</option>
            <option value="outro">Outro</option>
          `;
          select.value = valorTipo;
          linha.appendChild(select);

          const input = document.createElement('input');
          input.type = 'text';
          input.className = 'form__input';
          input.placeholder = 'URL ou @usuario';
          input.value = valorPerfil;
          input.style.flex = '1';
          linha.appendChild(input);

          const atualizarValor = () => {
            const tipo = select.value || '';
            const perfil = input.value || '';
            redes[indice] = `${tipo}|${perfil}`;
          };

          select.addEventListener('change', atualizarValor);
          input.addEventListener('input', atualizarValor);

          const btnRemover = document.createElement('button');
          btnRemover.type = 'button';
          btnRemover.className = 'button button--danger';
          btnRemover.textContent = '‚àí';
          btnRemover.setAttribute('aria-label', 'Remover rede social');
          btnRemover.title = 'Excluir';
          btnRemover.style.padding = '0.25rem 0.5rem';
          btnRemover.style.fontSize = '0.75rem';
          btnRemover.style.minWidth = 'fit-content';
          btnRemover.addEventListener('click', () => {
            redes.splice(indice, 1);
            renderizarRedes();
          });
          linha.appendChild(btnRemover);

          listaRedesEl.appendChild(linha);
        });
      };

      const adicionarRede = () => {
        redes.push('|');
        renderizarRedes();
      };

      const aplicarMascaraCnpj = (valor) => {
        const dig = String(valor || '').replace(/\D/g, '').slice(0, 14);
        let v = dig;
        if (dig.length > 2) v = dig.slice(0,2) + '.' + dig.slice(2);
        if (dig.length > 5) v = v.slice(0,6) + '.' + dig.slice(5);
        if (dig.length > 8) v = v.slice(0,10) + '/' + dig.slice(8);
        if (dig.length > 12) v = v.slice(0,15) + '-' + dig.slice(12);
        return v;
      };

      const aplicarMascaraCpfInline = (valor) => {
        const dig = String(valor || '').replace(/\D/g, '').slice(0, 11);
        let v = dig;
        if (dig.length > 3) v = dig.slice(0,3) + '.' + dig.slice(3);
        if (dig.length > 6) v = v.slice(0,7) + '.' + dig.slice(6);
        if (dig.length > 9) v = v.slice(0,11) + '-' + dig.slice(9);
        return v;
      };

      const aplicarMascaraTelefone = (valor) => {
        const dig = String(valor || '').replace(/\D/g, '').slice(0, 11);
        if (dig.length <= 10) {
          return dig.replace(/(\d{0,2})(\d{0,4})(\d{0,4}).*/, function(_, a,b,c){
            let r = '';
            if (a) r += `(${a}` + (a.length===2?') ':'');
            if (b) r += b + (b.length===4?'-':'');
            if (c) r += c;
            return r;
          });
        } else {
          return dig.replace(/(\d{0,2})(\d{0,5})(\d{0,4}).*/, function(_, a,b,c){
            let r = '';
            if (a) r += `(${a}` + (a.length===2?') ':'');
            if (b) r += b + (b.length===5?'-':'');
            if (c) r += c;
            return r;
          });
        }
      };

      const aplicarMascaraCep = (valor) => {
        const dig = String(valor || '').replace(/\D/g, '').slice(0,8);
        if (dig.length <= 5) return dig;
        return dig.slice(0,5) + '-' + dig.slice(5);
      };

      const renderizarSocios = () => {
        const lista = document.getElementById('lista-socios');
        if (!lista) return;
        lista.innerHTML = '';
        if (socios.length === 0) {
          lista.innerHTML = '<p style="color: var(--muted); font-size: 0.85rem; margin: 0;">Nenhum s√≥cio adicionado. Clique para adicionar.</p>';
          return;
        }
        socios.forEach((s, i) => {
          const linha = document.createElement('div');
          linha.style.cssText = 'display:flex; gap:0.5rem; align-items:center;';
          linha.innerHTML = `
            <label class="form__field" style="flex:1;">
              <span class="form__label">Nome</span>
              <input class="form__input socio-nome" type="text" data-index="${i}" />
            </label>
            <label class="form__field" style="max-width: 16rem;">
              <span class="form__label">CPF</span>
              <input class="form__input socio-cpf" type="text" data-index="${i}" placeholder="000.000.000-00" />
            </label>
            <button class="button button--danger" type="button" title="Excluir" aria-label="Remover s√≥cio">‚àí</button>
          `;
          const nomeEl = linha.querySelector('.socio-nome');
          const cpfEl = linha.querySelector('.socio-cpf');
          const btn = linha.querySelector('button');
          nomeEl.value = s.nome || '';
          cpfEl.value = aplicarMascaraCpfInline(s.cpf || '');
          nomeEl.addEventListener('input', (e) => { socios[i].nome = e.target.value; });
          cpfEl.addEventListener('input', (e) => { socios[i].cpf = aplicarMascaraCpfInline(e.target.value); e.target.value = socios[i].cpf; });
          btn.addEventListener('click', () => { socios.splice(i,1); renderizarSocios(); });
          lista.appendChild(linha);
        });
      };

      const adicionarSocio = () => {
        socios.push({ nome: '', cpf: '' });
        renderizarSocios();
      };

      const renderizarVinculosPessoas = () => {
        const lista = document.getElementById('lista-vinculos-pessoas');
        if (!lista) return;
        lista.innerHTML = '';
        if (vinculosPessoas.length === 0) {
          lista.innerHTML = '<p style="color: var(--muted); font-size: 0.85rem; margin: 0;">Nenhum v√≠nculo adicionado. Clique para adicionar.</p>';
          return;
        }
        vinculosPessoas.forEach((v, i) => {
          const linha = document.createElement('div');
          linha.style.cssText = 'display:grid; grid-template-columns: 1fr 16rem 16rem auto; gap:0.5rem; align-items:end;';
          linha.innerHTML = `
            <label class="form__field">
              <span class="form__label">Nome</span>
              <input class="form__input vpc-nome" type="text" data-index="${i}" />
            </label>
            <label class="form__field">
              <span class="form__label">CPF</span>
              <input class="form__input vpc-cpf" type="text" data-index="${i}" placeholder="000.000.000-00" />
            </label>
            <label class="form__field">
              <span class="form__label">Tipo</span>
              <select class="form__input vpc-tipo" data-index="${i}">
                <option value="">Selecione</option>
                <option>Esposa(o)</option>
                <option>Filho(a)</option>
                <option>Irm√£o(a)</option>
                <option>S√≥cio(a)</option>
                <option>Namorado(a)</option>
                <option>Primo(a)</option>
                <option>Tio(a)</option>
                <option>Av√¥(√≥)</option>
              </select>
            </label>
            <button class="button button--danger" type="button" title="Excluir" aria-label="Remover v√≠nculo">‚àí</button>
          `;
          const nomeEl = linha.querySelector('.vpc-nome');
          const cpfEl = linha.querySelector('.vpc-cpf');
          const tipoEl = linha.querySelector('.vpc-tipo');
          const btn = linha.querySelector('button');
          nomeEl.value = v.nome || '';
          cpfEl.value = aplicarMascaraCpfInline(v.cpf || '');
          tipoEl.value = v.tipo || '';
          nomeEl.addEventListener('input', (e) => { vinculosPessoas[i].nome = e.target.value; });
          cpfEl.addEventListener('input', (e) => { vinculosPessoas[i].cpf = aplicarMascaraCpfInline(e.target.value); e.target.value = vinculosPessoas[i].cpf; });
          tipoEl.addEventListener('change', (e) => { vinculosPessoas[i].tipo = e.target.value; });
          btn.addEventListener('click', () => { vinculosPessoas.splice(i,1); renderizarVinculosPessoas(); });
          lista.appendChild(linha);
        });
      };

      const adicionarVinculoPessoa = () => {
        vinculosPessoas.push({ nome: '', cpf: '', tipo: '' });
        renderizarVinculosPessoas();
      };

      const renderizarVinculosEmpresas = () => {
        const lista = document.getElementById('lista-vinculos-empresas');
        if (!lista) return;
        lista.innerHTML = '';
        if (vinculosEmpresas.length === 0) {
          lista.innerHTML = '<p style="color: var(--muted); font-size: 0.85rem; margin: 0;">Nenhum v√≠nculo de empresa adicionado. Clique para adicionar.</p>';
          return;
        }
        vinculosEmpresas.forEach((emp, i) => {
          const linha = document.createElement('div');
          linha.style.cssText = 'display:grid; grid-template-columns: 1fr 1fr auto; gap:0.5rem; align-items:end;';
          linha.innerHTML = `
            <label class="form__field">
              <span class="form__label">Nome da Empresa</span>
              <input class="form__input vem-nome" type="text" data-index="${i}" placeholder="Digite o nome da empresa" />
            </label>
            <label class="form__field">
              <span class="form__label">Observa√ß√µes</span>
              <input class="form__input vem-obs" type="text" data-index="${i}" placeholder="Observa√ß√µes sobre o v√≠nculo" />
            </label>
            <button class="button button--danger" type="button" title="Excluir" aria-label="Remover v√≠nculo">‚àí</button>
          `;
          const nomeEl = linha.querySelector('.vem-nome');
          const obsEl = linha.querySelector('.vem-obs');
          const btn = linha.querySelector('button');
          nomeEl.value = String(emp?.nome || '');
          obsEl.value = String(emp?.observacoes || '');
          nomeEl.addEventListener('input', (e) => { if (!vinculosEmpresas[i]) vinculosEmpresas[i] = { nome: '', observacoes: '' }; vinculosEmpresas[i].nome = e.target.value; });
          obsEl.addEventListener('input', (e) => { if (!vinculosEmpresas[i]) vinculosEmpresas[i] = { nome: '', observacoes: '' }; vinculosEmpresas[i].observacoes = e.target.value; });
          btn.addEventListener('click', () => { vinculosEmpresas.splice(i,1); renderizarVinculosEmpresas(); });
          lista.appendChild(linha);
        });
      };

      const adicionarVinculoEmpresa = () => {
        vinculosEmpresas.push({ nome: '', observacoes: '' });
        renderizarVinculosEmpresas();
      };

      const renderizarVeiculos = () => {
        const listaVeiculosEl = document.getElementById('lista-veiculos');
        if (!listaVeiculosEl) return;
        listaVeiculosEl.innerHTML = '';

        if (veiculos.length === 0) {
          listaVeiculosEl.innerHTML = '<p style="color: var(--muted); margin: 1rem 0;">Nenhum ve√≠culo adicionado. Clique no bot√£o para adicionar.</p>';
          return;
        }

        veiculos.forEach((veiculo, indice) => {
          const div = document.createElement('div');
          div.className = 'veiculo-item';
          div.style.cssText = 'border: 1px solid var(--border); border-radius: 0.5rem; padding: 1rem; margin-bottom: 0.75rem; background: var(--surface-muted);';

          const header = document.createElement('div');
          header.style.cssText = 'display:flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;';
          const titulo = document.createElement('span');
          titulo.style.cssText = 'font-weight:600; color: var(--text);';
          titulo.textContent = `Ve√≠culo ${indice + 1}`;
          const removerBtn = document.createElement('button');
          removerBtn.type = 'button';
          removerBtn.className = 'button button--danger';
          removerBtn.textContent = '‚àí';
          removerBtn.title = 'Excluir';
          removerBtn.setAttribute('aria-label', 'Remover ve√≠culo');
          removerBtn.style.cssText = 'padding: 0.25rem 0.5rem; font-size: 0.75rem; min-width: fit-content;';
          removerBtn.addEventListener('click', () => {
            veiculos.splice(indice, 1);
            renderizarVeiculos();
          });
          header.appendChild(titulo);
          header.appendChild(removerBtn);
          div.appendChild(header);

          const grid = document.createElement('div');
          grid.className = 'form__grid form__grid--4';
          grid.innerHTML = `
            <label class="form__field form__field--wide">
              <span class="form__label">Marca/Modelo</span>
              <input class="form__input veic-marcaModelo" type="text" data-index="${indice}" placeholder="Ex: VW Gol 1.6" />
            </label>
            <label class="form__field">
              <span class="form__label">Placa</span>
              <input class="form__input veic-placa" type="text" data-index="${indice}" placeholder="ABC1D23" />
            </label>
            <label class="form__field">
              <span class="form__label">Cor</span>
              <input class="form__input veic-cor" type="text" data-index="${indice}" placeholder="Cor" />
            </label>
            <label class="form__field">
              <span class="form__label">Ano/Modelo</span>
              <input class="form__input veic-anoModelo" type="text" inputmode="numeric" data-index="${indice}" placeholder="AAAA" />
            </label>
          `;

          grid.querySelector('.veic-marcaModelo').value = veiculo.marcaModelo || '';
          grid.querySelector('.veic-placa').value = veiculo.placa || '';
          grid.querySelector('.veic-cor').value = veiculo.cor || '';
          grid.querySelector('.veic-anoModelo').value = veiculo.anoModelo || '';

          grid.querySelector('.veic-marcaModelo').addEventListener('input', (e) => {
            veiculos[indice].marcaModelo = e.target.value;
          });
          grid.querySelector('.veic-placa').addEventListener('input', (e) => {
            veiculos[indice].placa = String(e.target.value || '').toUpperCase();
            e.target.value = veiculos[indice].placa;
          });
          grid.querySelector('.veic-cor').addEventListener('input', (e) => {
            veiculos[indice].cor = e.target.value;
          });
          grid.querySelector('.veic-anoModelo').addEventListener('input', (e) => {
            veiculos[indice].anoModelo = e.target.value.replace(/\D/g, '').slice(0, 4);
            e.target.value = veiculos[indice].anoModelo;
          });

          div.appendChild(grid);
          listaVeiculosEl.appendChild(div);
        });
      };

      const adicionarVeiculo = () => {
        veiculos.push({ marcaModelo: '', placa: '', cor: '', anoModelo: '' });
        renderizarVeiculos();
      };

      const createEstadosSelect = () => {
        return `<option value="">Selecione</option>
                    <option value="AC">Acre (AC)</option>
                    <option value="AL">Alagoas (AL)</option>
                    <option value="AP">Amap√° (AP)</option>
                    <option value="AM">Amazonas (AM)</option>
                    <option value="BA">Bahia (BA)</option>
                    <option value="CE">Cear√° (CE)</option>
                    <option value="DF">Distrito Federal (DF)</option>
                    <option value="ES">Esp√≠rito Santo (ES)</option>
                    <option value="GO">Goi√°s (GO)</option>
                    <option value="MA">Maranh√£o (MA)</option>
                    <option value="MT">Mato Grosso (MT)</option>
                    <option value="MS">Mato Grosso do Sul (MS)</option>
                    <option value="MG">Minas Gerais (MG)</option>
                    <option value="PA">Par√° (PA)</option>
                    <option value="PB">Para√≠ba (PB)</option>
                    <option value="PR">Paran√° (PR)</option>
                    <option value="PE">Pernambuco (PE)</option>
                    <option value="PI">Piau√≠ (PI)</option>
                    <option value="RJ">Rio de Janeiro (RJ)</option>
                    <option value="RN">Rio Grande do Norte (RN)</option>
                    <option value="RS">Rio Grande do Sul (RS)</option>
                    <option value="RO">Rond√¥nia (RO)</option>
                    <option value="RR">Roraima (RR)</option>
                    <option value="SC">Santa Catarina (SC)</option>
                    <option value="SP">S√£o Paulo (SP)</option>
                    <option value="SE">Sergipe (SE)</option>
                    <option value="TO">Tocantins (TO)</option>`;
      };

      const renderizarEnderecos = () => {
        const listaEl = document.getElementById('lista-enderecos');
        listaEl.innerHTML = '';

        if (enderecos.length === 0) {
          listaEl.innerHTML = '<p style="color: var(--muted); margin: 1rem 0;">Nenhum endere√ßo adicionado. Clique no bot√£o para adicionar um.</p>';
          return;
        }

        // Garante que o endere√ßo atual seja exibido primeiro na lista renderizada
        const ordemEnderecos = indicadorEnderecoAtual === null
          ? enderecos.map((_, indice) => indice)
          : [indicadorEnderecoAtual, ...enderecos.map((_, indice) => indice).filter((indice) => indice !== indicadorEnderecoAtual)];

        ordemEnderecos.forEach((indiceOrdenado, posicao) => {
          const endereco = enderecos[indiceOrdenado];
          const div = document.createElement('div');
          div.className = 'endereco-item';
          div.style.cssText = 'border: 1px solid var(--border); border-radius: 0.5rem; padding: 1.5rem; margin-bottom: 1rem; background: var(--surface-muted);';

          const headerDiv = document.createElement('div');
          headerDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;';

          const titleSpan = document.createElement('span');
          titleSpan.style.cssText = 'font-weight: 600; color: var(--text);';
          titleSpan.textContent = `Endere√ßo ${posicao + 1}${indicadorEnderecoAtual === indiceOrdenado ? ' (Atual)' : ''}`;

          const actionsDiv = document.createElement('div');
          actionsDiv.style.cssText = 'display: flex; gap: 0.5rem;';

          if (enderecos.length > 1 && indicadorEnderecoAtual !== indiceOrdenado) {
            const setarAtualBtn = document.createElement('button');
            setarAtualBtn.type = 'button';
            setarAtualBtn.className = 'button button--secondary';
            setarAtualBtn.textContent = 'Definir como Atual';
            setarAtualBtn.style.cssText = 'padding: 0.5rem 1rem; font-size: 0.875rem;';
            setarAtualBtn.addEventListener('click', () => {
              indicadorEnderecoAtual = indiceOrdenado;
              renderizarEnderecos();
            });
            actionsDiv.appendChild(setarAtualBtn);
          }

          const removerBtn = document.createElement('button');
          removerBtn.type = 'button';
          removerBtn.className = 'button button--danger';
          removerBtn.textContent = '‚àí';
          removerBtn.setAttribute('aria-label', 'Remover endere√ßo');
          removerBtn.title = 'Excluir';
          removerBtn.style.cssText = 'padding: 0.25rem 0.5rem; font-size: 0.75rem; min-width: fit-content;';
          removerBtn.addEventListener('click', () => {
            enderecos.splice(indiceOrdenado, 1);
            if (indicadorEnderecoAtual === indiceOrdenado) {
              indicadorEnderecoAtual = enderecos.length > 0 ? 0 : null;
            } else if (indicadorEnderecoAtual > indiceOrdenado) {
              indicadorEnderecoAtual--;
            }
            renderizarEnderecos();
          });
          actionsDiv.appendChild(removerBtn);

          headerDiv.appendChild(titleSpan);
          headerDiv.appendChild(actionsDiv);
          div.appendChild(headerDiv);

          // Criar campos do endere√ßo
          const gridDiv = document.createElement('div');
          gridDiv.className = 'form__grid form__grid--4';
          gridDiv.innerHTML = `
            <label class="form__field">
              <span class="form__label">UF</span>
              <select class="form__input endereco-uf" data-index="${indiceOrdenado}">
                ${createEstadosSelect()}
              </select>
            </label>
            <label class="form__field form__field--wide">
              <span class="form__label">Logradouro/Nome</span>
              <input class="form__input endereco-logradouro" type="text" data-index="${indiceOrdenado}" />
            </label>
            <label class="form__field">
              <span class="form__label">Bairro/Cidade</span>
              <input class="form__input endereco-bairro" type="text" data-index="${indiceOrdenado}" />
            </label>
            <label class="form__field">
              <span class="form__label">CEP</span>
              <input class="form__input endereco-cep" type="text" inputmode="numeric" data-index="${indiceOrdenado}" />
            </label>
            <label class="form__field">
              <span class="form__label">Complemento</span>
              <input class="form__input endereco-complemento" type="text" data-index="${indiceOrdenado}" />
            </label>
          `;

          // Preencher valores salvos para manter sincronia com o formul√°rio
          gridDiv.querySelector('.endereco-uf').value = endereco.uf || '';
          gridDiv.querySelector('.endereco-logradouro').value = endereco.logradouro || '';
          gridDiv.querySelector('.endereco-bairro').value = endereco.bairro || '';
          gridDiv.querySelector('.endereco-cep').value = endereco.cep || '';
          gridDiv.querySelector('.endereco-complemento').value = endereco.complemento || '';

          // Adicionar listeners
          gridDiv.querySelector('.endereco-uf').addEventListener('change', (e) => {
            enderecos[indiceOrdenado].uf = e.target.value;
          });
          gridDiv.querySelector('.endereco-logradouro').addEventListener('input', (e) => {
            enderecos[indiceOrdenado].logradouro = e.target.value;
          });
          gridDiv.querySelector('.endereco-bairro').addEventListener('input', (e) => {
            enderecos[indiceOrdenado].bairro = e.target.value;
          });
          gridDiv.querySelector('.endereco-complemento').addEventListener('input', (e) => {
            enderecos[indiceOrdenado].complemento = e.target.value;
          });
          const cepInput = gridDiv.querySelector('.endereco-cep');
          cepInput.addEventListener('blur', (e) => {
            if (e.target.value?.trim()) {
              mostrarCarregamentoCep(indiceOrdenado, true);
              buscarEnderecoPorCepMultiplo(e.target.value, indiceOrdenado);
            }
          });

          div.appendChild(gridDiv);

          // Adiciona elemento para exibir status de carregamento
          const statusDiv = document.createElement('div');
          statusDiv.className = `cep-status-${indiceOrdenado}`;
          statusDiv.style.cssText = 'margin-top: 0.75rem; font-size: 0.85rem; display: none;';
          div.appendChild(statusDiv);

          listaEl.appendChild(div);
        });
      };

      const adicionarEndereco = () => {
        enderecos.push({
          uf: '',
          logradouro: '',
          bairro: '',
          cep: '',
          complemento: ''
        });

        if (indicadorEnderecoAtual === null && enderecos.length === 1) {
          indicadorEnderecoAtual = 0;
        }

        renderizarEnderecos();
      };

      const buscarEnderecoPorCepMultiplo = async (cep, index) => {
        const somenteNumeros = cep.replace(/\D/g, '');

        if (somenteNumeros.length !== 8) {
          mostrarCarregamentoCep(index, false);
          return;
        }

        try {
          const response = await fetch(`https://viacep.com.br/ws/${somenteNumeros}/json/`);
          const data = await response.json();

          if (data.erro) {
            exibirStatusCep(index, 'CEP n√£o encontrado', 'error');
          } else {
            enderecos[index].uf = data.uf || '';
            enderecos[index].logradouro = data.logradouro || '';
            enderecos[index].bairro = `${data.bairro || ''} ${data.localidade || ''}`.trim();
            enderecos[index].cep = somenteNumeros;
            renderizarEnderecos();
            exibirStatusCep(index, 'Endere√ßo carregado com sucesso', 'success');
          }
        } catch (error) {
          exibirStatusCep(index, 'Erro ao buscar CEP', 'error');
          console.error('Erro ao buscar CEP:', error);
        } finally {
          mostrarCarregamentoCep(index, false);
        }
      };

      const mostrarCarregamentoCep = (index, mostrando) => {
        const statusEl = document.querySelector(`.cep-status-${index}`);
        if (!statusEl) return;

        if (mostrando) {
          statusEl.innerHTML = `
            <div style="display: flex; align-items: center; gap: 0.5rem; color: var(--primary);">
              <div class="spinner" style="width: 16px; height: 16px; border: 2px solid var(--primary); border-top: 2px solid transparent; border-radius: 50%; animation: spin 0.6s linear infinite;"></div>
              <span>Carregando endere√ßo...</span>
            </div>
          `;
          statusEl.style.display = 'block';
        } else {
          statusEl.style.display = 'none';
        }
      };

      const exibirStatusCep = (index, mensagem, tipo) => {
        const statusEl = document.querySelector(`.cep-status-${index}`);
        if (!statusEl) return;

        const cores = {
          success: 'var(--success-text)',
          error: 'var(--error-text)'
        };

        statusEl.innerHTML = `
          <div style="display: flex; align-items: center; gap: 0.5rem; color: ${cores[tipo] || 'var(--text)'};">
            <span>${tipo === 'success' ? '‚úì' : '‚úï'}</span>
            <span>${mensagem}</span>
          </div>
        `;
        statusEl.style.display = 'block';

        // Auto-hide depois de 3 segundos
        setTimeout(() => {
          if (statusEl.style.display !== 'none') {
            statusEl.style.display = 'none';
          }
        }, 3000);
      };

      const preencherFormulario = (pessoa) => {
        Object.entries(pessoa).forEach(([chave, valor]) => {
          if (pessoaForm.elements[chave]) {
            pessoaForm.elements[chave].value = valor || '';
          }
        });

        // Carrega endere√ßos se existirem
        if (pessoa.enderecos && Array.isArray(pessoa.enderecos)) {
          enderecos = JSON.parse(JSON.stringify(pessoa.enderecos));
          indicadorEnderecoAtual = pessoa.endereco_atual_index !== undefined ? pessoa.endereco_atual_index : 0;
          renderizarEnderecos();
        } else {
          enderecos = [];
          indicadorEnderecoAtual = null;
          renderizarEnderecos();
        }

        // Carrega telefones se existirem
        if (pessoa.telefones && Array.isArray(pessoa.telefones)) {
          telefones = JSON.parse(JSON.stringify(pessoa.telefones));
        } else {
          telefones = [];
        }
        renderizarTelefones();

        // Carrega emails se existirem
        if (pessoa.emails && Array.isArray(pessoa.emails)) {
          emails = JSON.parse(JSON.stringify(pessoa.emails));
        } else {
          emails = [];
        }
        renderizarEmails();

        // Carrega redes sociais se existirem
        if (pessoa.redesSociais && Array.isArray(pessoa.redesSociais)) {
          redes = JSON.parse(JSON.stringify(pessoa.redesSociais));
        } else {
          redes = [];
        }
        renderizarRedes();

        // Carrega ve√≠culos se existirem (opcional)
        if (pessoa.veiculos && Array.isArray(pessoa.veiculos)) {
          veiculos = JSON.parse(JSON.stringify(pessoa.veiculos));
        } else {
          veiculos = [];
        }
        renderizarVeiculos();

        // Carrega empresa se existir
        const cnpjEl = document.getElementById('empresa-cnpj');
        if (pessoa.empresa) {
          if (pessoaForm.elements['empresa_cnpj']) pessoaForm.elements['empresa_cnpj'].value = pessoa.empresa.cnpj || '';
          if (pessoaForm.elements['empresa_razaoSocial']) pessoaForm.elements['empresa_razaoSocial'].value = pessoa.empresa.razaoSocial || '';
          if (pessoaForm.elements['empresa_nomeFantasia']) pessoaForm.elements['empresa_nomeFantasia'].value = pessoa.empresa.nomeFantasia || '';
          if (pessoaForm.elements['empresa_naturezaJuridica']) pessoaForm.elements['empresa_naturezaJuridica'].value = pessoa.empresa.naturezaJuridica || '';
          if (pessoaForm.elements['empresa_dataInicioAtividade']) pessoaForm.elements['empresa_dataInicioAtividade'].value = pessoa.empresa.dataInicioAtividade || '';
          if (pessoaForm.elements['empresa_situacaoCadastral']) pessoaForm.elements['empresa_situacaoCadastral'].value = pessoa.empresa.situacaoCadastral || '';
          if (pessoaForm.elements['empresa_endereco']) pessoaForm.elements['empresa_endereco'].value = pessoa.empresa.endereco || '';
          if (pessoaForm.elements['empresa_cep']) pessoaForm.elements['empresa_cep'].value = aplicarMascaraCep(pessoa.empresa.cep || '');
          if (pessoaForm.elements['empresa_telefone']) pessoaForm.elements['empresa_telefone'].value = aplicarMascaraTelefone(pessoa.empresa.telefone || '');
          socios = Array.isArray(pessoa.empresa.socios) ? JSON.parse(JSON.stringify(pessoa.empresa.socios)) : [];
        } else {
          if (pessoaForm.elements['empresa_cnpj']) pessoaForm.elements['empresa_cnpj'].value = '';
          if (pessoaForm.elements['empresa_razaoSocial']) pessoaForm.elements['empresa_razaoSocial'].value = '';
          if (pessoaForm.elements['empresa_nomeFantasia']) pessoaForm.elements['empresa_nomeFantasia'].value = '';
          if (pessoaForm.elements['empresa_naturezaJuridica']) pessoaForm.elements['empresa_naturezaJuridica'].value = '';
          if (pessoaForm.elements['empresa_dataInicioAtividade']) pessoaForm.elements['empresa_dataInicioAtividade'].value = '';
          if (pessoaForm.elements['empresa_situacaoCadastral']) pessoaForm.elements['empresa_situacaoCadastral'].value = '';
          if (pessoaForm.elements['empresa_endereco']) pessoaForm.elements['empresa_endereco'].value = '';
          if (pessoaForm.elements['empresa_telefone']) pessoaForm.elements['empresa_telefone'].value = '';
          socios = [];
        }
        renderizarSocios();

        // Carrega v√≠nculos de empresa (m√∫ltiplos) se existirem
        if (pessoa.vinculos && Array.isArray(pessoa.vinculos.empresas)) {
          vinculosEmpresas = pessoa.vinculos.empresas.map(e =>
            typeof e === 'string'
              ? { nome: e, observacoes: '' }
              : { nome: String(e?.nome || ''), observacoes: String(e?.observacoes || '') }
          );
        } else {
          vinculosEmpresas = [];
        }
        renderizarVinculosEmpresas();
      };


      const atualizarRotuloSubmit = () => {
        submitButton.textContent = pessoaEmEdicao ? 'Salvar' : 'Incluir';
      };

      const renderizarLista = (pessoas = []) => {
        listaPessoasEl.innerHTML = '';

        if (!pessoas.length) {
          listaPessoasEl.innerHTML = '<div class="list__item">Nenhum registro encontrado.</div>';
          return;
        }

        // Cria tabela
        const table = document.createElement('table');
        table.style.width = '100%';
        table.style.borderCollapse = 'collapse';
        table.style.marginTop = '1rem';
        table.innerHTML = `
          <thead>
            <tr style="background: var(--surface-muted);">
              <th style="padding: 0.75rem; border: 1px solid var(--border); text-align: left;">Nome</th>
              <th style="padding: 0.75rem; border: 1px solid var(--border); text-align: left;">CPF</th>
              <th style="padding: 0.75rem; border: 1px solid var(--border); text-align: left;">M√£e</th>
              <th style="padding: 0.75rem; border: 1px solid var(--border); text-align: left;">√öltimo Endere√ßo</th>
              <th style="padding: 0.75rem; border: 1px solid var(--border); text-align: center;">A√ß√µes</th>
            </tr>
          </thead>
          <tbody></tbody>
        `;
        const tbody = table.querySelector('tbody');

        pessoas.forEach((pessoa) => {
          const tr = document.createElement('tr');
          tr.style.borderBottom = '1px solid var(--border)';

          // Nome
          const tdNome = document.createElement('td');
          tdNome.style.padding = '0.75rem';
          tdNome.textContent = pessoa.nomeCompleto || '';
          tr.appendChild(tdNome);

          // CPF
          const tdCpf = document.createElement('td');
          tdCpf.style.padding = '0.75rem';
          tdCpf.textContent = pessoa.cpf || '';
          tr.appendChild(tdCpf);

          // M√£e
          const tdMae = document.createElement('td');
          tdMae.style.padding = '0.75rem';
          tdMae.textContent = pessoa.nomeMae || '';
          tr.appendChild(tdMae);

          // √öltimo Endere√ßo
          const tdEndereco = document.createElement('td');
          tdEndereco.style.padding = '0.75rem';
          let ultimoEndereco = '';
          if (Array.isArray(pessoa.enderecos) && pessoa.enderecos.length > 0) {
            const idx = pessoa.endereco_atual_index !== undefined ? pessoa.endereco_atual_index : pessoa.enderecos.length - 1;
            const end = pessoa.enderecos[idx] || pessoa.enderecos[pessoa.enderecos.length - 1];
            if (end) {
              ultimoEndereco = `${end.logradouro || ''}, ${end.bairro || ''}, ${end.uf || ''}`;
            }
          }
          tdEndereco.textContent = ultimoEndereco;
          tr.appendChild(tdEndereco);

          // A√ß√µes
          const tdAcoes = document.createElement('td');
          tdAcoes.style.padding = '0.75rem';
          tdAcoes.style.display = 'flex';
          tdAcoes.style.gap = '0.5rem';
          tdAcoes.style.justifyContent = 'center';

          const editarBtn = document.createElement('button');
          editarBtn.type = 'button';
          editarBtn.className = 'button button--ghost';
          editarBtn.textContent = 'Editar';
          editarBtn.addEventListener('click', () => {
            pessoaEmEdicao = pessoa.id || pessoa._id;
            preencherFormulario(pessoa);
            atualizarRotuloSubmit();
            exibirMensagem('Editando registro selecionado.', 'info');
          });

          const excluirBtn = document.createElement('button');
          excluirBtn.type = 'button';
          excluirBtn.className = 'button button--danger';
          excluirBtn.textContent = 'Excluir';
          excluirBtn.title = 'Excluir';
          excluirBtn.setAttribute('aria-label', 'Excluir');
          excluirBtn.addEventListener('click', async () => {
            if (!confirm('Deseja realmente excluir este registro?')) return;
            try {
              exibirMensagem('Removendo registro...', 'info');
              const response = await fetchAutenticado(`${API_PESSOAS_URL}/${pessoa.id || pessoa._id}`, {
                method: 'DELETE',
              });
              if (!response.ok) {
                const data = await response.json().catch(() => ({}));
                const erro = data?.mensagem || data?.message || 'Erro ao excluir o registro.';
                throw new Error(erro);
              }
              exibirMensagem('Pessoa exclu√≠da com sucesso!', 'success');
              alert('Pessoa exclu√≠da com sucesso!');
              carregarPessoas();
            } catch (error) {
              exibirMensagem(error?.message || 'N√£o foi poss√≠vel excluir o registro.', 'error');
            }
          });

          tdAcoes.appendChild(editarBtn);
          tdAcoes.appendChild(excluirBtn);
          tr.appendChild(tdAcoes);

          tbody.appendChild(tr);
        });

        listaPessoasEl.appendChild(table);
      };

      const carregarPessoas = async () => {
        try {
          exibirMensagem('Carregando pessoas cadastradas...', 'info');
          const response = await fetchAutenticado(API_PESSOAS_URL);
          const data = await response.json().catch(() => []);

          if (!response.ok) {
            const erro = data?.mensagem || data?.message || 'Erro ao buscar registros.';
            throw new Error(erro);
          }

          renderizarLista(Array.isArray(data) ? data : data?.data || []);
          if (ultimaAcaoFoiEdicao) {
            exibirMensagem('Altera√ß√£o realizada com sucesso!', 'success');
            ultimaAcaoFoiEdicao = false;
          } else {
            exibirMensagem('Lista atualizada.', 'success');
          }
        } catch (error) {
          exibirMensagem(error?.message || 'N√£o foi poss√≠vel carregar a lista.', 'error');
        }
      };

      // Carrega e exibe sempre os 10 registros mais recentes (por atualizadoEm/criadoEm)
      const carregarPessoasRecentes = async () => {
        try {
          exibirMensagem('Carregando √∫ltimos registros...', 'info');
          const response = await fetchAutenticado(API_PESSOAS_URL);
          const data = await response.json().catch(() => []);
          if (!response.ok) {
            const erro = data?.mensagem || data?.message || 'Erro ao buscar registros.';
            throw new Error(erro);
          }
          const lista = Array.isArray(data) ? data : data?.data || [];
          const ordenada = lista
            .slice()
            .sort((a, b) => new Date(b.atualizadoEm || b.criadoEm || 0) - new Date(a.atualizadoEm || a.criadoEm || 0))
            .slice(0, 10);
          renderizarLista(ordenada);
          exibirMensagem('Exibindo os 10 registros mais recentes.', 'success');
        } catch (error) {
          exibirMensagem(error?.message || 'N√£o foi poss√≠vel carregar a lista.', 'error');
        }
      };

      const salvarPessoa = async (event) => {
        event.preventDefault();

        const payload = obterDadosFormulario();
        if (!payload.nomeCompleto?.trim()) {
          exibirMensagem('O campo Nome Completo √© obrigat√≥rio.', 'error');
          return;
        }

        // Valida CPF se preenchido
        if (payload.cpf?.trim()) {
          const validacao = validarCpf(payload.cpf);
          if (!validacao.valido) {
            exibirMensagem(validacao.mensagem, 'error');
            return;
          }
        }

        // Valida CPFs dos s√≥cios, se informados
        if (payload.empresa && Array.isArray(payload.empresa.socios)) {
          for (const s of payload.empresa.socios) {
            const cpfSocio = (s.cpf || '').trim();
            if (cpfSocio) {
              const v = validarCpf(cpfSocio);
              if (!v.valido) {
                exibirMensagemForm(`CPF de s√≥cio inv√°lido: ${cpfSocio}`, 'error');
                return;
              }
            }
          }
        }

        // Valida CPFs dos v√≠nculos (pessoas)
        if (payload.vinculos && Array.isArray(payload.vinculos.pessoas)) {
          for (const v of payload.vinculos.pessoas) {
            const cpf = (v.cpf || '').trim();
            if (cpf) {
              const r = validarCpf(cpf);
              if (!r.valido) {
                exibirMensagemForm(`CPF de v√≠nculo inv√°lido: ${cpf}`, 'error');
                return;
              }
            }
          }
        }

        const metodo = pessoaEmEdicao ? 'PUT' : 'POST';
        const url = pessoaEmEdicao ? `${API_PESSOAS_URL}/${pessoaEmEdicao}` : API_PESSOAS_URL;

        try {
          exibirMensagemForm('Enviando dados...', 'info');
          submitButton.disabled = true;

          const response = await fetchAutenticado(url, {
            method: metodo,
            body: JSON.stringify(payload),
          });

          const data = await response.json().catch(() => ({}));
          if (!response.ok) {
            const erro = data?.mensagem || data?.message || 'Erro ao salvar os dados.';
            throw new Error(erro);
          }

          const foiEdicao = Boolean(pessoaEmEdicao);
          if (foiEdicao) {
            exibirMensagemForm('Atera√ß√µes realizadas com sucesso!', 'success');
            alert('Atera√ß√µes realizadas com sucesso!');
          } else {
            exibirMensagemForm('Pessoa cadastrada com sucesso!', 'success');
            alert('Pessoa cadastrada com sucesso!');
          }
          ultimaAcaoFoiEdicao = foiEdicao;
          pessoaForm.reset();
          pessoaEmEdicao = null;
          atualizarRotuloSubmit();
          // Atualiza lista se o painel estiver vis√≠vel
          if (!document.getElementById('pessoas-panel')?.hidden) {
            carregarPessoasRecentes();
          }
        } catch (error) {
          exibirMensagemForm(error?.message || 'N√£o foi poss√≠vel salvar o registro.', 'error');
        } finally {
          submitButton.disabled = false;
        }
      };

      const inicializarCadastro = () => {
        const token = obterToken();
        if (!token) {
          exibirMensagem('Sess√£o expirada. Fa√ßa login para continuar.', 'warning');
          setTimeout(() => {
            window.location.href = '/';
          }, 800);
          return;
        }

        atualizarRotuloSubmit();
        pessoaForm.addEventListener('submit', salvarPessoa);
        listarButton.addEventListener('click', () => {
          const painel = document.getElementById('pessoas-panel');
          if (painel) painel.hidden = false;
          carregarPessoasRecentes();
        });
        pessoaForm.addEventListener('reset', () => {
          pessoaEmEdicao = null;
          atualizarRotuloSubmit();
          exibirMensagemForm('Formul√°rio limpo. Pronto para novo cadastro.', 'info');
          enderecos = [];
          indicadorEnderecoAtual = null;
          renderizarEnderecos();
          telefones = [];
          renderizarTelefones();
          emails = [];
          renderizarEmails();
          redes = [];
          renderizarRedes();
          veiculos = [];
          renderizarVeiculos();
          socios = [];
          renderizarSocios();
          vinculosPessoas = [];
          renderizarVinculosPessoas();
          vinculosEmpresas = [];
          renderizarVinculosEmpresas();
        });
        cpfInput?.addEventListener('input', aplicarMascaraCpf);

        // Event listener para adicionar novo endere√ßo
        const adicionarEnderecoBtn = document.getElementById('adicionar-endereco');
        adicionarEnderecoBtn?.addEventListener('click', adicionarEndereco);

        // Event listener para adicionar novo telefone
        const adicionarTelefoneBtn = document.getElementById('adicionar-telefone');
        adicionarTelefoneBtn?.addEventListener('click', adicionarTelefone);

        // Event listeners para adicionar email e rede social
        const adicionarEmailBtn = document.getElementById('adicionar-email');
        adicionarEmailBtn?.addEventListener('click', adicionarEmail);
        const adicionarRedeBtn = document.getElementById('adicionar-rede');
        adicionarRedeBtn?.addEventListener('click', adicionarRede);

        // Event listener para adicionar novo ve√≠culo
        const adicionarVeiculoBtn = document.getElementById('adicionar-veiculo');
        adicionarVeiculoBtn?.addEventListener('click', adicionarVeiculo);

        // Event listener para adicionar s√≥cio
        const adicionarSocioBtn = document.getElementById('adicionar-socio');
        adicionarSocioBtn?.addEventListener('click', adicionarSocio);

        // Event listener para adicionar v√≠nculo pessoa
        const addVincPessoaBtn = document.getElementById('adicionar-vinculo-pessoa');
        addVincPessoaBtn?.addEventListener('click', adicionarVinculoPessoa);

        // Event listener para adicionar v√≠nculo empresa
        const addVincEmpresaBtn = document.getElementById('adicionar-vinculo-empresa');
        addVincEmpresaBtn?.addEventListener('click', adicionarVinculoEmpresa);

        // M√°scara CNPJ
        const cnpjInput = document.getElementById('empresa-cnpj');
        cnpjInput?.addEventListener('input', (e) => { e.target.value = aplicarMascaraCnpj(e.target.value); });

        // M√°scara telefone empresa
        const empTel = document.getElementById('empresa-telefone');
        empTel?.addEventListener('input', (e) => { e.target.value = aplicarMascaraTelefone(e.target.value); });

        // M√°scara CEP empresa
        const empCep = document.getElementById('empresa-cep');
        empCep?.addEventListener('input', (e) => { e.target.value = aplicarMascaraCep(e.target.value); });

        renderizarTelefones();
        renderizarEmails();
        renderizarRedes();
        renderizarVeiculos();
        renderizarVinculosPessoas();
        renderizarVinculosEmpresas();
        // Lista fica oculta at√© o usu√°rio clicar em "Listar"
      };

      document.addEventListener('DOMContentLoaded', inicializarCadastro);
    </script>
  </body>
</html>
