<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cadastro de Pessoas | Projeto Coruja</title>
    <link rel="stylesheet" href="/css/main.css" />
  </head>
  <body class="theme-dark">
    <div class="app">
      <aside class="sidebar">
        <div class="sidebar__header">
          <div class="sidebar__brand">Projeto Coruja</div>
          <!-- Bot칚o dedicado para alternar entre tema claro e escuro -->
          <button
            class="theme-toggle"
            type="button"
            data-theme-toggle
            aria-pressed="false"
            aria-label="Alternar tema visual"
          >
            <span class="theme-toggle__icon" aria-hidden="true" data-theme-icon>游깿</span>
            <span class="theme-toggle__label" data-theme-label>Modo escuro</span>
          </button>
        </div>
        <nav class="sidebar__nav" aria-label="Menu principal">
          <a class="sidebar__link" href="/home">Home</a>
          <a class="sidebar__link" href="/perfil">Perfil de Usu치rio</a>
          <a class="sidebar__link" href="/usuarios">Usu치rios</a>
          <details class="sidebar__section sidebar__section--active" open>
            <summary class="sidebar__link sidebar__link--parent" aria-label="Abrir menu Cadastro">Cadastro</summary>
            <div class="sidebar__subnav">
              <a class="sidebar__link sidebar__link--child sidebar__link--active" href="/cadastro/pessoas">Pessoas</a>
              <a class="sidebar__link sidebar__link--child" href="/cadastro/empresas">Empresas</a>
            </div>
          </details>
        </nav>
        <div class="sidebar__footer">
          <button id="logout-button" class="sidebar__logout" type="button">Sair</button>
        </div>
      </aside>

      <main class="content" data-page="cadastro-pessoas">
        <header class="content__header">
          <p class="content__eyebrow">Cadastro</p>          
        </header>

        <section class="panel" aria-label="Formul치rio de dados de pessoas">
          <div class="panel__header panel__header--stacked">
          </div>

          <form class="form" id="pessoa-form" action="#" method="post">
            <div class="form__section">
              <div class="form__section-header">
                <h3 class="form__section-title">Identifica칞칚o</h3>
              </div>
              <div class="form__grid form__grid--2">
                <label class="form__field">
                  <span class="form__label">Nome Completo</span>
                  <input class="form__input" type="text" name="nomeCompleto" required />
                </label>
                <label class="form__field">
                  <span class="form__label">Data de Nascimento</span>
                  <input class="form__input" type="date" name="dataNascimento" />
                </label>
              </div>
              <div class="form__grid form__grid--3">
                <label class="form__field">
                  <span class="form__label">CPF</span>
                  <input class="form__input" type="text" name="cpf" inputmode="numeric" />
                  <span id="erro-cpf" class="form__error" style="display: none;">CPF inv치lido!</span>
                </label>
                <label class="form__field">
                  <span class="form__label">RG</span>
                  <input class="form__input" type="text" name="rg" inputmode="numeric" />
                </label>
                <label class="form__field">
                  <span class="form__label">CNH</span>
                  <input class="form__input" type="text" name="cnh" inputmode="numeric" />
                </label>
              </div>
            </div>

            <div class="form__section">
              <div class="form__section-header">
                <h3 class="form__section-title">Contato e filia칞칚o</h3>
              </div>
              <div class="form__grid form__grid--3">
                <label class="form__field">
                  <span class="form__label">Nome da M칚e</span>
                  <input class="form__input" type="text" name="nomeMae" />
                </label>
                <label class="form__field">
                  <span class="form__label">Nome do Pai</span>
                  <input class="form__input" type="text" name="nomePai" />
                </label>
                <label class="form__field">
                  <span class="form__label">Telefone</span>
                  <input class="form__input" type="tel" name="telefone" inputmode="tel" />
                </label>
              </div>
            </div>

            <div class="form__section">
              <div class="form__section-header">
                <h3 class="form__section-title">칔ltimo endere칞o</h3>
              </div>
              <div class="form__grid form__grid--4">
                <label class="form__field">
                  <span class="form__label">UF</span>
                  <select class="form__input" name="ultimoUf">
                    <option value="">Selecione</option>
                    <option value="AC">Acre (AC)</option>
                    <option value="AL">Alagoas (AL)</option>
                    <option value="AP">Amap치 (AP)</option>
                    <option value="AM">Amazonas (AM)</option>
                    <option value="BA">Bahia (BA)</option>
                    <option value="CE">Cear치 (CE)</option>
                    <option value="DF">Distrito Federal (DF)</option>
                    <option value="ES">Esp칤rito Santo (ES)</option>
                    <option value="GO">Goi치s (GO)</option>
                    <option value="MA">Maranh칚o (MA)</option>
                    <option value="MT">Mato Grosso (MT)</option>
                    <option value="MS">Mato Grosso do Sul (MS)</option>
                    <option value="MG">Minas Gerais (MG)</option>
                    <option value="PA">Par치 (PA)</option>
                    <option value="PB">Para칤ba (PB)</option>
                    <option value="PR">Paran치 (PR)</option>
                    <option value="PE">Pernambuco (PE)</option>
                    <option value="PI">Piau칤 (PI)</option>
                    <option value="RJ">Rio de Janeiro (RJ)</option>
                    <option value="RN">Rio Grande do Norte (RN)</option>
                    <option value="RS">Rio Grande do Sul (RS)</option>
                    <option value="RO">Rond칪nia (RO)</option>
                    <option value="RR">Roraima (RR)</option>
                    <option value="SC">Santa Catarina (SC)</option>
                    <option value="SP">S칚o Paulo (SP)</option>
                    <option value="SE">Sergipe (SE)</option>
                    <option value="TO">Tocantins (TO)</option>
                  </select>
                </label>
                <label class="form__field form__field--wide">
                  <span class="form__label">Logradouro/Nome</span>
                  <input class="form__input" type="text" name="ultimoLogradouro" />
                </label>
                <label class="form__field">
                  <span class="form__label">Bairro/Cidade</span>
                  <input class="form__input" type="text" name="ultimoBairroCidade" />
                </label>
                <label class="form__field">
                  <span class="form__label">CEP</span>
                  <input class="form__input" type="text" name="ultimoCep" inputmode="numeric" />
                </label>
              </div>
            </div>

            <div class="form__section">
              <div class="form__section-header">
                <h3 class="form__section-title">Endere칞o atual</h3>
              </div>
              <div class="form__grid form__grid--4">
                <label class="form__field">
                  <span class="form__label">UF</span>
                  <select class="form__input" name="enderecoUf">
                    <option value="">Selecione</option>
                    <option value="AC">Acre (AC)</option>
                    <option value="AL">Alagoas (AL)</option>
                    <option value="AP">Amap치 (AP)</option>
                    <option value="AM">Amazonas (AM)</option>
                    <option value="BA">Bahia (BA)</option>
                    <option value="CE">Cear치 (CE)</option>
                    <option value="DF">Distrito Federal (DF)</option>
                    <option value="ES">Esp칤rito Santo (ES)</option>
                    <option value="GO">Goi치s (GO)</option>
                    <option value="MA">Maranh칚o (MA)</option>
                    <option value="MT">Mato Grosso (MT)</option>
                    <option value="MS">Mato Grosso do Sul (MS)</option>
                    <option value="MG">Minas Gerais (MG)</option>
                    <option value="PA">Par치 (PA)</option>
                    <option value="PB">Para칤ba (PB)</option>
                    <option value="PR">Paran치 (PR)</option>
                    <option value="PE">Pernambuco (PE)</option>
                    <option value="PI">Piau칤 (PI)</option>
                    <option value="RJ">Rio de Janeiro (RJ)</option>
                    <option value="RN">Rio Grande do Norte (RN)</option>
                    <option value="RS">Rio Grande do Sul (RS)</option>
                    <option value="RO">Rond칪nia (RO)</option>
                    <option value="RR">Roraima (RR)</option>
                    <option value="SC">Santa Catarina (SC)</option>
                    <option value="SP">S칚o Paulo (SP)</option>
                    <option value="SE">Sergipe (SE)</option>
                    <option value="TO">Tocantins (TO)</option>
                  </select>
                </label>
                <label class="form__field form__field--wide">
                  <span class="form__label">Logradouro/Nome</span>
                  <input class="form__input" type="text" name="enderecoLogradouro" />
                </label>
                <label class="form__field">
                  <span class="form__label">Bairro/Cidade</span>
                  <input class="form__input" type="text" name="enderecoBairroCidade" />
                </label>
                <label class="form__field">
                  <span class="form__label">CEP</span>
                  <input class="form__input" type="text" name="enderecoCep" inputmode="numeric" />
                </label>
              </div>
            </div>

            <div class="form__actions">
              <button class="button button--secondary" type="reset">Limpar</button>
              <button class="button button--ghost" id="listar-pessoas" type="button">Listar</button>
              <button class="button button--primary" id="submit-pessoa" type="submit">Salvar dados</button>
            </div>
          </form>
        </section>

        <section class="panel" aria-label="Lista de pessoas cadastradas">
          <div class="panel__header panel__header--stacked">
            <div>
              <h2 class="panel__title">Lista de pessoas cadastradas</h2>
              <p class="panel__meta">Gerencie as edi칞칫es ou exclus칫es diretamente na listagem</p>
            </div>
          </div>

          <div id="pessoas-message" class="message" role="status" aria-live="polite"></div>

          <ul id="pessoas-lista" class="list" aria-live="polite"></ul>
        </section>
      </main>
    </div>

    <script src="/js/main.js"></script>
    <script>
      const API_PESSOAS_URL = '/api/pessoas';
      const pessoaForm = document.getElementById('pessoa-form');
      const submitButton = document.getElementById('submit-pessoa');
      const listarButton = document.getElementById('listar-pessoas');
      const listaPessoasEl = document.getElementById('pessoas-lista');
      const messageEl = document.getElementById('pessoas-message');
      const cpfInput = pessoaForm?.elements['cpf'];
      let pessoaEmEdicao = null;

      const obterToken = () => localStorage.getItem('authToken');

      const fetchAutenticado = (url, options = {}) => {
        const token = obterToken();
        const headers = {
          'Content-Type': 'application/json',
          ...(options.headers || {}),
          ...(token ? { Authorization: `Bearer ${token}` } : {}),
        };

        return fetch(url, { ...options, headers });
      };

      const exibirMensagem = (texto, tipo = 'info') => {
        if (!messageEl) return;
        messageEl.textContent = texto || '';
        messageEl.className = 'message';
        if (texto) messageEl.classList.add(`message--${tipo}`);
      };

      const obterDadosFormulario = () => {
        const formData = new FormData(pessoaForm);
        return Object.fromEntries(formData.entries());
      };

      const aplicarMascaraCpf = (event) => {
        // Garante que apenas n칰meros sejam digitados e aplica a m치scara padr칚o de CPF
        const somenteNumeros = event.target.value.replace(/\D/g, '').slice(0, 11);

        let valorMascarado = somenteNumeros;
        if (somenteNumeros.length > 3) {
          valorMascarado = `${somenteNumeros.slice(0, 3)}.${somenteNumeros.slice(3, 6)}`;
        }
        if (somenteNumeros.length > 6) {
          valorMascarado = `${valorMascarado}.${somenteNumeros.slice(6, 9)}`;
        }
        if (somenteNumeros.length > 9) {
          valorMascarado = `${valorMascarado}-${somenteNumeros.slice(9, 11)}`;
        }

        event.target.value = valorMascarado;

        // Valida CPF em tempo real quando completo (11 d칤gitos)
        const erroEl = document.getElementById('erro-cpf');
        if (somenteNumeros.length === 11) {
          const validacao = validarCpf(valorMascarado);
          if (!validacao.valido) {
            erroEl.style.display = 'block';
            erroEl.textContent = 'CPF inv치lido!';
          } else {
            erroEl.style.display = 'none';
          }
        } else if (somenteNumeros.length > 0) {
          // Mostra erro se n칚o est치 completo e o usu치rio parou de digitar
          erroEl.style.display = 'none';
        }
      };

      const validarCpf = (cpf) => {
        // Remove caracteres n칚o num칠ricos
        const somenteNumeros = cpf.replace(/\D/g, '');

        // Valida comprimento
        if (somenteNumeros.length !== 11) {
          return { valido: false, mensagem: 'CPF deve ter 11 d칤gitos.' };
        }

        // Valida se todos os d칤gitos s칚o iguais
        if (/^(\d)\1{10}$/.test(somenteNumeros)) {
          return { valido: false, mensagem: 'CPF inv치lido: todos os d칤gitos s칚o iguais.' };
        }

        // Calcula primeiro d칤gito verificador
        let soma = 0;
        for (let i = 0; i < 9; i++) {
          soma += parseInt(somenteNumeros[i]) * (10 - i);
        }
        let primeiroDigito = 11 - (soma % 11);
        primeiroDigito = primeiroDigito > 9 ? 0 : primeiroDigito;

        // Valida primeiro d칤gito verificador
        if (parseInt(somenteNumeros[9]) !== primeiroDigito) {
          return { valido: false, mensagem: 'CPF inv치lido: primeiro d칤gito verificador incorreto.' };
        }

        // Calcula segundo d칤gito verificador
        soma = 0;
        for (let i = 0; i < 10; i++) {
          soma += parseInt(somenteNumeros[i]) * (11 - i);
        }
        let segundoDigito = 11 - (soma % 11);
        segundoDigito = segundoDigito > 9 ? 0 : segundoDigito;

        // Valida segundo d칤gito verificador
        if (parseInt(somenteNumeros[10]) !== segundoDigito) {
          return { valido: false, mensagem: 'CPF inv치lido: segundo d칤gito verificador incorreto.' };
        }

        return { valido: true, mensagem: 'CPF v치lido.' };
      };

      const preencherFormulario = (pessoa) => {
        Object.entries(pessoa).forEach(([chave, valor]) => {
          if (pessoaForm.elements[chave]) {
            pessoaForm.elements[chave].value = valor || '';
          }
        });
      };

      const atualizarRotuloSubmit = () => {
        submitButton.textContent = pessoaEmEdicao ? 'Atualizar dados' : 'Salvar dados';
      };

      const renderizarLista = (pessoas = []) => {
        listaPessoasEl.innerHTML = '';

        if (!pessoas.length) {
          listaPessoasEl.innerHTML = '<li class="list__item">Nenhum registro encontrado.</li>';
          return;
        }

        pessoas.forEach((pessoa) => {
          const item = document.createElement('li');
          item.className = 'list__item';

          const titulo = document.createElement('p');
          titulo.className = 'list__title';
          titulo.textContent = pessoa.nomeCompleto || 'Pessoa sem nome';
          item.appendChild(titulo);

          const actions = document.createElement('div');
          actions.className = 'list__actions';

          const editarBtn = document.createElement('button');
          editarBtn.type = 'button';
          editarBtn.className = 'button button--ghost';
          editarBtn.textContent = 'Editar';
          editarBtn.addEventListener('click', () => {
            pessoaEmEdicao = pessoa.id || pessoa._id;
            preencherFormulario(pessoa);
            atualizarRotuloSubmit();
            exibirMensagem('Editando registro selecionado.', 'info');
          });

          const excluirBtn = document.createElement('button');
          excluirBtn.type = 'button';
          excluirBtn.className = 'button button--danger';
          excluirBtn.textContent = 'Excluir';
          excluirBtn.addEventListener('click', async () => {
            if (!confirm('Deseja realmente excluir este registro?')) return;
            try {
              exibirMensagem('Removendo registro...', 'info');
              const response = await fetchAutenticado(`${API_PESSOAS_URL}/${pessoa.id || pessoa._id}`, {
                method: 'DELETE',
              });
              if (!response.ok) {
                const data = await response.json().catch(() => ({}));
                const erro = data?.mensagem || data?.message || 'Erro ao excluir o registro.';
                throw new Error(erro);
              }
              exibirMensagem('Registro exclu칤do com sucesso.', 'success');
              carregarPessoas();
            } catch (error) {
              exibirMensagem(error?.message || 'N칚o foi poss칤vel excluir o registro.', 'error');
            }
          });

          actions.appendChild(editarBtn);
          actions.appendChild(excluirBtn);
          item.appendChild(actions);

          listaPessoasEl.appendChild(item);
        });
      };

      const carregarPessoas = async () => {
        try {
          exibirMensagem('Carregando pessoas cadastradas...', 'info');
          const response = await fetchAutenticado(API_PESSOAS_URL);
          const data = await response.json().catch(() => []);

          if (!response.ok) {
            const erro = data?.mensagem || data?.message || 'Erro ao buscar registros.';
            throw new Error(erro);
          }

          renderizarLista(Array.isArray(data) ? data : data?.data || []);
          exibirMensagem('Lista atualizada.', 'success');
        } catch (error) {
          exibirMensagem(error?.message || 'N칚o foi poss칤vel carregar a lista.', 'error');
        }
      };

      const salvarPessoa = async (event) => {
        event.preventDefault();

        const payload = obterDadosFormulario();
        if (!payload.nomeCompleto?.trim()) {
          exibirMensagem('O campo Nome Completo 칠 obrigat칩rio.', 'error');
          return;
        }

        // Valida CPF se preenchido
        if (payload.cpf?.trim()) {
          const validacao = validarCpf(payload.cpf);
          if (!validacao.valido) {
            exibirMensagem(validacao.mensagem, 'error');
            return;
          }
        }

        const metodo = pessoaEmEdicao ? 'PUT' : 'POST';
        const url = pessoaEmEdicao ? `${API_PESSOAS_URL}/${pessoaEmEdicao}` : API_PESSOAS_URL;

        try {
          exibirMensagem('Enviando dados...', 'info');
          submitButton.disabled = true;

          const response = await fetchAutenticado(url, {
            method: metodo,
            body: JSON.stringify(payload),
          });

          const data = await response.json().catch(() => ({}));
          if (!response.ok) {
            const erro = data?.mensagem || data?.message || 'Erro ao salvar os dados.';
            throw new Error(erro);
          }

          exibirMensagem(
            pessoaEmEdicao ? 'Dados atualizados com sucesso.' : 'Registro criado com sucesso.',
            'success'
          );
          pessoaForm.reset();
          pessoaEmEdicao = null;
          atualizarRotuloSubmit();
          carregarPessoas();
        } catch (error) {
          exibirMensagem(error?.message || 'N칚o foi poss칤vel salvar o registro.', 'error');
        } finally {
          submitButton.disabled = false;
        }
      };

      const inicializarCadastro = () => {
        atualizarRotuloSubmit();
        pessoaForm.addEventListener('submit', salvarPessoa);
        listarButton.addEventListener('click', carregarPessoas);
        pessoaForm.addEventListener('reset', () => {
          pessoaEmEdicao = null;
          atualizarRotuloSubmit();
          exibirMensagem('Formul치rio limpo. Pronto para novo cadastro.', 'info');
        });
        cpfInput?.addEventListener('input', aplicarMascaraCpf);
        carregarPessoas();
      };

      document.addEventListener('DOMContentLoaded', inicializarCadastro);
    </script>
  </body>
</html>
