<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cadastro de Ve√≠culos | Projeto Coruja</title>
    <link rel="stylesheet" href="/css/main.css" />
  </head>
  <body class="theme-dark">
    <div class="app">
      <div class="user-menu" id="user-menu" aria-expanded="false">
        <button class="user-menu__button" type="button" id="user-menu-button" aria-haspopup="true" aria-expanded="false">
          <span class="user-menu__avatar" id="user-avatar" aria-hidden="true">U</span>
          <span id="user-button-name">Usu√°rio</span>
        </button>
        <div class="user-menu__dropdown" id="user-menu-dropdown" role="menu" aria-label="Menu do usu√°rio">
          <div class="user-menu__item"><span class="user-menu__label">Nome Completo:</span><span class="user-menu__value" id="um-nome">‚Äî</span></div>
          <div class="user-menu__item"><span class="user-menu__label">Email:</span><span class="user-menu__value" id="um-email">‚Äî</span></div>
          <div class="user-menu__item"><span class="user-menu__label">Perfil:</span><span class="user-menu__value" id="um-perfil">‚Äî</span></div>
          <div class="user-menu__separator"></div>
          <div class="user-menu__item"><span class="user-menu__label">Senha:</span><span class="user-menu__link" id="um-alterar-senha">Alterar senha</span></div>
          <div class="user-menu__separator"></div>
          <div class="user-menu__item"><span class="user-menu__link" id="um-sair">Sair</span></div>
        </div>
      </div>
      <aside class="sidebar">
        <div class="sidebar__header">
          <div class="sidebar__brand">Projeto Coruja</div>
          <!-- Bot√£o dedicado para alternar entre tema claro e escuro -->
          <button
            class="theme-toggle"
            type="button"
            data-theme-toggle
            aria-pressed="false"
            aria-label="Alternar tema visual"
          >
            <span class="theme-toggle__icon" aria-hidden="true" data-theme-icon>üåô</span>
            <span class="theme-toggle__label" data-theme-label>Modo escuro</span>
          </button>
        </div>
        <nav class="sidebar__nav" aria-label="Menu principal">
          <a class="sidebar__link" href="/home">Home</a>
          <a class="sidebar__link" href="/usuarios">Usu√°rios</a>
          <details class="sidebar__section sidebar__section--active" open>
            <summary class="sidebar__link sidebar__link--parent" aria-label="Abrir menu Cadastro">Cadastro</summary>
            <div class="sidebar__subnav">
              <a class="sidebar__link sidebar__link--child" href="/cadastro/pessoas">Pessoas</a>
              <a class="sidebar__link sidebar__link--child" href="/cadastro/empresas">Empresas</a>
              <a class="sidebar__link sidebar__link--child" href="/cadastro/entidades">Entidades</a>
              
            </div>
          </details>
          <details class="sidebar__section">
            <summary class="sidebar__link sidebar__link--parent" aria-label="Abrir menu Consulta">Consulta</summary>
            <div class="sidebar__subnav">
              <a class="sidebar__link sidebar__link--child" href="/consulta/pessoas">Pessoas</a>
              <a class="sidebar__link sidebar__link--child" href="/consulta/empresas">Empresas</a>
              <a class="sidebar__link sidebar__link--child" href="/consulta/veiculos">Ve√≠culos</a>
            </div>
          </details>
        </nav>
      </aside>

      <main class="content" data-page="cadastro-veiculos">
        <header class="content__header">
          <p class="content__eyebrow">Cadastro</p>
          <h1 class="content__title">Ve√≠culos</h1>
        </header>

        <section class="panel" aria-label="Formul√°rio de ve√≠culos">
          <div class="panel__header panel__header--stacked"></div>
          <div id="veiculo-form-message" class="message" role="status" aria-live="polite"></div>
          <form class="form" id="veiculo-form" action="/api/veiculos" method="post">
            <div class="form__grid form__grid--2">
              <label class="form__field">
                <span class="form__label">Nome do Propriet√°rio</span>
                <input class="form__input" type="text" name="nomeProprietario" id="campo-nome" />
              </label>
              <label class="form__field">
                <span class="form__label">CPF</span>
                <input class="form__input" type="text" name="cpf" id="campo-cpf" inputmode="numeric" placeholder="000.000.000-00" />
                <span id="erro-cpf-veiculo" class="form__error" style="display: none;">CPF inv√°lido!</span>
              </label>
            </div>
            <div class="form__grid form__grid--3">
              <label class="form__field">
                <span class="form__label">Placa</span>
                <input class="form__input" type="text" name="placa" id="campo-placa" required maxlength="7" placeholder="ABC1D23" />
              </label>
              <label class="form__field">
                <span class="form__label">Marca/Modelo</span>
                <input class="form__input" type="text" name="marcaModelo" id="campo-marca" />
              </label>
              <label class="form__field">
                <span class="form__label">Cor</span>
                <input class="form__input" type="text" name="cor" id="campo-cor" />
              </label>
            </div>
            <div class="form__grid form__grid--3">
              <label class="form__field">
                <span class="form__label">Ano/Modelo</span>
                <input class="form__input" type="number" name="anoModelo" id="campo-ano" min="1900" max="2100" placeholder="2024" />
              </label>
            </div>
            <!-- Endere√ßos do ve√≠culo -->
            <div class="form__section" aria-label="Endere√ßos do ve√≠culo">
              <div class="form__section-header" style="display:flex; justify-content: space-between; align-items: center;">
                <h3 class="form__section-title" style="font-size:1rem; margin:0;">Endere√ßos</h3>
                <button class="button button--secondary" id="adicionar-endereco-veiculo" type="button">+</button>
              </div>
              <div id="lista-enderecos-veiculo" class="form__section-body" style="display:flex; flex-direction:column; gap:0.75rem;"></div>
            </div>
            <div class="form__actions">
              <button class="button button--primary" id="submit-veiculo" type="submit">Incluir</button>
              <button class="button button--secondary" id="btn-listar" type="button">Listar</button>
              <button class="button" id="btn-limpar" type="reset">Limpar</button>
            </div>
          </form>
        </section>

        <section class="panel" aria-label="Listagem de ve√≠culos">
          <div class="panel__header panel__header--stacked">
            <h3 class="panel__title">Ve√≠culos cadastrados</h3>
            <div class="panel__actions page-actions">
              <input
                type="text"
                id="campo-busca"
                class="search-input"
                placeholder="Buscar por propriet√°rio, placa, marca ou cor"
                aria-label="Campo de busca de ve√≠culos"
              />
            </div>
          </div>
          <div id="veiculos-message" class="message" role="status" aria-live="polite"></div>
          <div class="panel__body">
            <div id="lista-veiculos" class="list"></div>
          </div>
        </section>
      </main>
    </div>

    <script src="/js/main.js"></script>
    <script>
      // API base para opera√ß√µes com ve√≠culos
      const API_VEICULOS = '/api/veiculos';
      const form = document.getElementById('veiculo-form');
      const formMsgEl = document.getElementById('veiculo-form-message');
      const listaEl = document.getElementById('lista-veiculos');
      const mensagemListaEl = document.getElementById('veiculos-message');
      const submitBtn = document.getElementById('submit-veiculo');
      const campoBusca = document.getElementById('campo-busca');
      const campoCpf = document.getElementById('campo-cpf');
      const campoPlaca = document.getElementById('campo-placa');
      let enderecosVeiculo = [];
      let veiculoEmEdicao = null;
      let veiculosCache = [];

      // Recupera token JWT armazenado para chamadas autenticadas
      const getCookie = (name) => document.cookie.split(';').map(c => c.trim()).find(c => c.startsWith(`${name}=`))?.split('=')[1];
      const obterToken = () => localStorage.getItem('authToken') || getCookie('authToken');
      const fetchAutenticado = (url, options = {}) => {
        const token = obterToken();
        const headers = {
          'Content-Type': 'application/json',
          ...(options.headers || {}),
          ...(token ? { Authorization: `Bearer ${token}` } : {}),
        };
        return fetch(url, { ...options, headers });
      };

      // Exibe mensagens padronizadas para feedback r√°pido
      const exibirMensagem = (elemento, texto, tipo = 'info') => {
        if (!elemento) return;
        elemento.textContent = texto || '';
        elemento.className = 'message';
        if (texto) elemento.classList.add(`message--${tipo}`);
      };

      // Aplica m√°scara e valida√ß√£o de CPF igual √† tela de Pessoas
      const aplicarMascaraCpf = (event) => {
        const somenteNumeros = event.target.value.replace(/\D/g, '').slice(0, 11);
        let valorMascarado = somenteNumeros;
        if (somenteNumeros.length > 3) {
          valorMascarado = `${somenteNumeros.slice(0, 3)}.${somenteNumeros.slice(3, 6)}`;
        }
        if (somenteNumeros.length > 6) {
          valorMascarado = `${valorMascarado}.${somenteNumeros.slice(6, 9)}`;
        }
        if (somenteNumeros.length > 9) {
          valorMascarado = `${valorMascarado}-${somenteNumeros.slice(9, 11)}`;
        }
        event.target.value = valorMascarado;

        const erroEl = document.getElementById('erro-cpf-veiculo');
        if (somenteNumeros.length === 11) {
          const validacao = validarCpf(valorMascarado);
          if (!validacao.valido) {
            erroEl.style.display = 'block';
            erroEl.textContent = 'CPF inv√°lido';
          } else {
            erroEl.style.display = 'none';
          }
        } else {
          erroEl.style.display = 'none';
        }
      };

      // Valida√ß√£o de CPF replicando a l√≥gica do cadastro de pessoas
      const validarCpf = (cpf) => {
        const somenteNumeros = cpf.replace(/\D/g, '');
        if (somenteNumeros.length !== 11) {
          return { valido: false, mensagem: 'CPF deve ter 11 d√≠gitos.' };
        }
        if (/^(\d)\1{10}$/.test(somenteNumeros)) {
          return { valido: false, mensagem: 'CPF inv√°lido: todos os d√≠gitos s√£o iguais.' };
        }
        let soma = 0;
        for (let i = 0; i < 9; i++) {
          soma += parseInt(somenteNumeros[i]) * (10 - i);
        }
        let primeiroDigito = 11 - (soma % 11);
        primeiroDigito = primeiroDigito > 9 ? 0 : primeiroDigito;
        if (parseInt(somenteNumeros[9]) !== primeiroDigito) {
          return { valido: false, mensagem: 'CPF inv√°lido: primeiro d√≠gito verificador incorreto.' };
        }
        soma = 0;
        for (let i = 0; i < 10; i++) {
          soma += parseInt(somenteNumeros[i]) * (11 - i);
        }
        let segundoDigito = 11 - (soma % 11);
        segundoDigito = segundoDigito > 9 ? 0 : segundoDigito;
        if (parseInt(somenteNumeros[10]) !== segundoDigito) {
          return { valido: false, mensagem: 'CFP inv√°lido' };
        }
        return { valido: true, mensagem: 'CPF v√°lido.' };
      };

      // Normaliza os dados enviados ao backend
      const montarPayload = () => {
        const formData = new FormData(form);
        const dados = Object.fromEntries(formData.entries());
        const cpfLimpo = dados.cpf ? dados.cpf.replace(/\D/g, '') : null;
        return {
          nomeProprietario: dados.nomeProprietario?.trim(),
          cpf: cpfLimpo,
          placa: dados.placa?.toUpperCase().trim(),
          marcaModelo: dados.marcaModelo?.trim(),
          cor: dados.cor?.trim(),
          anoModelo: dados.anoModelo?.trim(),
          enderecos: enderecosVeiculo.map((e) => ({
            uf: String(e.uf||'').trim() || null,
            logradouro: String(e.logradouro||'').trim() || null,
            bairro: String(e.bairro||'').trim() || null,
            complemento: String(e.complemento||'').trim() || null,
            cep: String(e.cep||'').replace(/\D/g,'').slice(0,8) || null,
            latLong: String(e.latLong||'').trim() || null,
          })).filter((e) => Object.values(e).some(v => v))
        };
      };

      const createEstadosSelect = () => {
        return `<option value="">Selecione</option>
                    <option value="AC">Acre (AC)</option>
                    <option value="AL">Alagoas (AL)</option>
                    <option value="AP">Amap√° (AP)</option>
                    <option value="AM">Amazonas (AM)</option>
                    <option value="BA">Bahia (BA)</option>
                    <option value="CE">Cear√° (CE)</option>
                    <option value="DF">Distrito Federal (DF)</option>
                    <option value="ES">Esp√≠rito Santo (ES)</option>
                    <option value="GO">Goi√°s (GO)</option>
                    <option value="MA">Maranh√£o (MA)</option>
                    <option value="MT">Mato Grosso (MT)</option>
                    <option value="MS">Mato Grosso do Sul (MS)</option>
                    <option value="MG">Minas Gerais (MG)</option>
                    <option value="PA">Par√° (PA)</option>
                    <option value="PB">Para√≠ba (PB)</option>
                    <option value="PR">Paran√° (PR)</option>
                    <option value="PE">Pernambuco (PE)</option>
                    <option value="PI">Piau√≠ (PI)</option>
                    <option value="RJ">Rio de Janeiro (RJ)</option>
                    <option value="RN">Rio Grande do Norte (RN)</option>
                    <option value="RS">Rio Grande do Sul (RS)</option>
                    <option value="RO">Rond√¥nia (RO)</option>
                    <option value="RR">Roraima (RR)</option>
                    <option value="SC">Santa Catarina (SC)</option>
                    <option value="SP">S√£o Paulo (SP)</option>
                    <option value="SE">Sergipe (SE)</option>
                    <option value="TO">Tocantins (TO)</option>`;
      };

      const aplicarMascaraCep = (valor) => {
        const dig = String(valor||'').replace(/\D/g,'').slice(0,8);
        return dig.length > 5 ? `${dig.slice(0,5)}-${dig.slice(5)}` : dig;
      };

      const renderizarEnderecosVeiculo = () => {
        const lista = document.getElementById('lista-enderecos-veiculo');
        lista.innerHTML = '';
        if (!enderecosVeiculo.length) {
          lista.innerHTML = '<p style="color: var(--muted); margin: 0;">Nenhum endere√ßo adicionado. Clique para adicionar.</p>';
          return;
        }
        enderecosVeiculo.forEach((endereco, indiceOrdenado) => {
          const div = document.createElement('div');
          div.style.cssText = 'border: 1px solid var(--border); border-radius: 0.5rem; padding: 1rem;';
          const grid = document.createElement('div');
          grid.className = 'form__grid form__grid--4';
          grid.innerHTML = `
            <label class="form__field">
              <span class="form__label">UF</span>
              <select class="form__input endereco-uf" data-index="${indiceOrdenado}">
                ${createEstadosSelect()}
              </select>
            </label>
            <label class="form__field form__field--wide">
              <span class="form__label">Logradouro/Nome</span>
              <input class="form__input endereco-logradouro" type="text" data-index="${indiceOrdenado}" />
            </label>
            <label class="form__field">
              <span class="form__label">Bairro/Cidade</span>
              <input class="form__input endereco-bairro" type="text" data-index="${indiceOrdenado}" />
            </label>
            <label class="form__field">
              <span class="form__label">CEP</span>
              <input class="form__input endereco-cep" type="text" inputmode="numeric" data-index="${indiceOrdenado}" />
            </label>
            <label class="form__field">
              <span class="form__label">Complemento</span>
              <input class="form__input endereco-complemento" type="text" data-index="${indiceOrdenado}" />
            </label>
            <label class="form__field form__field--wide">
              <span class="form__label">Lat/Long</span>
              <input class="form__input endereco-latlong" type="text" data-index="${indiceOrdenado}" placeholder="-23.5, -46.6" />
            </label>
          `;
          div.appendChild(grid);

          // Preencher valores
          grid.querySelector('.endereco-uf').value = endereco.uf || '';
          grid.querySelector('.endereco-logradouro').value = endereco.logradouro || '';
          grid.querySelector('.endereco-bairro').value = endereco.bairro || '';
          grid.querySelector('.endereco-cep').value = aplicarMascaraCep(endereco.cep || '');
          grid.querySelector('.endereco-complemento').value = endereco.complemento || '';
          grid.querySelector('.endereco-latlong').value = endereco.latLong || '';

          // Listeners
          grid.querySelector('.endereco-uf').addEventListener('change', (e) => { enderecosVeiculo[indiceOrdenado].uf = e.target.value; });
          grid.querySelector('.endereco-logradouro').addEventListener('input', (e) => { enderecosVeiculo[indiceOrdenado].logradouro = e.target.value; });
          grid.querySelector('.endereco-bairro').addEventListener('input', (e) => { enderecosVeiculo[indiceOrdenado].bairro = e.target.value; });
          grid.querySelector('.endereco-cep').addEventListener('input', (e) => { e.target.value = aplicarMascaraCep(e.target.value); enderecosVeiculo[indiceOrdenado].cep = e.target.value; });
          grid.querySelector('.endereco-complemento').addEventListener('input', (e) => { enderecosVeiculo[indiceOrdenado].complemento = e.target.value; });
          grid.querySelector('.endereco-latlong').addEventListener('input', (e) => { enderecosVeiculo[indiceOrdenado].latLong = e.target.value; });

          const statusDiv = document.createElement('div');
          statusDiv.className = `cep-status-veiculo-${indiceOrdenado}`;
          statusDiv.style.cssText = 'margin-top: 0.5rem; font-size: 0.85rem; display:none;';
          div.appendChild(statusDiv);

          grid.querySelector('.endereco-cep').addEventListener('blur', (e) => {
            const v = String(e.target.value||'').replace(/\D/g,'');
            if (v.length === 8) {
              mostrarCarregamentoCepVeiculo(indiceOrdenado, true);
              buscarEnderecoPorCepVeiculo(v, indiceOrdenado);
            }
          });

          // Remover
          const actions = document.createElement('div');
          actions.className = 'form__actions';
          const removerBtn = document.createElement('button');
          removerBtn.type = 'button';
          removerBtn.className = 'button button--danger';
          removerBtn.textContent = 'Remover';
          removerBtn.addEventListener('click', () => { enderecosVeiculo.splice(indiceOrdenado,1); renderizarEnderecosVeiculo(); });
          actions.appendChild(removerBtn);
          div.appendChild(actions);

          lista.appendChild(div);
        });
      };

      const adicionarEnderecoVeiculo = () => {
        enderecosVeiculo.push({ uf:'', logradouro:'', bairro:'', cep:'', complemento:'', latLong:'' });
        renderizarEnderecosVeiculo();
      };

      const buscarEnderecoPorCepVeiculo = async (cepNumeros, index) => {
        try {
          const response = await fetch(`https://viacep.com.br/ws/${cepNumeros}/json/`);
          const data = await response.json();
          if (data.erro) {
            exibirStatusCepVeiculo(index, 'CEP n√£o encontrado', 'error');
          } else {
            enderecosVeiculo[index].uf = data.uf || '';
            enderecosVeiculo[index].logradouro = data.logradouro || '';
            enderecosVeiculo[index].bairro = `${data.bairro || ''} ${data.localidade || ''}`.trim();
            enderecosVeiculo[index].cep = cepNumeros;
            renderizarEnderecosVeiculo();
            exibirStatusCepVeiculo(index, 'Endere√ßo carregado com sucesso', 'success');
          }
        } catch (error) {
          exibirStatusCepVeiculo(index, 'Erro ao buscar CEP', 'error');
        } finally {
          mostrarCarregamentoCepVeiculo(index, false);
        }
      };

      const mostrarCarregamentoCepVeiculo = (index, mostrando) => {
        const el = document.querySelector(`.cep-status-veiculo-${index}`);
        if (!el) return;
        if (mostrando) {
          el.innerHTML = `<div style="display:flex; align-items:center; gap:0.5rem; color: var(--primary);"><div class="spinner" style="width: 16px; height: 16px; border: 2px solid var(--primary); border-top: 2px solid transparent; border-radius: 50%; animation: spin 0.6s linear infinite;"></div><span>Carregando endere√ßo...</span></div>`;
          el.style.display = 'block';
        } else {
          el.style.display = 'none';
        }
      };

      const exibirStatusCepVeiculo = (index, mensagem, tipo) => {
        const el = document.querySelector(`.cep-status-veiculo-${index}`);
        if (!el) return;
        const cores = { success: 'var(--success-text)', error: 'var(--error-text)' };
        el.innerHTML = `<div style="display:flex; align-items:center; gap:0.5rem; color:${cores[tipo]||'var(--text)'};"><span>${tipo==='success'?'‚úì':'‚úï'}</span><span>${mensagem}</span></div>`;
        el.style.display = 'block';
        setTimeout(() => { if (el.style.display !== 'none') el.style.display = 'none'; }, 3000);
      };

      // Renderiza lista de ve√≠culos em forma de tabela
      const renderizarLista = (veiculos) => {
        listaEl.innerHTML = '';
        if (!veiculos.length) {
          listaEl.innerHTML = '<p style="color: var(--muted); margin: 0;">Nenhum ve√≠culo cadastrado.</p>';
          return;
        }

        const table = document.createElement('table');
        table.className = 'table';

        // Cabe√ßalho
        const thead = document.createElement('thead');
        thead.innerHTML = `
          <tr>
            <th>Placa</th>
            <th>Marca/Modelo</th>
            <th>Cor</th>
            <th>Nome</th>
            <th>CPF</th>
            <th>A√ß√µes</th>
          </tr>
        `;
        table.appendChild(thead);

        // Corpo
        const tbody = document.createElement('tbody');
        veiculos.forEach((veiculo) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${veiculo.placa || '‚Äî'}</td>
            <td>${veiculo.marcaModelo || '‚Äî'}</td>
            <td>${veiculo.cor || '‚Äî'}</td>
            <td>${veiculo.nomeProprietario || '‚Äî'}</td>
            <td>${veiculo.cpf || '‚Äî'}</td>
            <td>
              <button class="button button--ghost" data-editar="${veiculo.id}">Editar</button>
              <button class="button button--danger" data-remover="${veiculo.id}">Excluir</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);

        listaEl.appendChild(table);
      };

      // Busca ve√≠culos e aplica filtro de texto simples
      const carregarVeiculos = async () => {
        exibirMensagem(mensagemListaEl, 'Carregando ve√≠culos...', 'info');
        try {
          const resposta = await fetchAutenticado(API_VEICULOS);
          const dados = await resposta.json();
          veiculosCache = Array.isArray(dados) ? dados : [];
          aplicarFiltro();
          exibirMensagem(mensagemListaEl, '', 'info');
        } catch (erro) {
          exibirMensagem(mensagemListaEl, 'Erro ao carregar ve√≠culos.', 'error');
        }
      };

      // Filtra lista em mem√≥ria conforme busca digitada
      const aplicarFiltro = () => {
        const termo = (campoBusca.value || '').toLowerCase();
        const filtrados = veiculosCache.filter((v) => {
          return [v.nomeProprietario, v.placa, v.marcaModelo, v.cor]
            .some((campo) => String(campo || '').toLowerCase().includes(termo));
        });
        renderizarLista(filtrados);
      };

      // Preenche formul√°rio com dados existentes
      const iniciarEdicao = (veiculo) => {
        veiculoEmEdicao = veiculo;
        form.nomeProprietario.value = veiculo.nomeProprietario || '';
        form.cpf.value = veiculo.cpf || '';
        form.placa.value = veiculo.placa || '';
        form.marcaModelo.value = veiculo.marcaModelo || '';
        form.cor.value = veiculo.cor || '';
        form.anoModelo.value = veiculo.anoModelo || '';
        // Buscar detalhes completos (inclui enderecos)
        fetchAutenticado(`${API_VEICULOS}/${veiculo.id}`)
          .then((r) => r.json())
          .then((data) => {
            enderecosVeiculo = Array.isArray(data?.enderecos) ? JSON.parse(JSON.stringify(data.enderecos)) : [];
            renderizarEnderecosVeiculo();
          })
          .catch(() => { enderecosVeiculo = []; renderizarEnderecosVeiculo(); });
        submitBtn.textContent = 'Salvar';
      };

      // Limpa formul√°rio e volta ao modo inclus√£o
      const resetarFormulario = () => {
        veiculoEmEdicao = null;
        form.reset();
        enderecosVeiculo = [];
        renderizarEnderecosVeiculo();
        submitBtn.textContent = 'Incluir';
        exibirMensagem(formMsgEl, '', 'info');
        const erroEl = document.getElementById('erro-cpf-veiculo');
        erroEl.style.display = 'none';
      };

      // Submete formul√°rio criando ou atualizando registro
      form.addEventListener('submit', async (event) => {
        event.preventDefault();
        const payload = montarPayload();
        const isEdicao = !!veiculoEmEdicao;

        if (payload.cpf) {
          const validacao = validarCpf(payload.cpf);
          if (!validacao.valido) {
            exibirMensagem(formMsgEl, 'CPF inv√°lido', 'error');
            return;
          }
        }

        exibirMensagem(formMsgEl, veiculoEmEdicao ? 'Salvando altera√ß√µes...' : 'Incluindo ve√≠culo...', 'info');
        submitBtn.disabled = true;
        try {
          const metodo = veiculoEmEdicao ? 'PUT' : 'POST';
          const endpoint = veiculoEmEdicao ? `${API_VEICULOS}/${veiculoEmEdicao.id}` : API_VEICULOS;
          const resposta = await fetchAutenticado(endpoint, {
            method: metodo,
            body: JSON.stringify(payload),
          });
          if (!resposta.ok) {
            const erro = await resposta.json().catch(() => ({}));
            throw new Error(erro.message || 'Falha ao salvar ve√≠culo');
          }
          await carregarVeiculos();
          resetarFormulario();
          alert(isEdicao ? 'Altera√ß√µes realizadas com sucesso!' : 'Ve√≠culo cadastrado com sucesso!');
        } catch (erro) {
          exibirMensagem(formMsgEl, erro.message || 'N√£o foi poss√≠vel salvar o ve√≠culo.', 'error');
        } finally {
          submitBtn.disabled = false;
        }
      });

      // Escuta cliques na lista para editar ou remover
      listaEl.addEventListener('click', async (event) => {
        const botao = event.target.closest('button');
        if (!botao) return;
        const id = botao.dataset.editar || botao.dataset.remover;
        const veiculo = veiculosCache.find((v) => v.id === id);
        if (!veiculo) return;

        if (botao.dataset.editar) {
          iniciarEdicao(veiculo);
          window.scrollTo({ top: 0, behavior: 'smooth' });
          return;
        }

        if (botao.dataset.remover) {
          if (!confirm('Confirma a exclus√£o deste ve√≠culo?')) return;
          try {
            const resposta = await fetchAutenticado(`${API_VEICULOS}/${id}`, { method: 'DELETE' });
            if (!resposta.ok) {
              const erro = await resposta.json().catch(() => ({}));
              throw new Error(erro.message || 'Falha ao remover ve√≠culo');
            }
            await carregarVeiculos();
            alert('Ve√≠culo removido com sucesso!');
            if (veiculoEmEdicao?.id === id) {
              resetarFormulario();
            }
          } catch (erro) {
            exibirMensagem(mensagemListaEl, erro.message || 'Erro ao remover ve√≠culo.', 'error');
          }
        }
      });

      // Normaliza a placa para letras mai√∫sculas e remove espa√ßos
      campoPlaca.addEventListener('input', (event) => {
        const texto = event.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '').slice(0, 7);
        event.target.value = texto;
      });

      // Liga m√°scara de CPF no input dedicado
      campoCpf.addEventListener('input', aplicarMascaraCpf);

      // Busca incremental na lista de ve√≠culos
      campoBusca.addEventListener('input', aplicarFiltro);

      // Bot√£o de reset volta para modo de cria√ß√£o
      document.getElementById('btn-limpar').addEventListener('click', resetarFormulario);

      // Lista somente os 10 √∫ltimos registros (cadastrados/alterados)
      const listarUltimosDez = async () => {
        exibirMensagem(mensagemListaEl, 'Carregando √∫ltimos 10...', 'info');
        try {
          const resposta = await fetchAutenticado(API_VEICULOS);
          const dados = await resposta.json();
          veiculosCache = Array.isArray(dados) ? dados : [];
          campoBusca.value = '';
          const ultimosDez = veiculosCache.slice(0, 10);
          renderizarLista(ultimosDez);
          exibirMensagem(mensagemListaEl, 'Exibindo √∫ltimos 10 registros.', 'info');
        } catch (erro) {
          exibirMensagem(mensagemListaEl, 'Erro ao carregar √∫ltimos registros.', 'error');
        }
      };

      // Bot√£o "Listar" aplica a regra dos 10 √∫ltimos
      document.getElementById('btn-listar').addEventListener('click', listarUltimosDez);

      document.getElementById('adicionar-endereco-veiculo').addEventListener('click', adicionarEnderecoVeiculo);
      renderizarEnderecosVeiculo();

      // Carregamento inicial dos dados
      carregarVeiculos();
    </script>
  </body>
</html>
