<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cadastro de Empresas | Projeto Coruja</title>
    <link rel="stylesheet" href="/css/main.css" />
  </head>
  <body class="theme-dark">
    <div class="app">
      <div class="user-menu" id="user-menu" aria-expanded="false">
        <button class="user-menu__button" type="button" id="user-menu-button" aria-haspopup="true" aria-expanded="false">
          <span class="user-menu__avatar" id="user-avatar" aria-hidden="true">U</span>
          <span id="user-button-name">Usu√°rio</span>
        </button>
        <div class="user-menu__dropdown" id="user-menu-dropdown" role="menu" aria-label="Menu do usu√°rio">
          <div class="user-menu__item"><span class="user-menu__label">Nome Completo:</span><span class="user-menu__value" id="um-nome">‚Äî</span></div>
          <div class="user-menu__item"><span class="user-menu__label">Email:</span><span class="user-menu__value" id="um-email">‚Äî</span></div>
          <div class="user-menu__item"><span class="user-menu__label">Perfil:</span><span class="user-menu__value" id="um-perfil">‚Äî</span></div>
          <div class="user-menu__separator"></div>
          <div class="user-menu__item"><span class="user-menu__label">Senha:</span><span class="user-menu__link" id="um-alterar-senha">Alterar senha</span></div>
          <div class="user-menu__separator"></div>
          <div class="user-menu__item"><span class="user-menu__link" id="um-sair">Sair</span></div>
        </div>
      </div>
      <!-- Sidebar principal -->
      <aside class="sidebar">
        <div class="sidebar__header">
          <div class="sidebar__brand">Projeto Coruja</div>
          <!-- Bot√£o dedicado para alternar entre tema claro e escuro -->
          <button
            class="theme-toggle"
            type="button"
            data-theme-toggle
            aria-pressed="false"
            aria-label="Alternar tema visual"
          >
            <span class="theme-toggle__icon" aria-hidden="true" data-theme-icon>üåô</span>
            <span class="theme-toggle__label" data-theme-label>Modo escuro</span>
          </button>
        </div>
        <nav class="sidebar__nav" aria-label="Menu principal">
          <a class="sidebar__link" href="/home">Home</a>
          <a class="sidebar__link" href="/usuarios">Usu√°rios</a>
          <!-- In√≠cio do menu de n√≠vel superior: Cadastro -->
          <details class="sidebar__section sidebar__section--active" open>
            <summary class="sidebar__link sidebar__link--parent" aria-label="Abrir menu Cadastro">Cadastro</summary>
            <div class="sidebar__subnav">
              <a class="sidebar__link sidebar__link--child" href="/cadastro/pessoas">Pessoas</a>
              <a class="sidebar__link sidebar__link--child sidebar__link--active" href="/cadastro/empresas">Empresas</a>
              <a class="sidebar__link sidebar__link--child" href="/cadastro/entidades">Entidades</a>
              
            </div>
          </details>
          <!-- In√≠cio do menu de n√≠vel superior: Consulta -->
          <details class="sidebar__section">
            <summary class="sidebar__link sidebar__link--parent" aria-label="Abrir menu Consulta">Consulta</summary>
            <div class="sidebar__subnav">
              <a class="sidebar__link sidebar__link--child" href="/consulta/pessoas">Pessoas</a>
              <a class="sidebar__link sidebar__link--child" href="/consulta/empresas">Empresas</a>
              <a class="sidebar__link sidebar__link--child" href="/consulta/veiculos">Ve√≠culos</a>
            </div>
          </details>
          <!-- Fim do menu de n√≠vel superior: Cadastro -->
        </nav>
        
      </aside>

      <!-- Conte√∫do principal da p√°gina -->
      <main class="content" data-page="cadastro-empresas">
        <header class="content__header">
          <p class="content__eyebrow">Cadastro</p>
          <h1 class="content__title">Empresas</h1>
          
        </header>

        <section class="panel" aria-label="Formul√°rio de empresas">
          <div class="panel__header panel__header--stacked"></div>
          <div id="empresa-form-message" class="message" role="status" aria-live="polite"></div>
          <!-- A√ß√£o direta garante envio mesmo sem o manipulador JS -->
          <form class="form" id="empresa-form" action="/api/empresas" method="post">
            <div class="form__grid form__grid--3">
              <label class="form__field">
                <span class="form__label">CNPJ</span>
                <input id="empresa-cnpj" name="cnpj" type="text" class="form__input" inputmode="numeric" placeholder="00.000.000/0000-00" />
              </label>
              <label class="form__field">
                <span class="form__label">Raz√£o Social</span>
                <input name="razaoSocial" type="text" class="form__input" />
              </label>
              <label class="form__field">
                <span class="form__label">Nome Fantasia</span>
                <input name="nomeFantasia" type="text" class="form__input" />
              </label>
            </div>

            <div class="form__grid form__grid--3">
              <label class="form__field">
                <span class="form__label">Natureza Jur√≠dica</span>
                <input name="naturezaJuridica" type="text" class="form__input" />
              </label>
              <label class="form__field">
                <span class="form__label">In√≠cio da Atividade</span>
                <input name="dataInicioAtividade" type="date" class="form__input" />
              </label>
              <label class="form__field">
                <span class="form__label">Situa√ß√£o Cadastral</span>
                <select name="situacaoCadastral" class="form__input">
                  <option value="">Selecione</option>
                  <option value="Ativo">Ativo</option>
                  <option value="Inativo">Inativo</option>
                  <option value="Inapta">Inapta</option>
                </select>
              </label>
            </div>

            <div class="form__grid form__grid--3">
              <label class="form__field">
                <span class="form__label">Telefone</span>
                <input id="empresa-telefone" name="telefone" type="tel" class="form__input" inputmode="numeric" placeholder="(XX) XXXXX-XXXX" maxlength="16" aria-describedby="Ajuda: at√© 11 d√≠gitos" />
              </label>
            </div>

            <!-- Endere√ßos da empresa -->
            <div class="form__section" aria-label="Endere√ßos da empresa">
              <div class="form__section-header" style="display:flex; justify-content: space-between; align-items: center;">
                <h3 class="form__section-title" style="font-size:1rem; margin:0;">Endere√ßos</h3>
                <button class="button button--secondary" id="adicionar-endereco-empresa" type="button">+</button>
              </div>
              <div id="lista-enderecos-empresa" class="form__section-body" style="display:flex; flex-direction:column; gap:0.75rem;"></div>
            </div>


            <div class="form__subsection">
              <div class="form__section-header" style="display:flex; justify-content: space-between; align-items: center;">
                <h3 class="form__section-title">S√≥cios</h3>
                <button class="button" type="button" id="adicionar-socio">Adicionar s√≥cio</button>
              </div>
              <div id="lista-socios" class="form__section-body"></div>
            </div>

            <!-- Ve√≠culos da empresa (movido para baixo de S√≥cios) -->
            <div class="form__subsection" aria-label="Ve√≠culos da empresa">
              <div class="form__section-header" style="display:flex; justify-content: space-between; align-items: center;">
                <h3 class="form__section-title">Ve√≠culos</h3>
                <button class="button button--secondary" id="adicionar-veiculo-empresa" type="button">+</button>
              </div>
              <div id="lista-veiculos-empresa" class="form__section-body" style="display:flex; flex-direction:column; gap:0.75rem;"></div>
            </div>

            <div class="form__actions">
              <button class="button button--primary" id="submit-empresa" type="submit">Incluir</button>
              <button class="button" id="listar-empresas" type="button">Listar</button>
              <button class="button button--ghost" type="reset">Limpar</button>
            </div>
          </form>
        </section>

        <section class="panel" aria-label="Listagem de empresas">
          <div class="panel__header panel__header--stacked">
            <h3 class="panel__title">Empresas cadastradas</h3>
            <div class="panel__actions page-actions">
              <input
                type="text"
                id="campo-consulta"
                class="search-input"
                placeholder="Consultar em todos os campos da empresa e s√≥cios..."
                aria-label="Campo de busca de empresas"
              />
            </div>
          </div>
          <div id="empresas-message" class="message" role="status" aria-live="polite"></div>
          <div class="panel__body">
            <div id="empresas-lista" class="list"></div>
          </div>
        </section>
      </main>
    </div>

    <script src="/js/main.js"></script>
    <script>
      const API_EMPRESAS = '/api/empresas';
      const empresaForm = document.getElementById('empresa-form');
      const formMsgEl = document.getElementById('empresa-form-message');
      const msgEl = document.getElementById('empresas-message');
      const listaEl = document.getElementById('empresas-lista');
      const submitBtn = document.getElementById('submit-empresa');
      const listarBtn = document.getElementById('listar-empresas');
      const campoConsulta = document.getElementById('campo-consulta');
      let todasEmpresas = [];
      let empresasFiltradas = [];
      let termoBusca = '';
      let socios = [];
      let enderecosEmpresa = [];
      let empresaEmEdicao = null;
      let veiculosEmpresa = [];
      let veiculosEditados = false;
      let listenersVeiculosEmpresaConfigurados = false;

      // Helpers de autentica√ß√£o (locais desta p√°gina)
      const getCookie = (name) => document.cookie.split(';').map(c=>c.trim()).find(c=>c.startsWith(`${name}=`))?.split('=')[1];
      const obterToken = () => localStorage.getItem('authToken') || getCookie('authToken');
      const fetchAutenticado = (url, options = {}) => {
        const token = obterToken();
        const headers = { 'Content-Type': 'application/json', ...(options.headers||{}), ...(token ? { Authorization: `Bearer ${token}` } : {}) };
        return fetch(url, { ...options, headers });
      };

      const exibirMensagem = (texto, tipo = 'info') => { if(!msgEl) return; msgEl.textContent = texto||''; msgEl.className='message'; if (texto) msgEl.classList.add(`message--${tipo}`); };
      const exibirMensagemForm = (texto, tipo='info') => { formMsgEl.textContent = texto||''; formMsgEl.className='message'; if (texto) formMsgEl.classList.add(`message--${tipo}`); };
      const aplicarMascaraCnpj = (v) => { const d=String(v||'').replace(/\D/g,'').slice(0,14); let r=d; if(d.length>2) r=d.slice(0,2)+'.'+d.slice(2); if(d.length>5) r=r.slice(0,6)+'.'+d.slice(5); if(d.length>8) r=r.slice(0,10)+'/'+d.slice(8); if(d.length>12) r=r.slice(0,15)+'-'+d.slice(12); return r; };
      const validarCnpj14 = (valor) => { const dig=String(valor||'').replace(/\D/g,''); return dig.length===14; };
      const aplicarMascaraTelefone = (valor) => { const dig=String(valor||'').replace(/\D/g,'').slice(0,11); if(dig.length<=10){ return dig.replace(/(\d{0,2})(\d{0,4})(\d{0,4}).*/, (_,a,b,c)=>{ let r=''; if(a) r+='('+a+') '; if(b) r+=b+(c?'-':''); if(c) r+=c; return r; }); } else { return dig.replace(/(\d{0,2})(\d{0,5})(\d{0,4}).*/, (_,a,b,c)=>{ let r=''; if(a) r+='('+a+') '; if(b) r+=b+(c?'-':''); if(c) r+=c; return r; }); } };
      const aplicarMascaraCep = (valor) => { const dig=String(valor||'').replace(/\D/g,'').slice(0,8); return dig.length>5?dig.slice(0,5)+'-'+dig.slice(5):dig; };
      const renderizarSocios = () => {
        const lista = document.getElementById('lista-socios');
        lista.innerHTML = '';
        if (!socios.length) {
          lista.innerHTML = '';
          return;
        }
        socios.forEach((s, i) => {
          const linha = document.createElement('div');
          linha.className = 'form__grid form__grid--3';
          linha.innerHTML = `
            <label class="form__field">
              <span class="form__label form__label--normal">S√≥cio</span>
              <input type="text" class="form__input socio-nome" />
            </label>
            <label class="form__field">
              <span class="form__label">CPF</span>
              <input type="text" class="form__input socio-cpf" inputmode="numeric" />
            </label>
            <div class="form__actions" style="align-self: end;">
              <button class="button button--danger" type="button" title="Excluir" aria-label="Remover s√≥cio">Remover</button>
            </div>
          `;
          const nomeEl = linha.querySelector('.socio-nome');
          const cpfEl = linha.querySelector('.socio-cpf');
          const btn = linha.querySelector('button');
          nomeEl.value = s.nome || '';
          cpfEl.value = s.cpf || '';
          nomeEl.addEventListener('input', (e) => { socios[i].nome = e.target.value; });
          cpfEl.addEventListener('input', (e) => { socios[i].cpf = e.target.value; });
          btn.addEventListener('click', () => { socios.splice(i, 1); renderizarSocios(); });
          lista.appendChild(linha);
        });
      };
      const adicionarSocio = () => { socios.push({ nome:'', cpf:'' }); renderizarSocios(); };
      const obterDadosFormulario = () => {
        const fd = new FormData(empresaForm);
        const dados = Object.fromEntries(fd.entries());
        dados.cnpj = aplicarMascaraCnpj(dados.cnpj).replace(/\D/g, '');
        dados.telefone = aplicarMascaraTelefone(dados.telefone);
        const razao = String(dados.razaoSocial||'').trim();
        const nomeProprietarioDefault = razao || null;
        const cnpjEmpresa = dados.cnpj || null;
        // Se√ß√£o de ve√≠culos removida
        dados.socios = socios
          .map(s => ({ nome: String(s.nome||'').trim(), cpf: String(s.cpf||'').replace(/\D/g, '') }))
          .filter(s => s.nome || s.cpf);
        dados.enderecos = enderecosEmpresa
          .map(e => ({
            uf: String(e.uf||'').trim() || null,
            logradouro: String(e.logradouro||'').trim() || null,
            bairro: String(e.bairro||'').trim() || null,
            complemento: String(e.complemento||'').trim() || null,
            cep: String(e.cep||'').replace(/\D/g, '').slice(0,8) || null,
            latLong: String(e.latLong||'').trim() || null,
          }))
          .filter(e => Object.values(e).some(v => v));
        if (!empresaEmEdicao || veiculosEditados) {
          // Coment√°rio: s√≥ envia ve√≠culos na edi√ß√£o quando o usu√°rio alterou essa se√ß√£o.
          dados.veiculos = veiculosEmpresa
            .map(v => {
              const placa = normalizarPlaca(String(v.placa||''));
              const marcaModelo = String(v.marcaModelo||'').trim();
              const cor = String(v.cor||'').trim();
              const anoModelo = (v.anoModelo ?? null);
              const nomeProprietario = String(v.nomeProprietario || nomeProprietarioDefault || '').trim() || null;
              const cnpj = String(v.cnpj || cnpjEmpresa || '').replace(/\D/g, '') || null;
              return { placa, marcaModelo, cor, anoModelo, nomeProprietario, cnpj };
            })
            .filter(v => (v.placa || v.marcaModelo || v.cor || v.anoModelo));
        }
        return dados;
      };
      const atualizarRotuloSubmit = () => { submitBtn.textContent = empresaEmEdicao ? 'Salvar' : 'Incluir'; };
      const salvarEmpresa = async (e) => {
        e.preventDefault();
        const payload = obterDadosFormulario();
        // Valida√ß√µes de UI: exigir Raz√£o Social e placa nos ve√≠culos quando existirem
        const razaoVal = String(empresaForm.razaoSocial?.value || '').trim();
        if (!razaoVal) {
          exibirMensagemForm('Raz√£o Social √© obrigat√≥ria.', 'error');
          empresaForm.razaoSocial.focus();
          return;
        }
        if (Array.isArray(payload.veiculos) && payload.veiculos.length) {
          const semPlaca = payload.veiculos.find(v => !String(v.placa||'').trim());
          if (semPlaca) {
            exibirMensagemForm('Informe a placa de todos os ve√≠culos adicionados.', 'error');
            return;
          }
        }
        if (!validarCnpj14(payload.cnpj)) {
          exibirMensagemForm('CNPJ inv√°lido: deve conter exatamente 14 n√∫meros.', 'error');
          empresaForm.cnpj.focus();
          return;
        }
        try {
          exibirMensagemForm('Salvando empresa...', 'info');
          const metodo = empresaEmEdicao ? 'PUT' : 'POST';
          const url = empresaEmEdicao ? `${API_EMPRESAS}/${empresaEmEdicao}` : API_EMPRESAS;
          const resp = await fetchAutenticado(url, { method: metodo, body: JSON.stringify(payload) });
          const data = await resp.json().catch(() => ({}));
          if (!resp.ok) {
            const msg = data?.mensagem || data?.message || 'N√£o foi poss√≠vel salvar a empresa.';
            throw new Error(msg);
          }
          // Sucesso: informa quantidade de ve√≠culos salvos para evitar confus√£o visual
          const veiculosSalvos = Array.isArray(data?.veiculos) ? data.veiculos.length : (Array.isArray(payload.veiculos) ? payload.veiculos.length : 0);
          const sucessoMsg = empresaEmEdicao ? 'Altera√ß√µes realizadas com sucesso!' : 'Empresa cadastrada com sucesso!';
          exibirMensagemForm(`${sucessoMsg} ${veiculosSalvos ? `Ve√≠culos salvos: ${veiculosSalvos}.` : ''}`, 'success');
          alert(sucessoMsg);
          empresaForm.reset();
          socios = [];
          renderizarSocios();
          // Coment√°rio: limpa o estado dos ve√≠culos para evitar res√≠duos.
          veiculosEmpresa = [];
          veiculosEditados = false;
          renderizarVeiculosEmpresa();
          empresaEmEdicao = null;
          atualizarRotuloSubmit();
          listarEmpresas();
        } catch (err) {
          exibirMensagemForm(err?.message || 'Erro ao salvar empresa.', 'error');
        }
      };
      const renderizarEmpresas = (lista) => {
        listaEl.innerHTML = '';
        if (!Array.isArray(lista) || !lista.length) {
          const table = document.createElement('table');
          const tbody = document.createElement('tbody');
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          td.colSpan = 5;
          td.textContent = 'Nenhuma empresa encontrada.';
          tr.appendChild(td);
          tbody.appendChild(tr);
          table.appendChild(tbody);
          listaEl.appendChild(table);
          return;
        }

        const table = document.createElement('table');
        table.style.width = '100%';
        table.style.borderCollapse = 'collapse';

        const thead = document.createElement('thead');
        const headRow = document.createElement('tr');
        const ths = ['CNPJ', 'Raz√£o Social', 'Nome Fantasia', 'Situa√ß√£o Cadastral', 'A√ß√µes'];
        ths.forEach(t => {
          const th = document.createElement('th');
          th.textContent = t;
          th.style.textAlign = 'left';
          th.style.padding = '0.5rem';
          headRow.appendChild(th);
        });
        thead.appendChild(headRow);
        table.appendChild(thead);

        const tbody = document.createElement('tbody');
        for (const e of lista) {
          const tr = document.createElement('tr');

          const tdCnpj = document.createElement('td');
          tdCnpj.textContent = aplicarMascaraCnpj(e.cnpj || '') || '‚Äî';
          tdCnpj.style.padding = '0.5rem';

          const tdRazao = document.createElement('td');
          tdRazao.textContent = e.razaoSocial || '‚Äî';
          tdRazao.style.padding = '0.5rem';

          const tdFantasia = document.createElement('td');
          tdFantasia.textContent = e.nomeFantasia || '‚Äî';
          tdFantasia.style.padding = '0.5rem';

          const tdSituacao = document.createElement('td');
          tdSituacao.textContent = e.situacaoCadastral || '‚Äî';
          tdSituacao.style.padding = '0.5rem';

          const tdAcoes = document.createElement('td');
          tdAcoes.style.padding = '0.5rem';
          const actions = document.createElement('div');
          actions.style.display = 'flex';
          actions.style.gap = '0.5rem';
          const btnEditar = document.createElement('button');
          btnEditar.className = 'button';
          btnEditar.type = 'button';
          btnEditar.textContent = 'Editar';
          const btnExcluir = document.createElement('button');
          btnExcluir.className = 'button button--danger';
          btnExcluir.type = 'button';
          btnExcluir.textContent = 'Excluir';
          btnEditar.addEventListener('click', () => editarEmpresa(e));
          btnExcluir.addEventListener('click', () => excluirEmpresa(e));
          actions.appendChild(btnEditar);
          actions.appendChild(btnExcluir);
          tdAcoes.appendChild(actions);

          tr.appendChild(tdCnpj);
          tr.appendChild(tdRazao);
          tr.appendChild(tdFantasia);
          tr.appendChild(tdSituacao);
          tr.appendChild(tdAcoes);

          tbody.appendChild(tr);
        }
        table.appendChild(tbody);
        listaEl.appendChild(table);
      };

      const filtrarEmpresas = (termo) => {
        const q = String(termo || '').toLowerCase().trim();
        const onlyDigits = (s) => String(s || '').replace(/\D+/g, '');
        const norm = (s) => String(s || '').toLowerCase();
        if (!q) {
          empresasFiltradas = [...todasEmpresas];
        } else {
          const qDigits = onlyDigits(q);
          empresasFiltradas = todasEmpresas.filter((e) => {
            const razao = norm(e.razaoSocial);
            const fantasia = norm(e.nomeFantasia);
            const situacao = norm(e.situacaoCadastral);
            const natureza = norm(e.naturezaJuridica);
            const endereco = norm(e.endereco);
            const dataInicio = norm(e.dataInicioAtividade);
            const cepDigits = onlyDigits(e.cep);
            const telDigits = onlyDigits(e.telefone);
            const cnpjDigits = onlyDigits(e.cnpj);

            const textoMatch = (
              razao.includes(q) ||
              fantasia.includes(q) ||
              situacao.includes(q) ||
              natureza.includes(q) ||
              endereco.includes(q) ||
              dataInicio.includes(q)
            );

            const digitosMatch = (
              (qDigits && cnpjDigits.includes(qDigits)) ||
              (qDigits && cepDigits.includes(qDigits)) ||
              (qDigits && telDigits.includes(qDigits))
            );

            const sociosArr = Array.isArray(e.socios) ? e.socios : [];
            const sociosMatch = sociosArr.some((s) => {
              const nome = norm(s.nome);
              const cpfDigits = onlyDigits(s.cpf);
              return nome.includes(q) || (qDigits && cpfDigits.includes(qDigits));
            });

            return textoMatch || digitosMatch || sociosMatch;
          });
        }
        renderizarEmpresas(empresasFiltradas);
      };

      const listarEmpresas = async () => {
        try {
          exibirMensagem('Carregando empresas...', 'info');
          const resp = await fetchAutenticado(API_EMPRESAS);
          const data = await resp.json().catch(() => []);
          if (!resp.ok) {
            const msg = data?.mensagem || data?.message || 'N√£o foi poss√≠vel buscar as empresas.';
            throw new Error(msg);
          }
          todasEmpresas = Array.isArray(data) ? data : data?.data || [];
          if (!todasEmpresas.length) {
            exibirMensagem('Nenhuma empresa cadastrada.', 'info');
            empresasFiltradas = [];
            renderizarEmpresas(empresasFiltradas);
            return;
          }
          exibirMensagem(`Exibindo ${todasEmpresas.length} empresa(s).`, 'success');
          empresasFiltradas = [...todasEmpresas];
          filtrarEmpresas(termoBusca);
        } catch (err) {
          exibirMensagem(err?.message || 'Erro ao listar empresas.', 'error');
        }
      };

      const preencherFormularioComEmpresa = (e) => {
        empresaForm.cnpj.value = aplicarMascaraCnpj(e.cnpj || '');
        empresaForm.razaoSocial.value = e.razaoSocial || '';
        empresaForm.nomeFantasia.value = e.nomeFantasia || '';
        empresaForm.naturezaJuridica.value = e.naturezaJuridica || '';
        empresaForm.dataInicioAtividade.value = e.dataInicioAtividade || '';
        empresaForm.situacaoCadastral.value = e.situacaoCadastral || '';
        empresaForm.telefone.value = aplicarMascaraTelefone(e.telefone || '');
        socios = Array.isArray(e.socios) ? e.socios.map(s=>({ nome: s.nome||'', cpf: s.cpf||'' })) : [];
        enderecosEmpresa = Array.isArray(e.enderecos) ? e.enderecos.map(x=>({ uf:x.uf||'', logradouro:x.logradouro||'', bairro:x.bairro||'', complemento:x.complemento||'', cep: x.cep||'', latLong: x.latLong||'' })) : [];
        // Coment√°rio: normaliza ve√≠culos recebidos para evitar payload residual.
        veiculosEmpresa = Array.isArray(e.veiculos)
          ? e.veiculos.map((v) => {
              const anoModeloNumerico = Number(v?.anoModelo ?? v?.ano_modelo ?? v?.ano);
              return {
                placa: aplicarMascaraPlaca(normalizarPlaca(v?.placa || '')),
                marcaModelo: String(v?.marcaModelo ?? v?.marca_modelo ?? '').trim(),
                cor: String(v?.cor ?? '').trim(),
                anoModelo: Number.isNaN(anoModeloNumerico) ? undefined : anoModeloNumerico,
                nomeProprietario: String(v?.nomeProprietario ?? v?.nome_proprietario ?? '').trim(),
                cnpj: String(v?.cnpj ?? '').replace(/\D/g, ''),
              };
            })
          : [];
        // Coment√°rio: mant√©m a edi√ß√£o limpa at√© o usu√°rio alterar a se√ß√£o.
        veiculosEditados = false;
        renderizarSocios();
        renderizarEnderecosEmpresa();
        renderizarVeiculosEmpresa();
      };

      const editarEmpresa = (e) => {
        empresaEmEdicao = e.id;
        atualizarRotuloSubmit();
        preencherFormularioComEmpresa(e);
        window.scrollTo({ top: 0, behavior: 'smooth' });
        // Removido banner informativo de edi√ß√£o
      };

      const excluirEmpresa = async (e) => {
        if (!confirm(`Excluir empresa "${e.razaoSocial || e.nomeFantasia || e.cnpj}"?`)) return;
        try {
          const resp = await fetchAutenticado(`${API_EMPRESAS}/${e.id}`, { method: 'DELETE' });
          if (!resp.ok) {
            const data = await resp.json().catch(()=>({}));
            const msg = data?.mensagem || data?.message || 'N√£o foi poss√≠vel excluir.';
            throw new Error(msg);
          }
          alert('Empresa exclu√≠da com sucesso!');
          if (empresaEmEdicao === e.id) {
            empresaEmEdicao = null;
            atualizarRotuloSubmit();
            empresaForm.reset();
            socios = [];
            renderizarSocios();
            // Coment√°rio: limpa o estado dos ve√≠culos na exclus√£o.
            veiculosEmpresa = [];
            veiculosEditados = false;
            renderizarVeiculosEmpresa();
          }
          listarEmpresas();
        } catch (err) {
          exibirMensagem(err?.message || 'Erro ao excluir empresa.', 'error');
        }
      };
      const inicializar = () => {
        atualizarRotuloSubmit();
        document.getElementById('empresa-cnpj')?.addEventListener('input', e=>{ e.target.value=aplicarMascaraCnpj(e.target.value); });
        document.getElementById('empresa-telefone')?.addEventListener('input', e=>{ e.target.value=aplicarMascaraTelefone(e.target.value); });
        document.getElementById('adicionar-socio')?.addEventListener('click', adicionarSocio);
        document.getElementById('adicionar-endereco-empresa')?.addEventListener('click', adicionarEnderecoEmpresa);
        document.getElementById('adicionar-veiculo-empresa')?.addEventListener('click', adicionarVeiculoEmpresa);
        empresaForm.addEventListener('submit', salvarEmpresa);
        listarBtn?.addEventListener('click', listarEmpresas);
        campoConsulta?.addEventListener('input', (e) => { termoBusca = e.target.value || ''; filtrarEmpresas(termoBusca); });
        renderizarSocios();
        renderizarEnderecosEmpresa();
        renderizarVeiculosEmpresa();
        listarEmpresas();
      };
      document.addEventListener('DOMContentLoaded', inicializar);

      // ---------- Endere√ßos din√¢micos (reuso da l√≥gica de ve√≠culos) ----------
      const createEstadosSelect = () => {
        return `<option value="">Selecione</option>
                    <option value="AC">Acre (AC)</option>
                    <option value="AL">Alagoas (AL)</option>
                    <option value="AP">Amap√° (AP)</option>
                    <option value="AM">Amazonas (AM)</option>
                    <option value="BA">Bahia (BA)</option>
                    <option value="CE">Cear√° (CE)</option>
                    <option value="DF">Distrito Federal (DF)</option>
                    <option value="ES">Esp√≠rito Santo (ES)</option>
                    <option value="GO">Goi√°s (GO)</option>
                    <option value="MA">Maranh√£o (MA)</option>
                    <option value="MT">Mato Grosso (MT)</option>
                    <option value="MS">Mato Grosso do Sul (MS)</option>
                    <option value="MG">Minas Gerais (MG)</option>
                    <option value="PA">Par√° (PA)</option>
                    <option value="PB">Para√≠ba (PB)</option>
                    <option value="PR">Paran√° (PR)</option>
                    <option value="PE">Pernambuco (PE)</option>
                    <option value="PI">Piau√≠ (PI)</option>
                    <option value="RJ">Rio de Janeiro (RJ)</option>
                    <option value="RN">Rio Grande do Norte (RN)</option>
                    <option value="RS">Rio Grande do Sul (RS)</option>
                    <option value="RO">Rond√¥nia (RO)</option>
                    <option value="RR">Roraima (RR)</option>
                    <option value="SC">Santa Catarina (SC)</option>
                    <option value="SP">S√£o Paulo (SP)</option>
                    <option value="SE">Sergipe (SE)</option>
                    <option value="TO">Tocantins (TO)</option>`;
      };

      const renderizarEnderecosEmpresa = () => {
        const lista = document.getElementById('lista-enderecos-empresa');
        if (!lista) return;
        lista.innerHTML = '';
        if (!enderecosEmpresa.length) {
          lista.innerHTML = '';
          return;
        }
        enderecosEmpresa.forEach((endereco, idx) => {
          const div = document.createElement('div');
          div.style.cssText = 'border: 1px solid var(--border); border-radius: 0.5rem; padding: 1rem;';
          const grid = document.createElement('div');
          grid.className = 'form__grid form__grid--4';
          grid.innerHTML = `
            <label class="form__field">
              <span class="form__label">UF</span>
              <select class="form__input endereco-uf" data-index="${idx}">${createEstadosSelect()}</select>
            </label>
            <label class="form__field form__field--wide">
              <span class="form__label">Logradouro/Nome</span>
              <input class="form__input endereco-logradouro" type="text" data-index="${idx}" />
            </label>
            <label class="form__field">
              <span class="form__label">Bairro/Cidade</span>
              <input class="form__input endereco-bairro" type="text" data-index="${idx}" />
            </label>
            <label class="form__field">
              <span class="form__label">CEP</span>
              <input class="form__input endereco-cep" type="text" inputmode="numeric" data-index="${idx}" />
            </label>
            <label class="form__field">
              <span class="form__label">Complemento</span>
              <input class="form__input endereco-complemento" type="text" data-index="${idx}" />
            </label>
            <label class="form__field form__field--wide">
              <span class="form__label">Lat/Long</span>
              <input class="form__input endereco-latlong" type="text" data-index="${idx}" placeholder="-23.5, -46.6" />
            </label>`;
          div.appendChild(grid);

          grid.querySelector('.endereco-uf').value = endereco.uf || '';
          grid.querySelector('.endereco-logradouro').value = endereco.logradouro || '';
          grid.querySelector('.endereco-bairro').value = endereco.bairro || '';
          grid.querySelector('.endereco-cep').value = aplicarMascaraCep(endereco.cep || '');
          grid.querySelector('.endereco-complemento').value = endereco.complemento || '';
          grid.querySelector('.endereco-latlong').value = endereco.latLong || '';

          grid.querySelector('.endereco-uf').addEventListener('change', (e) => { enderecosEmpresa[idx].uf = e.target.value; });
          grid.querySelector('.endereco-logradouro').addEventListener('input', (e) => { enderecosEmpresa[idx].logradouro = e.target.value; });
          grid.querySelector('.endereco-bairro').addEventListener('input', (e) => { enderecosEmpresa[idx].bairro = e.target.value; });
          grid.querySelector('.endereco-cep').addEventListener('input', (e) => { e.target.value = aplicarMascaraCep(e.target.value); enderecosEmpresa[idx].cep = e.target.value; });
          grid.querySelector('.endereco-complemento').addEventListener('input', (e) => { enderecosEmpresa[idx].complemento = e.target.value; });
          grid.querySelector('.endereco-latlong').addEventListener('input', (e) => { enderecosEmpresa[idx].latLong = e.target.value; });

          const statusDiv = document.createElement('div');
          statusDiv.className = `cep-status-empresa-${idx}`;
          statusDiv.style.cssText = 'margin-top: 0.5rem; font-size: 0.85rem; display:none;';
          div.appendChild(statusDiv);

          grid.querySelector('.endereco-cep').addEventListener('blur', (e) => {
            const v = String(e.target.value||'').replace(/\D/g,'');
            if (v.length === 8) {
              mostrarCarregamentoCepEmpresa(idx, true);
              buscarEnderecoPorCepEmpresa(v, idx);
            }
          });

          const actions = document.createElement('div');
          actions.className = 'form__actions';
          const removerBtn = document.createElement('button');
          removerBtn.type = 'button';
          removerBtn.className = 'button button--danger';
          removerBtn.textContent = 'Remover';
          removerBtn.addEventListener('click', () => { enderecosEmpresa.splice(idx,1); renderizarEnderecosEmpresa(); });
          actions.appendChild(removerBtn);
          div.appendChild(actions);

          lista.appendChild(div);
        });
      };

      const adicionarEnderecoEmpresa = () => { enderecosEmpresa.push({ uf:'', logradouro:'', bairro:'', cep:'', complemento:'', latLong:'' }); renderizarEnderecosEmpresa(); };

      const buscarEnderecoPorCepEmpresa = async (cepNumeros, idx) => {
        try {
          const response = await fetch(`https://viacep.com.br/ws/${cepNumeros}/json/`);
          const data = await response.json();
          if (data.erro) {
            exibirStatusCepEmpresa(idx, 'CEP n√£o encontrado', 'error');
          } else {
            enderecosEmpresa[idx].uf = data.uf || '';
            enderecosEmpresa[idx].logradouro = data.logradouro || '';
            enderecosEmpresa[idx].bairro = `${data.bairro || ''} ${data.localidade || ''}`.trim();
            enderecosEmpresa[idx].cep = cepNumeros;
            renderizarEnderecosEmpresa();
            exibirStatusCepEmpresa(idx, 'Endere√ßo carregado com sucesso', 'success');
          }
        } catch (error) {
          exibirStatusCepEmpresa(idx, 'Erro ao buscar CEP', 'error');
        } finally {
          mostrarCarregamentoCepEmpresa(idx, false);
        }
      };

      const mostrarCarregamentoCepEmpresa = (idx, mostrando) => {
        const el = document.querySelector(`.cep-status-empresa-${idx}`);
        if (!el) return;
        if (mostrando) {
          el.innerHTML = `<div style="display:flex; align-items:center; gap:0.5rem; color: var(--primary);"><div class="spinner" style="width: 16px; height: 16px; border: 2px solid var(--primary); border-top: 2px solid transparent; border-radius: 50%; animation: spin 0.6s linear infinite;"></div><span>Carregando endere√ßo...</span></div>`;
          el.style.display = 'block';
        } else {
          el.style.display = 'none';
        }
      };

      const exibirStatusCepEmpresa = (idx, mensagem, tipo) => {
        const el = document.querySelector(`.cep-status-empresa-${idx}`);
        if (!el) return;
        const cores = { success: 'var(--success-text)', error: 'var(--error-text)' };
        el.innerHTML = `<div style="display:flex; align-items:center; gap:0.5rem; color:${cores[tipo]||'var(--text)'};"><span>${tipo==='success'?'‚úì':'‚úï'}</span><span>${mensagem}</span></div>`;
        el.style.display = 'block';
        setTimeout(() => { if (el.style.display !== 'none') el.style.display = 'none'; }, 3000);
      };

      // ---------- Ve√≠culos da empresa (espelhado do cadastro de pessoas) ----------
      const normalizarPlaca = (valor) => String(valor || '').toUpperCase().replace(/[^A-Z0-9]/g, '').slice(0, 7);
      const aplicarMascaraPlaca = (valor) => {
        const placa = normalizarPlaca(valor);
        if (placa.length <= 3) return placa;
        return `${placa.slice(0, 3)}-${placa.slice(3)}`;
      };
      const obterNomeProprietarioEmpresa = () => {
        const razao = String(empresaForm?.razaoSocial?.value || '').trim();
        return razao || '';
      };
      const obterCnpjEmpresa = () => String(empresaForm?.cnpj?.value || '').replace(/\D/g, '');
      const sincronizarVeiculosEmpresa = () => {
        if (!veiculosEmpresa.length) return;
        const nomeAtual = obterNomeProprietarioEmpresa();
        const cnpjAtual = obterCnpjEmpresa();
        veiculosEmpresa = veiculosEmpresa.map((v) => ({
          ...v,
          nomeProprietario: nomeAtual || v.nomeProprietario || '',
          cnpj: cnpjAtual || v.cnpj || '',
        }));
      };
      const configurarListenersVeiculosEmpresa = () => {
        if (listenersVeiculosEmpresaConfigurados) return;
        const atualizarDados = () => {
          sincronizarVeiculosEmpresa();
          if (veiculosEmpresa.length) {
            // Coment√°rio: marca edi√ß√£o para garantir envio quando Raz√£o Social/CNPJ mudarem com ve√≠culos carregados.
            veiculosEditados = true;
          }
        };
        empresaForm?.razaoSocial?.addEventListener('input', atualizarDados);
        empresaForm?.cnpj?.addEventListener('input', atualizarDados);
        listenersVeiculosEmpresaConfigurados = true;
      };

      const renderizarVeiculosEmpresa = () => {
        configurarListenersVeiculosEmpresa();
        sincronizarVeiculosEmpresa();
        const listaEl = document.getElementById('lista-veiculos-empresa');
        if (!listaEl) return;
        listaEl.innerHTML = '';
        if (!veiculosEmpresa.length) {
          return;
        }
        veiculosEmpresa.forEach((veiculo, indice) => {
          const wrapper = document.createElement('div');
          wrapper.className = 'panel';
          wrapper.style.padding = '0.75rem';
          wrapper.style.display = 'flex';
          wrapper.style.flexDirection = 'column';
          wrapper.style.gap = '0.5rem';

          const titulo = document.createElement('div');
          titulo.style.display = 'flex';
          titulo.style.justifyContent = 'space-between';
          titulo.style.alignItems = 'center';
          titulo.innerHTML = `<strong style="font-size: 0.95rem;">Ve√≠culo ${indice + 1}</strong>`;
          const btnRemover = document.createElement('button');
          btnRemover.type = 'button';
          btnRemover.className = 'button button--danger';
          btnRemover.textContent = 'Remover';
          btnRemover.style.minWidth = 'fit-content';
          btnRemover.addEventListener('click', () => {
            veiculosEmpresa.splice(indice, 1);
            veiculosEditados = true;
            renderizarVeiculosEmpresa();
          });
          titulo.appendChild(btnRemover);
          wrapper.appendChild(titulo);

          const gridPrincipal = document.createElement('div');
          gridPrincipal.className = 'form__grid form__grid--3';

          const campoPlaca = document.createElement('label');
          campoPlaca.className = 'form__field';
          campoPlaca.innerHTML = `<span class="form__label">Placa</span>`;
          const inputPlaca = document.createElement('input');
          inputPlaca.className = 'form__input';
          inputPlaca.type = 'text';
          inputPlaca.maxLength = 8;
          inputPlaca.placeholder = 'ABC1D23';
          inputPlaca.value = veiculo.placa || '';
          inputPlaca.addEventListener('input', (e) => {
            veiculosEmpresa[indice].placa = e.target.value;
            veiculosEditados = true;
          });
          campoPlaca.appendChild(inputPlaca);
          gridPrincipal.appendChild(campoPlaca);

          const campoMarca = document.createElement('label');
          campoMarca.className = 'form__field';
          campoMarca.innerHTML = `<span class="form__label">Marca/Modelo</span>`;
          const inputMarca = document.createElement('input');
          inputMarca.className = 'form__input';
          inputMarca.type = 'text';
          inputMarca.value = veiculo.marcaModelo || '';
          inputMarca.addEventListener('input', (e) => {
            veiculosEmpresa[indice].marcaModelo = e.target.value;
            veiculosEditados = true;
          });
          campoMarca.appendChild(inputMarca);
          gridPrincipal.appendChild(campoMarca);

          const campoCor = document.createElement('label');
          campoCor.className = 'form__field';
          campoCor.innerHTML = `<span class="form__label">Cor</span>`;
          const inputCor = document.createElement('input');
          inputCor.className = 'form__input';
          inputCor.type = 'text';
          inputCor.value = veiculo.cor || '';
          inputCor.addEventListener('input', (e) => {
            veiculosEmpresa[indice].cor = e.target.value;
            veiculosEditados = true;
          });
          campoCor.appendChild(inputCor);
          gridPrincipal.appendChild(campoCor);
          wrapper.appendChild(gridPrincipal);

          const gridSecundario = document.createElement('div');
          gridSecundario.className = 'form__grid form__grid--3';
          const campoAno = document.createElement('label');
          campoAno.className = 'form__field';
          campoAno.innerHTML = `<span class="form__label">Ano/Modelo</span>`;
          const inputAno = document.createElement('input');
          inputAno.className = 'form__input';
          inputAno.type = 'number';
          inputAno.min = 1900;
          inputAno.max = 2100;
          inputAno.placeholder = '2024';
          inputAno.value = veiculo.anoModelo ?? '';
          inputAno.addEventListener('input', (e) => {
            const valor = e.target.value ? Number(e.target.value) : '';
            veiculosEmpresa[indice].anoModelo = (valor === '' || Number.isNaN(valor)) ? undefined : valor;
            veiculosEditados = true;
          });
          campoAno.appendChild(inputAno);
          gridSecundario.appendChild(campoAno);

          // Campos ocultos para sincronizar propriet√°rio e CNPJ automaticamente
          const inputNomeProprietario = document.createElement('input');
          inputNomeProprietario.type = 'hidden';
          inputNomeProprietario.dataset.veiculoNomeProprietario = 'true';
          inputNomeProprietario.value = veiculo.nomeProprietario || empresaForm?.razaoSocial?.value || '';
          const inputCnpjProprietario = document.createElement('input');
          inputCnpjProprietario.type = 'hidden';
          inputCnpjProprietario.dataset.veiculoCnpj = 'true';
          inputCnpjProprietario.value = veiculo.cnpj || (document.getElementById('empresa-cnpj')?.value || '');

          gridSecundario.appendChild(inputNomeProprietario);
          gridSecundario.appendChild(inputCnpjProprietario);

          wrapper.appendChild(gridSecundario);
          listaEl.appendChild(wrapper);
        });
      };

      const adicionarVeiculoEmpresa = () => {
        veiculosEmpresa.push({});
        veiculosEditados = true;
        renderizarVeiculosEmpresa();
      };
    </script>
    <div id="alterar-senha-modal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="alterar-senha-title">
      <div class="modal__overlay" data-modal-close></div>
      <div class="modal__panel modal__panel--sm" role="document">
        <button class="modal__close" id="alterar-senha-close" aria-label="Fechar">√ó</button>
        <h3 id="alterar-senha-title">Alterar senha</h3>
        <form id="alterar-senha-form" class="form" novalidate>
          <label class="form__field">
            <span class="form__label">Senha atual</span>
            <input class="form__input" type="password" id="senha-atual" required />
          </label>
          <label class="form__field">
            <span class="form__label">Nova senha</span>
            <input class="form__input" type="password" id="senha-nova" required />
          </label>
          <div class="form__actions">
            <button type="button" class="button button--ghost" id="alterar-senha-cancelar">Cancelar</button>
            <button type="submit" class="button button--primary" id="alterar-senha-submit">Alterar</button>
          </div>
        </form>
      </div>
    </div>
  </body>
</html>
