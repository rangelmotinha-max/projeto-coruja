<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cadastro de Empresas | Projeto Coruja</title>
    <link rel="stylesheet" href="/css/main.css" />
  </head>
  <body class="theme-dark">
    <div class="app">
      <div class="user-menu" id="user-menu" aria-expanded="false">
        <button class="user-menu__button" type="button" id="user-menu-button" aria-haspopup="true" aria-expanded="false">
          <span class="user-menu__avatar" id="user-avatar" aria-hidden="true">U</span>
          <span id="user-button-name">Usu√°rio</span>
        </button>
        <div class="user-menu__dropdown" id="user-menu-dropdown" role="menu" aria-label="Menu do usu√°rio">
          <div class="user-menu__item"><span class="user-menu__label">Nome Completo:</span><span class="user-menu__value" id="um-nome">‚Äî</span></div>
          <div class="user-menu__item"><span class="user-menu__label">Email:</span><span class="user-menu__value" id="um-email">‚Äî</span></div>
          <div class="user-menu__item"><span class="user-menu__label">Perfil:</span><span class="user-menu__value" id="um-perfil">‚Äî</span></div>
          <div class="user-menu__separator"></div>
          <div class="user-menu__item"><span class="user-menu__label">Senha:</span><span class="user-menu__link" id="um-alterar-senha">Alterar senha</span></div>
          <div class="user-menu__separator"></div>
          <div class="user-menu__item"><span class="user-menu__link" id="um-sair">Sair</span></div>
        </div>
      </div>
      <!-- Sidebar principal -->
      <aside class="sidebar">
        <div class="sidebar__header">
          <div class="sidebar__brand">Projeto Coruja</div>
          <!-- Bot√£o dedicado para alternar entre tema claro e escuro -->
          <button
            class="theme-toggle"
            type="button"
            data-theme-toggle
            aria-pressed="false"
            aria-label="Alternar tema visual"
          >
            <span class="theme-toggle__icon" aria-hidden="true" data-theme-icon>üåô</span>
            <span class="theme-toggle__label" data-theme-label>Modo escuro</span>
          </button>
        </div>
        <nav class="sidebar__nav" aria-label="Menu principal">
          <a class="sidebar__link" href="/home">Home</a>
          <a class="sidebar__link" href="/usuarios">Usu√°rios</a>
          <!-- In√≠cio do menu de n√≠vel superior: Cadastro -->
          <details class="sidebar__section sidebar__section--active" open>
            <summary class="sidebar__link sidebar__link--parent" aria-label="Abrir menu Cadastro">Cadastro</summary>
            <div class="sidebar__subnav">
              <a class="sidebar__link sidebar__link--child" href="/cadastro/pessoas">Pessoas</a>
              <a class="sidebar__link sidebar__link--child sidebar__link--active" href="/cadastro/empresas">Empresas</a>
            </div>
          </details>
          <!-- In√≠cio do menu de n√≠vel superior: Consulta -->
          <details class="sidebar__section">
            <summary class="sidebar__link sidebar__link--parent" aria-label="Abrir menu Consulta">Consulta</summary>
            <div class="sidebar__subnav">
              <a class="sidebar__link sidebar__link--child" href="/consulta/pessoas">Pessoas</a>
              <a class="sidebar__link sidebar__link--child" href="/consulta/empresas">Empresas</a>
            </div>
          </details>
          <!-- Fim do menu de n√≠vel superior: Cadastro -->
        </nav>
        
      </aside>

      <!-- Conte√∫do principal da p√°gina -->
      <main class="content" data-page="cadastro-empresas">
        <header class="content__header">
          <p class="content__eyebrow">Cadastro</p>
          <h1 class="content__title">Empresas</h1>
          <p class="content__subtitle">Cadastre e gerencie empresas e seus s√≥cios.</p>
        </header>

        <section class="panel" aria-label="Formul√°rio de empresas">
          <div class="panel__header panel__header--stacked"></div>
          <div id="empresa-form-message" class="message" role="status" aria-live="polite"></div>
          <form class="form" id="empresa-form" action="#" method="post">
            <div class="form__grid form__grid--3">
              <label class="form__field">
                <span class="form__label">CNPJ</span>
                <input id="empresa-cnpj" name="cnpj" type="text" class="form__input" inputmode="numeric" placeholder="00.000.000/0000-00" />
              </label>
              <label class="form__field">
                <span class="form__label">Raz√£o Social</span>
                <input name="razaoSocial" type="text" class="form__input" />
              </label>
              <label class="form__field">
                <span class="form__label">Nome Fantasia</span>
                <input name="nomeFantasia" type="text" class="form__input" />
              </label>
            </div>

            <div class="form__grid form__grid--3">
              <label class="form__field">
                <span class="form__label">Natureza Jur√≠dica</span>
                <input name="naturezaJuridica" type="text" class="form__input" />
              </label>
              <label class="form__field">
                <span class="form__label">In√≠cio da Atividade</span>
                <input name="dataInicioAtividade" type="date" class="form__input" />
              </label>
              <label class="form__field">
                <span class="form__label">Situa√ß√£o Cadastral</span>
                <select name="situacaoCadastral" class="form__input">
                  <option value="">Selecione</option>
                  <option value="Ativo">Ativo</option>
                  <option value="Inativo">Inativo</option>
                  <option value="Inapta">Inapta</option>
                </select>
              </label>
            </div>

            <div class="form__grid form__grid--3">
              <label class="form__field">
                <span class="form__label">Endere√ßo</span>
                <input name="endereco" type="text" class="form__input" />
              </label>
              <label class="form__field">
                <span class="form__label">CEP</span>
                <input id="empresa-cep" name="cep" type="text" class="form__input" inputmode="numeric" placeholder="00000-000" />
              </label>
              <label class="form__field">
                <span class="form__label">Telefone</span>
                <input id="empresa-telefone" name="telefone" type="tel" class="form__input" inputmode="tel" placeholder="(XX) XXXXX-XXXX" />
              </label>
            </div>

            <div class="form__section">
              <div class="form__section-header">
                <h3 class="form__section-title">S√≥cios</h3>
                <button class="button" type="button" id="adicionar-socio">Adicionar s√≥cio</button>
              </div>
              <div id="lista-socios" class="form__section-body"></div>
            </div>

            <div class="form__actions">
              <button class="button button--primary" id="submit-empresa" type="submit">Incluir</button>
              <button class="button" id="listar-empresas" type="button">Listar</button>
              <button class="button button--ghost" type="reset">Limpar</button>
            </div>
          </form>
        </section>

        <section class="panel" aria-label="Listagem de empresas">
          <div class="panel__header panel__header--stacked">
            <h3 class="panel__title">Empresas cadastradas</h3>
            <div class="panel__actions page-actions">
              <input
                type="text"
                id="campo-consulta"
                class="search-input"
                placeholder="Consultar em todos os campos da empresa e s√≥cios..."
                aria-label="Campo de busca de empresas"
              />
            </div>
          </div>
          <div id="empresas-message" class="message" role="status" aria-live="polite"></div>
          <div class="panel__body">
            <div id="empresas-lista" class="list" style="display:block;"></div>
          </div>
        </section>
      </main>
    </div>

    <script src="/js/main.js"></script>
    <script>
      const API_EMPRESAS = '/api/empresas';
      const empresaForm = document.getElementById('empresa-form');
      const formMsgEl = document.getElementById('empresa-form-message');
      const msgEl = document.getElementById('empresas-message');
      const listaEl = document.getElementById('empresas-lista');
      const submitBtn = document.getElementById('submit-empresa');
      const listarBtn = document.getElementById('listar-empresas');
      const campoConsulta = document.getElementById('campo-consulta');
      let todasEmpresas = [];
      let empresasFiltradas = [];
      let termoBusca = '';
      let socios = [];
      let empresaEmEdicao = null;

      // Helpers de autentica√ß√£o (locais desta p√°gina)
      const getCookie = (name) => document.cookie.split(';').map(c=>c.trim()).find(c=>c.startsWith(`${name}=`))?.split('=')[1];
      const obterToken = () => localStorage.getItem('authToken') || getCookie('authToken');
      const fetchAutenticado = (url, options = {}) => {
        const token = obterToken();
        const headers = { 'Content-Type': 'application/json', ...(options.headers||{}), ...(token ? { Authorization: `Bearer ${token}` } : {}) };
        return fetch(url, { ...options, headers });
      };

      const exibirMensagem = (texto, tipo = 'info') => { if(!msgEl) return; msgEl.textContent = texto||''; msgEl.className='message'; if (texto) msgEl.classList.add(`message--${tipo}`); };
      const exibirMensagemForm = (texto, tipo='info') => { formMsgEl.textContent = texto||''; formMsgEl.className='message'; if (texto) formMsgEl.classList.add(`message--${tipo}`); };
      const aplicarMascaraCnpj = (v) => { const d=String(v||'').replace(/\D/g,'').slice(0,14); let r=d; if(d.length>2) r=d.slice(0,2)+'.'+d.slice(2); if(d.length>5) r=r.slice(0,6)+'.'+d.slice(5); if(d.length>8) r=r.slice(0,10)+'/'+d.slice(8); if(d.length>12) r=r.slice(0,15)+'-'+d.slice(12); return r; };
      const aplicarMascaraTelefone = (valor) => { const dig=String(valor||'').replace(/\D/g,'').slice(0,11); if(dig.length<=10){ return dig.replace(/(\d{0,2})(\d{0,4})(\d{0,4}).*/, (_,a,b,c)=>{ let r=''; if(a) r+='('+a+') '; if(b) r+=b+(c?'-':''); if(c) r+=c; return r; }); } else { return dig.replace(/(\d{0,2})(\d{0,5})(\d{0,4}).*/, (_,a,b,c)=>{ let r=''; if(a) r+='('+a+') '; if(b) r+=b+(c?'-':''); if(c) r+=c; return r; }); } };
      const aplicarMascaraCep = (valor) => { const dig=String(valor||'').replace(/\D/g,'').slice(0,8); return dig.length<=5?dig:dig.slice(0,5)+'-'+dig.slice(5); };
      const renderizarSocios = () => { const lista=document.getElementById('lista-socios'); lista.innerHTML=''; if(!socios.length){ lista.innerHTML='<p style="color: var(--muted); font-size: 0.85rem; margin: 0;">Nenhum s√≥cio adicionado. Clique para adicionar.</p>'; return; } socios.forEach((s,i)=>{ const linha=document.createElement('div'); linha.style.cssText='display:flex; gap:0.5rem; align-items:center;'; linha.innerHTML=`<label class="form__field" style="flex:1"><span class="form__label">Nome</span><input type="text" class="form__input socio-nome" /></label><label class="form__field" style="max-width:16rem"><span class="form__label">CPF</span><input type="text" class="form__input socio-cpf" inputmode="numeric" /></label><button class="button button--danger" type="button" title="Excluir" aria-label="Remover s√≥cio">‚àí</button>`; const nomeEl=linha.querySelector('.socio-nome'); const cpfEl=linha.querySelector('.socio-cpf'); const btn=linha.querySelector('button'); nomeEl.value=s.nome||''; cpfEl.value=s.cpf||''; nomeEl.addEventListener('input', e=>{ socios[i].nome=e.target.value; }); cpfEl.addEventListener('input', e=>{ socios[i].cpf=e.target.value; }); btn.addEventListener('click', ()=>{ socios.splice(i,1); renderizarSocios(); }); lista.appendChild(linha); }); };
      const adicionarSocio = () => { socios.push({ nome:'', cpf:'' }); renderizarSocios(); };
      const obterDadosFormulario = () => { const fd=new FormData(empresaForm); const dados=Object.fromEntries(fd.entries()); dados.cnpj=aplicarMascaraCnpj(dados.cnpj).replace(/\D/g,''); dados.cep=aplicarMascaraCep(dados.cep).replace(/\D/g,''); dados.telefone=aplicarMascaraTelefone(dados.telefone); dados.socios=socios.map(s=>({ nome:String(s.nome||'').trim(), cpf:String(s.cpf||'').replace(/\D/g,'') })).filter(s=>s.nome||s.cpf); return dados; };
      const atualizarRotuloSubmit = () => { submitBtn.textContent = empresaEmEdicao ? 'Salvar' : 'Incluir'; };
      const salvarEmpresa = async (e) => {
        e.preventDefault();
        const payload = obterDadosFormulario();
        try {
          exibirMensagemForm('Salvando empresa...', 'info');
          const metodo = empresaEmEdicao ? 'PUT' : 'POST';
          const url = empresaEmEdicao ? `${API_EMPRESAS}/${empresaEmEdicao}` : API_EMPRESAS;
          const resp = await fetchAutenticado(url, { method: metodo, body: JSON.stringify(payload) });
          const data = await resp.json().catch(() => ({}));
          if (!resp.ok) {
            const msg = data?.mensagem || data?.message || 'N√£o foi poss√≠vel salvar a empresa.';
            throw new Error(msg);
          }
          exibirMensagemForm('Empresa salva com sucesso!', 'success');
          empresaForm.reset();
          socios = [];
          renderizarSocios();
          empresaEmEdicao = null;
          atualizarRotuloSubmit();
          listarEmpresas();
        } catch (err) {
          exibirMensagemForm(err?.message || 'Erro ao salvar empresa.', 'error');
        }
      };
      const renderizarEmpresas = (lista) => {
        listaEl.innerHTML = '';
        if (!Array.isArray(lista) || !lista.length) {
          const table = document.createElement('table');
          const tbody = document.createElement('tbody');
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          td.colSpan = 5;
          td.textContent = 'Nenhuma empresa encontrada.';
          tr.appendChild(td);
          tbody.appendChild(tr);
          table.appendChild(tbody);
          listaEl.appendChild(table);
          return;
        }

        const table = document.createElement('table');
        table.style.width = '100%';
        table.style.borderCollapse = 'collapse';

        const thead = document.createElement('thead');
        const headRow = document.createElement('tr');
        const ths = ['CNPJ', 'Raz√£o Social', 'Nome Fantasia', 'Situa√ß√£o Cadastral', 'A√ß√µes'];
        ths.forEach(t => {
          const th = document.createElement('th');
          th.textContent = t;
          th.style.textAlign = 'left';
          th.style.padding = '0.5rem';
          headRow.appendChild(th);
        });
        thead.appendChild(headRow);
        table.appendChild(thead);

        const tbody = document.createElement('tbody');
        for (const e of lista) {
          const tr = document.createElement('tr');

          const tdCnpj = document.createElement('td');
          tdCnpj.textContent = aplicarMascaraCnpj(e.cnpj || '') || '‚Äî';
          tdCnpj.style.padding = '0.5rem';

          const tdRazao = document.createElement('td');
          tdRazao.textContent = e.razaoSocial || '‚Äî';
          tdRazao.style.padding = '0.5rem';

          const tdFantasia = document.createElement('td');
          tdFantasia.textContent = e.nomeFantasia || '‚Äî';
          tdFantasia.style.padding = '0.5rem';

          const tdSituacao = document.createElement('td');
          tdSituacao.textContent = e.situacaoCadastral || '‚Äî';
          tdSituacao.style.padding = '0.5rem';

          const tdAcoes = document.createElement('td');
          tdAcoes.style.padding = '0.5rem';
          const actions = document.createElement('div');
          actions.style.display = 'flex';
          actions.style.gap = '0.5rem';
          const btnEditar = document.createElement('button');
          btnEditar.className = 'button';
          btnEditar.type = 'button';
          btnEditar.textContent = 'Editar';
          const btnExcluir = document.createElement('button');
          btnExcluir.className = 'button button--danger';
          btnExcluir.type = 'button';
          btnExcluir.textContent = 'Excluir';
          btnEditar.addEventListener('click', () => editarEmpresa(e));
          btnExcluir.addEventListener('click', () => excluirEmpresa(e));
          actions.appendChild(btnEditar);
          actions.appendChild(btnExcluir);
          tdAcoes.appendChild(actions);

          tr.appendChild(tdCnpj);
          tr.appendChild(tdRazao);
          tr.appendChild(tdFantasia);
          tr.appendChild(tdSituacao);
          tr.appendChild(tdAcoes);

          tbody.appendChild(tr);
        }
        table.appendChild(tbody);
        listaEl.appendChild(table);
      };

      const filtrarEmpresas = (termo) => {
        const q = String(termo || '').toLowerCase().trim();
        const onlyDigits = (s) => String(s || '').replace(/\D+/g, '');
        const norm = (s) => String(s || '').toLowerCase();
        if (!q) {
          empresasFiltradas = [...todasEmpresas];
        } else {
          const qDigits = onlyDigits(q);
          empresasFiltradas = todasEmpresas.filter((e) => {
            const razao = norm(e.razaoSocial);
            const fantasia = norm(e.nomeFantasia);
            const situacao = norm(e.situacaoCadastral);
            const natureza = norm(e.naturezaJuridica);
            const endereco = norm(e.endereco);
            const dataInicio = norm(e.dataInicioAtividade);
            const cepDigits = onlyDigits(e.cep);
            const telDigits = onlyDigits(e.telefone);
            const cnpjDigits = onlyDigits(e.cnpj);

            const textoMatch = (
              razao.includes(q) ||
              fantasia.includes(q) ||
              situacao.includes(q) ||
              natureza.includes(q) ||
              endereco.includes(q) ||
              dataInicio.includes(q)
            );

            const digitosMatch = (
              (qDigits && cnpjDigits.includes(qDigits)) ||
              (qDigits && cepDigits.includes(qDigits)) ||
              (qDigits && telDigits.includes(qDigits))
            );

            const sociosArr = Array.isArray(e.socios) ? e.socios : [];
            const sociosMatch = sociosArr.some((s) => {
              const nome = norm(s.nome);
              const cpfDigits = onlyDigits(s.cpf);
              return nome.includes(q) || (qDigits && cpfDigits.includes(qDigits));
            });

            return textoMatch || digitosMatch || sociosMatch;
          });
        }
        renderizarEmpresas(empresasFiltradas);
      };

      const listarEmpresas = async () => {
        try {
          exibirMensagem('Carregando empresas...', 'info');
          const resp = await fetchAutenticado(API_EMPRESAS);
          const data = await resp.json().catch(() => []);
          if (!resp.ok) {
            const msg = data?.mensagem || data?.message || 'N√£o foi poss√≠vel buscar as empresas.';
            throw new Error(msg);
          }
          todasEmpresas = Array.isArray(data) ? data : data?.data || [];
          if (!todasEmpresas.length) {
            exibirMensagem('Nenhuma empresa cadastrada.', 'info');
            empresasFiltradas = [];
            renderizarEmpresas(empresasFiltradas);
            return;
          }
          exibirMensagem(`Exibindo ${todasEmpresas.length} empresa(s).`, 'success');
          empresasFiltradas = [...todasEmpresas];
          filtrarEmpresas(termoBusca);
        } catch (err) {
          exibirMensagem(err?.message || 'Erro ao listar empresas.', 'error');
        }
      };

      const preencherFormularioComEmpresa = (e) => {
        empresaForm.cnpj.value = aplicarMascaraCnpj(e.cnpj || '');
        empresaForm.razaoSocial.value = e.razaoSocial || '';
        empresaForm.nomeFantasia.value = e.nomeFantasia || '';
        empresaForm.naturezaJuridica.value = e.naturezaJuridica || '';
        empresaForm.dataInicioAtividade.value = e.dataInicioAtividade || '';
        empresaForm.situacaoCadastral.value = e.situacaoCadastral || '';
        empresaForm.endereco.value = e.endereco || '';
        empresaForm.cep.value = aplicarMascaraCep(e.cep || '');
        empresaForm.telefone.value = aplicarMascaraTelefone(e.telefone || '');
        socios = Array.isArray(e.socios) ? e.socios.map(s=>({ nome: s.nome||'', cpf: s.cpf||'' })) : [];
        renderizarSocios();
      };

      const editarEmpresa = (e) => {
        empresaEmEdicao = e.id;
        atualizarRotuloSubmit();
        preencherFormularioComEmpresa(e);
        window.scrollTo({ top: 0, behavior: 'smooth' });
        exibirMensagemForm('Editando empresa selecionada.', 'info');
      };

      const excluirEmpresa = async (e) => {
        if (!confirm(`Excluir empresa "${e.razaoSocial || e.nomeFantasia || e.cnpj}"?`)) return;
        try {
          const resp = await fetchAutenticado(`${API_EMPRESAS}/${e.id}`, { method: 'DELETE' });
          if (!resp.ok) {
            const data = await resp.json().catch(()=>({}));
            const msg = data?.mensagem || data?.message || 'N√£o foi poss√≠vel excluir.';
            throw new Error(msg);
          }
          exibirMensagem('Empresa exclu√≠da com sucesso.', 'success');
          if (empresaEmEdicao === e.id) { empresaEmEdicao = null; atualizarRotuloSubmit(); empresaForm.reset(); socios = []; renderizarSocios(); }
          listarEmpresas();
        } catch (err) {
          exibirMensagem(err?.message || 'Erro ao excluir empresa.', 'error');
        }
      };
      const inicializar = () => {
        atualizarRotuloSubmit();
        document.getElementById('empresa-cnpj')?.addEventListener('input', e=>{ e.target.value=aplicarMascaraCnpj(e.target.value); });
        document.getElementById('empresa-cep')?.addEventListener('input', e=>{ e.target.value=aplicarMascaraCep(e.target.value); });
        document.getElementById('empresa-telefone')?.addEventListener('input', e=>{ e.target.value=aplicarMascaraTelefone(e.target.value); });
        document.getElementById('adicionar-socio')?.addEventListener('click', adicionarSocio);
        empresaForm.addEventListener('submit', salvarEmpresa);
        listarBtn?.addEventListener('click', listarEmpresas);
        campoConsulta?.addEventListener('input', (e) => { termoBusca = e.target.value || ''; filtrarEmpresas(termoBusca); });
        renderizarSocios();
        listarEmpresas();
      };
      document.addEventListener('DOMContentLoaded', inicializar);
    </script>
    <div id="alterar-senha-modal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="alterar-senha-title">
      <div class="modal__overlay" data-modal-close></div>
      <div class="modal__panel modal__panel--sm" role="document">
        <button class="modal__close" id="alterar-senha-close" aria-label="Fechar">√ó</button>
        <h3 id="alterar-senha-title">Alterar senha</h3>
        <form id="alterar-senha-form" class="form" novalidate>
          <label class="form__field">
            <span class="form__label">Senha atual</span>
            <input class="form__input" type="password" id="senha-atual" required />
          </label>
          <label class="form__field">
            <span class="form__label">Nova senha</span>
            <input class="form__input" type="password" id="senha-nova" required />
          </label>
          <div class="form__actions">
            <button type="button" class="button button--ghost" id="alterar-senha-cancelar">Cancelar</button>
            <button type="submit" class="button button--primary" id="alterar-senha-submit">Alterar</button>
          </div>
        </form>
      </div>
    </div>
  </body>
</html>
